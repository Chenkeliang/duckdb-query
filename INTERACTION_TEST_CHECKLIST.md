# DataSource Panel - 交互验证测试清单

## 📋 测试目标
验证所有 6 个问题的修复是否在实际交互中正常工作。

---

## 🧪 测试场景

### ✅ 测试 1: 右键菜单功能（问题 1）

**测试步骤**:
1. 启动应用，打开 DataSource Panel
2. 找到一个数据库连接节点（如 PostgreSQL）
3. 右键点击该连接节点
4. 验证右键菜单是否弹出
5. 点击"刷新此连接"菜单项
6. 验证是否显示成功提示

**预期结果**:
- ✅ 右键菜单正常弹出
- ✅ 显示"刷新此连接"选项
- ✅ 点击后显示 toast: "已刷新连接 [连接名]"
- ✅ 该连接下的数据重新加载

**失败表现**（修复前）:
- ❌ 右键点击无反应
- ❌ 菜单不弹出

---

### ✅ 测试 2: 颜色规范（问题 2）

**测试步骤**:
1. 在 DataSource Panel 中查看不同类型的数据库连接
2. 切换到深色模式（如果支持）
3. 验证图标颜色是否清晰可见

**预期结果**:
- ✅ PostgreSQL: 蓝色系（主色调）
- ✅ MySQL: 橙色系（警告色）
- ✅ SQLite: 灰色系（次要文本色）
- ✅ SQL Server: 红色系（错误色）
- ✅ 深色模式下颜色仍然清晰可见
- ✅ 不同类型有明显区分度

**失败表现**（修复前）:
- ❌ 深色模式下颜色不协调
- ❌ 使用硬编码颜色（如 text-blue-500）

---

### ✅ 测试 3: 删除流程错误处理（问题 3）

**测试步骤 A - 删除成功**:
1. 在 DataSource Panel 中找到一个 DuckDB 表
2. 右键点击该表
3. 选择"删除表"
4. 确认删除
5. 验证提示信息

**预期结果**:
- ✅ 显示 toast: "表已删除，数据源列表已刷新"
- ✅ 表从列表中消失
- ✅ 数据源列表自动刷新

**测试步骤 B - 删除失败（模拟）**:
1. 断开网络或停止后端服务
2. 尝试删除一个表
3. 验证错误提示

**预期结果**:
- ✅ 显示 toast: "删除失败：[错误信息]"
- ✅ 表仍然在列表中
- ✅ 不触发缓存刷新

**失败表现**（修复前）:
- ❌ 删除失败仍显示"表已删除"
- ❌ 表消失但实际未删除
- ❌ 用户被误导

---

### ✅ 测试 4: 代码冗余清理（问题 4）

**测试步骤**:
1. 在搜索框中输入关键词（如 "user"）
2. 验证搜索结果
3. 验证数据库连接节点是否自动展开

**预期结果**:
- ✅ 搜索功能正常
- ✅ 匹配的表高亮显示
- ✅ 数据库连接自动展开（通过 `forceExpanded` prop）
- ✅ 清空搜索后恢复折叠状态

**代码验证**:
- ✅ `expandedConnections` 状态已移除
- ✅ `expandedSchemas` 状态已移除
- ✅ 功能通过 `forceExpanded` prop 实现

---

### ✅ 测试 5: 刷新按钮加载状态（问题 5）

**测试步骤**:
1. 打开 DataSource Panel
2. 点击底部的"刷新"按钮
3. 观察按钮状态变化

**预期结果**:
- ✅ 点击刷新按钮后，按钮变为禁用状态
- ✅ 刷新图标开始旋转（`animate-spin`）
- ✅ 数据加载完成后，按钮恢复可用状态
- ✅ 图标停止旋转

**失败表现**（修复前）:
- ❌ 按钮状态不变
- ❌ 图标不旋转
- ❌ 用户无法感知后台请求

**技术验证**:
```typescript
// 验证 useDatabaseConnections 返回 isFetching
const { connections, isLoading, isFetching } = useDatabaseConnections();

// 验证按钮使用 isFetching
<Button disabled={isFetching || isFetchingConnections}>
  <RefreshCw className={`${isFetching ? 'animate-spin' : ''}`} />
  刷新
</Button>
```

---

### ✅ 测试 6: 搜索高亮特殊字符（问题 6）

**测试步骤**:
1. 在搜索框中输入普通文本（如 "user"）
2. 验证高亮是否正常
3. 在搜索框中输入特殊字符：
   - `(`
   - `[`
   - `*`
   - `+`
   - `?`
   - `.`
   - `^`
   - `$`
   - `{`
   - `}`
   - `|`
   - `\`
4. 验证应用是否崩溃
5. 验证搜索是否仍然工作

**预期结果**:
- ✅ 输入普通文本：高亮正常
- ✅ 输入 `(`: 不崩溃，搜索包含 `(` 的表名
- ✅ 输入 `[`: 不崩溃，搜索包含 `[` 的表名
- ✅ 输入 `*`: 不崩溃，搜索包含 `*` 的表名
- ✅ 输入其他特殊字符：都不崩溃
- ✅ 高亮功能仍然正常工作

**失败表现**（修复前）:
- ❌ 输入 `(` 后应用崩溃
- ❌ 控制台报错: "Invalid regular expression"
- ❌ 搜索功能停止工作

**技术验证**:
```typescript
// 验证正则转义
const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

// 验证容错处理
try {
  const parts = text.split(new RegExp(`(${escapedQuery})`, 'gi'));
  // ...
} catch (error) {
  return text; // 失败时返回原文本
}
```

---

## 🎯 综合测试场景

### 场景 1: 完整的数据刷新流程
1. 右键点击数据库连接 → 选择"刷新此连接"
2. 验证刷新按钮显示加载状态
3. 验证成功提示
4. 验证数据更新

### 场景 2: 搜索 + 删除流程
1. 在搜索框输入关键词（包含特殊字符，如 "test(1)"）
2. 验证搜索高亮正常
3. 右键点击搜索结果中的表
4. 选择"删除表"
5. 验证删除成功提示
6. 验证表从列表消失
7. 验证搜索结果更新

### 场景 3: 深色模式切换
1. 在浅色模式下查看数据库图标颜色
2. 切换到深色模式
3. 验证图标颜色仍然清晰可见
4. 验证不同数据库类型仍有区分度

---

## 📊 测试结果记录

### 测试环境
- **浏览器**: _____________
- **操作系统**: _____________
- **测试日期**: _____________
- **测试人员**: _____________

### 测试结果

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 1. 右键菜单功能 | ⬜ 通过 / ⬜ 失败 | |
| 2. 颜色规范 | ⬜ 通过 / ⬜ 失败 | |
| 3. 删除流程（成功） | ⬜ 通过 / ⬜ 失败 | |
| 3. 删除流程（失败） | ⬜ 通过 / ⬜ 失败 | |
| 4. 搜索自动展开 | ⬜ 通过 / ⬜ 失败 | |
| 5. 刷新按钮状态 | ⬜ 通过 / ⬜ 失败 | |
| 6. 搜索特殊字符 `(` | ⬜ 通过 / ⬜ 失败 | |
| 6. 搜索特殊字符 `[` | ⬜ 通过 / ⬜ 失败 | |
| 6. 搜索特殊字符 `*` | ⬜ 通过 / ⬜ 失败 | |
| 综合场景 1 | ⬜ 通过 / ⬜ 失败 | |
| 综合场景 2 | ⬜ 通过 / ⬜ 失败 | |
| 综合场景 3 | ⬜ 通过 / ⬜ 失败 | |

---

## 🐛 发现的问题

如果在测试中发现问题，请记录：

### 问题 1
- **测试项**: _____________
- **问题描述**: _____________
- **重现步骤**: _____________
- **预期结果**: _____________
- **实际结果**: _____________
- **截图**: _____________

---

## ✅ 测试通过标准

所有测试项必须通过才能认为修复完成：
- ✅ 右键菜单正常工作
- ✅ 颜色符合规范且支持深色模式
- ✅ 删除流程正确处理成功和失败情况
- ✅ 搜索功能正常，无冗余状态
- ✅ 刷新按钮正确显示加载状态
- ✅ 搜索高亮支持特殊字符，不崩溃

---

## 📝 测试建议

### 优先级
1. **高优先级**: 测试 1、3、6（影响核心功能）
2. **中优先级**: 测试 5（影响用户体验）
3. **低优先级**: 测试 2、4（视觉和代码质量）

### 测试顺序
建议按以下顺序测试：
1. 测试 6（搜索特殊字符）- 最容易验证
2. 测试 1（右键菜单）- 核心功能
3. 测试 5（刷新按钮状态）- 交互反馈
4. 测试 3（删除流程）- 需要准备测试数据
5. 测试 2（颜色规范）- 视觉检查
6. 测试 4（代码冗余）- 功能验证

### 快速验证脚本

如果需要快速验证，可以在浏览器控制台运行：

```javascript
// 验证 useDatabaseConnections 返回 isFetching
const hook = require('@/new/hooks/useDatabaseConnections');
console.log('useDatabaseConnections exports:', Object.keys(hook));

// 验证搜索高亮转义
const testQuery = '(test[123]*';
const escaped = testQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
console.log('Original:', testQuery);
console.log('Escaped:', escaped);
console.log('Can create RegExp:', new RegExp(escaped));
```

---

**测试清单版本**: 1.0  
**创建日期**: 2024-12-05  
**适用修复**: 问题 1-6 全部修复
