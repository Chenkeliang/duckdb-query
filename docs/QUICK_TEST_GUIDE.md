# Query Workbench 功能测试指南

## 🚀 快速测试步骤

### 准备工作

1. **打开文件**
   ```bash
   # 在浏览器中直接打开
   open docs/query_workbench_fixed.html
   
   # 或使用本地服务器
   cd docs
   python -m http.server 8080
   # 访问 http://localhost:8080/query_workbench_fixed.html
   ```

2. **检查基础环境**
   - [ ] 页面正常加载
   - [ ] 深色主题正常显示
   - [ ] Lucide 图标全部渲染（无方框）
   - [ ] 左侧数据源面板显示

---

## ✅ 功能测试清单

### 1️⃣ 透视表功能测试

#### 测试步骤
1. 点击三级 Tab 中的 **"透视表"** 按钮
2. 观察内容区是否正确切换
3. 检查三列布局（行维度 / 列维度 / 聚合指标）

#### 预期结果
- [x] 透视表标签页高亮显示
- [x] 其他标签页（可视化查询、SQL查询等）隐藏
- [x] 三列布局正常显示
- [x] 每列有示例数据（category、region、year、总金额）
- [x] SQL 预览区域显示完整的 PIVOT 查询语句
- [x] 所有图标正确渲染（`table-2`、`rows`、`columns`、`sigma`）

#### 交互测试
- [x] 点击"添加行维度"按钮无错误
- [x] 点击示例数据的删除按钮（X）无错误
- [x] 执行查询、预览结果、导出配置按钮可点击

---

### 2️⃣ 计算字段功能测试

#### 测试步骤 A：卡片导航
1. 切换到 **"可视化查询"** 三级 Tab
2. 在左侧卡片导航中找到 **"计算字段"** 卡片
3. 点击该卡片

#### 预期结果
- [x] 计算字段卡片显示（在"字段选择"之后）
- [x] 卡片图标为 `function-square`
- [x] 显示计数器 "0"
- [x] 点击后右侧内容区切换到计算字段配置

---

#### 测试步骤 B：组合运算模式
1. 确保"组合运算"按钮处于激活状态（有背景色和阴影）
2. 观察示例计算字段（total_price = price * quantity）

#### 预期结果
- [x] "组合运算"按钮高亮（`bg-surface shadow-sm`）
- [x] 其他两个按钮为灰色（`text-muted-fg`）
- [x] 显示字段名输入框（值为 "total_price"）
- [x] 显示两个列选择器 + 中间的运算符选择器（*）
- [x] 底部显示 SQL 预览：`price * quantity AS total_price`
- [x] 显示"添加组合运算字段"按钮

---

#### 测试步骤 C：CASE WHEN 模式
1. 点击 **"CASE WHEN"** 按钮
2. 观察内容区切换

#### 预期结果
- [x] "CASE WHEN"按钮变为激活状态
- [x] "组合运算"按钮变为未激活状态
- [x] 内容区显示 CASE WHEN 配置界面
- [x] 显示示例字段（price_level）
- [x] 显示两个 WHEN 条件卡片（price > 1000 → '高价'，price > 500 → '中价'）
- [x] 显示 ELSE 默认值卡片（'低价'）
- [x] 每个条件卡片有：列选择器 + 运算符 + 值输入框 + 结果输入框
- [x] 显示"添加 WHEN 条件"按钮
- [x] SQL 预览显示完整 CASE WHEN 语句

---

#### 测试步骤 D：窗口函数模式
1. 点击 **"窗口函数"** 按钮
2. 观察内容区切换

#### 预期结果
- [x] "窗口函数"按钮变为激活状态
- [x] 内容区显示窗口函数配置界面
- [x] 显示示例字段（sales_rank）
- [x] 窗口函数选择器显示 7 种选项（ROW_NUMBER、RANK、DENSE_RANK、SUM、AVG、LAG、LEAD）
- [x] 当前选择为 RANK
- [x] 显示 PARTITION BY 多选框（已选 category）
- [x] 显示 ORDER BY 配置（amount DESC）
- [x] SQL 预览显示：`RANK() OVER (PARTITION BY category ORDER BY amount DESC) AS sales_rank`

---

#### 测试步骤 E：模式切换
1. 依次点击三个模式按钮
2. 观察切换动画和状态

#### 预期结果
- [x] 每次点击只有一个按钮处于激活状态
- [x] 内容区平滑切换（无闪烁）
- [x] 所有图标在切换后正确渲染

---

### 3️⃣ JSON 字段展开功能测试

#### 测试步骤 A：字段选择区域
1. 切换到 **"可视化查询"** → 点击 **"字段选择"** 卡片
2. 在字段列表中找到 **metadata** 字段（带 JSON 标签）
3. 将鼠标悬停在该字段上

#### 预期结果
- [x] metadata 字段显示特殊图标（`braces`，警告色）
- [x] 字段右侧显示 "JSON" 标签
- [x] 鼠标悬停时，右侧出现"齿轮"图标按钮（`settings`）
- [x] 按钮有淡入动画（`opacity-0` → `opacity-100`）

---

#### 测试步骤 B：打开配置对话框
1. 点击 metadata 字段右侧的齿轮图标
2. 观察对话框弹出

#### 预期结果
- [x] 对话框居中显示
- [x] 显示半透明黑色遮罩层（`bg-black/50 backdrop-blur-sm`）
- [x] 对话框标题为 "JSON 字段展开配置"
- [x] 左上角有黄色 `braces` 图标
- [x] 右上角有关闭按钮（X）

---

#### 测试步骤 C：配置内容检查
检查对话框中的各个配置项：

#### 预期结果
- [x] **源 JSON 列**：下拉框显示 "metadata"（默认选中）
- [x] **行路径**：输入框显示 `$.items[*]`
- [x] **关联方式**：两个单选按钮（LEFT JOIN 默认选中）
- [x] **字段映射**：
  - 显示两行示例数据（item_name、item_price）
  - 每行包含：列名输入框、JSON 路径输入框、数据类型选择器、NULL 复选框、删除按钮
  - 列头提示正确显示（列名 / JSON 路径 / 数据类型 / 选项）
- [x] **添加字段按钮**：右上角显示（蓝色 + 图标）
- [x] **SQL 预览**：显示完整的 JSON_TABLE 语句

---

#### 测试步骤 D：交互测试
1. 点击 **"添加字段"** 按钮
2. 点击某行的 **删除按钮**
3. 点击 **"应用配置"** 按钮
4. 点击遮罩层

#### 预期结果
- [x] 点击"添加字段"后，新增一行空白的字段映射
- [x] 新行的图标正确渲染
- [x] 点击删除按钮后，该行被移除
- [x] 点击"应用配置"后：
  - 控制台输出配置信息
  - 显示 alert 提示（已配置 N 个字段）
  - 对话框关闭
- [x] 点击遮罩层后，对话框关闭

---

### 4️⃣ 兼容性测试（确保不影响现有功能）

#### 测试步骤
依次测试所有三级 Tab 和左侧卡片：

#### 可视化查询
- [x] 字段选择 → 正常显示
- [x] 筛选条件 → 正常显示
- [x] 分组聚合 → 正常显示
- [x] 排序 → 正常显示
- [x] 限制结果 → 正常显示

#### 其他三级 Tab
- [x] SQL 查询 → 正常显示
- [x] 关联查询 → 正常显示
- [x] 集合操作 → 正常显示
- [x] 异步任务 → 正常显示

---

## 🐛 常见问题排查

### 问题 1：图标显示为方框
**原因**：Lucide CDN 加载失败或初始化未完成

**解决**：
```javascript
// 在控制台手动执行
lucide.createIcons();
```

---

### 问题 2：透视表/计算字段点击无反应
**原因**：JavaScript 函数未正确加载

**检查**：
```javascript
// 在控制台检查函数是否存在
typeof switchThirdTab     // 应返回 "function"
typeof switchCalcMode     // 应返回 "function"
typeof openJsonConfigurator  // 应返回 "function"
```

---

### 问题 3：JSON 配置对话框无法打开
**原因**：ID 选择器错误或点击事件被阻止

**检查**：
```javascript
// 在控制台检查元素是否存在
document.getElementById('json-configurator-dialog')  // 应返回 DOM 元素
```

---

### 问题 4：计算字段模式切换无效果
**原因**：样式类未正确应用

**检查**：
```javascript
// 在控制台检查元素
const btn = document.getElementById('calc-mode-formula');
btn.classList.contains('bg-surface')  // 激活状态应返回 true
```

---

## 📊 测试结果记录表

| 功能模块 | 测试项 | 状态 | 备注 |
|---------|-------|------|------|
| **透视表** | Tab 切换 | ⬜ 通过 / ❌ 失败 | |
| | 三列布局显示 | ⬜ 通过 / ❌ 失败 | |
| | SQL 预览 | ⬜ 通过 / ❌ 失败 | |
| **计算字段** | 卡片显示 | ⬜ 通过 / ❌ 失败 | |
| | 组合运算模式 | ⬜ 通过 / ❌ 失败 | |
| | CASE WHEN 模式 | ⬜ 通过 / ❌ 失败 | |
| | 窗口函数模式 | ⬜ 通过 / ❌ 失败 | |
| | 模式切换 | ⬜ 通过 / ❌ 失败 | |
| **JSON 展开** | 字段标识 | ⬜ 通过 / ❌ 失败 | |
| | 悬停按钮 | ⬜ 通过 / ❌ 失败 | |
| | 对话框打开 | ⬜ 通过 / ❌ 失败 | |
| | 添加/删除字段 | ⬜ 通过 / ❌ 失败 | |
| | 应用配置 | ⬜ 通过 / ❌ 失败 | |
| **兼容性** | 现有功能正常 | ⬜ 通过 / ❌ 失败 | |
| | 图标渲染 | ⬜ 通过 / ❌ 失败 | |

---

## 🎯 验收标准

### 必须通过（P0）
- [x] 所有新增 Tab 和卡片能正常点击切换
- [x] 所有图标正确渲染（无方框）
- [x] JSON 配置对话框能正常打开和关闭
- [x] 计算字段三种模式能正确切换
- [x] 现有功能不受影响

### 建议通过（P1）
- [ ] 所有悬停效果正常
- [ ] 所有过渡动画流畅
- [ ] 所有输入框可输入
- [ ] 所有按钮有正确的 hover 状态

### 可选（P2）
- [ ] 控制台无错误和警告
- [ ] 响应式布局在不同屏幕尺寸下正常
- [ ] 深浅色主题切换正常

---

## 📝 测试报告模板

```markdown
## 测试报告

**测试人员**：[姓名]  
**测试时间**：[日期]  
**浏览器版本**：Chrome/Firefox/Safari [版本号]  
**屏幕分辨率**：[分辨率]  

### 测试结果
- 透视表：✅ 通过 / ❌ 失败
- 计算字段：✅ 通过 / ❌ 失败
- JSON 展开：✅ 通过 / ❌ 失败
- 兼容性：✅ 通过 / ❌ 失败

### 发现的问题
1. [问题描述]
   - 复现步骤：[步骤]
   - 预期结果：[期望]
   - 实际结果：[实际]
   - 截图：[附件]

### 总体评价
[整体评价和建议]
```

---

**文档版本**：v1.0  
**最后更新**：2024-01-XX  
**维护人**：开发团队