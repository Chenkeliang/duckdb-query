# 可视化分析增强任务（前端 & 后端详解版本）

## 目标
在保持模块化布局与设计指引不变的前提下，扩展可视化分析页面的表达能力，提升透视模式的操作体验，并补全列与列的对比、表达式计算、聚合筛选等能力。  

---

## 前端工作拆解

### 1. 筛选条件（WHERE）
1. **新增模式切换**  
   - Pill 切换（三种模式：列 vs 常量、列 vs 列、列 vs 表达式），默认展示常量模式。  
   - 切换时复用同一数据结构，保留已填入内容。  
2. **列 vs 列**  
   - 两个列选择器 + 运算符下拉；支持字段类型过滤（数值、日期等）。  
   - 同步校验：语义上不允许“文本字段 > 文本字段”。  
3. **列 vs 表达式**  
   - 表达式输入框（支持多行、自动补全字段与函数、语法高亮）。  
   - 右侧提供示例 & 校验提示；表达式渲染时保留括号。  
4. **条件列表与交互**  
   - 条件 Chip 列表新增类型标记（常量/列/表达式），操作包含编辑/删除/拖拽排序。  
   - 记录模式偏好，下次进入默认使用最近一次模式。  

### 2. 计算字段（组合 / CASE / 窗口）
1. **Tab 切换**：组合运算、条件 CASE、窗口函数。  
2. **组合运算**：  
   - 多列运算基础输入，实时显示 SQL 片段。  
   - 引用其他计算字段、聚合字段时报错提示（前端阻塞）。  
3. **条件 CASE**：  
   - WHEN/THEN/ELSE 行可增删、排序。  
   - 支持列选择、常量输入、表达式引用；提供结果类型预览。  
4. **窗口函数**：  
   - 提供函数选择（ROW_NUMBER、RANK、DENSE_RANK 等）。  
   - 分组、排序输入框（支持多个字段 + 方向）；显示最终 SQL 模板。  
5. **重用**：新增计算字段要能在 SELECT、HAVING、排序中作为候选项。  

### 3. 聚合与 HAVING
1. **聚合组件**：原基础上允许引用计算字段或表达式。  
2. **HAVING 模块**：  
   - 独立 List（与 WHERE 样式一致）；操作符支持: >、>=、<、<=、=、!=、介于。  
   - 输入框支持数字、百分比、表达式；提供“添加聚合筛选”按钮。  
   - 与 WHERE 使用相同的数据结构（便于前端管理），但在序列化时写入 `having` 节点。  

### 4. 布局与折叠
1. **三列栅格**：  
   - 常规模块固定三列，断点：≥1400px 三列、≥900px 两列、<900px 一列。  
   - 统一卡片高度和 padding（24px）；SELECT 卡片跨两列需求取消。  
2. **折叠按钮**：  
   - 标题栏右侧统一样式+文案（“折叠/展开”）。  
   - 折叠状态记忆在 localStorage，刷新后保持。  

### 5. 透视页面调整
1. **布局压缩**：大卡片保持独立页面，但内部采用三列布局（透视布局、指标与汇总、结果展示）。  
2. **指标与汇总整合**：指标列、汇总方式、转换类型、别名合并进同一行；新增“添加指标”按钮。  
3. **结果展示**：  
   - 缺失值、列值顺序（Top-N）、显示内容三项同列展示。  
   - 旧版提示区改为单行说明。  
4. **预览 Table（MUI Table）**：  
   - 根据当前配置渲染 2×3 示例；与正式数据保持样式一致。  
   - 可供用户即时验证行/列维度、指标聚合结果及占比。  

### 6. 设计 Tokens & 样式
1. 所有按钮 / Tabs / Chips 均沿用 `--dq-tab-*`、`--dq-accent-*` 等 token。  
2. 表单控件复用现有 `RoundedTextField` / Select 样式。  
3. 新增 `--dq-tab-active-color`（亮色 #2563eb、暗色 #4f8dff），保证选中状态统一。  

### 7. 状态持久化
1. 模式类型、折叠状态、透视配置等保存在 localStorage，避免刷新导致重配。  
2. 表单联动校验（例如删除计算字段后移除引用它的 HAVING 条件）。  

---

## 后端工作拆解

### 1. 查询表达能力扩展
1. **WHERE 解析**  
   - 接口接受 `type` 字段（constant / column / expression）；对表达式使用安全 AST（避免注入）。  
   - 列 vs 列：直接生成对应 SQL（支持不同别名字段）。  
   - 表达式：支持内置函数白名单（SUM、CASE、DATEDIFF 等）。  
2. **HAVING 支持**  
   - 接受 `having` 数组，与 where 结构类似；序列化为 `GROUP BY ... HAVING ...`。  
   - 聚合函数必须先出现在 select 字段或计算字段列表中。  

### 2. 计算字段
1. **组合运算**：延用现有表达式解析器，允许引用多个字段。  
2. **CASE WHEN**：  
   - 后端需解析 WHEN/THEN/ELSE 结构，生成 `CASE ... WHEN ... THEN ... ELSE ... END`。  
   - 校验结果类型一致（numeric/text）。  
3. **窗口函数**：  
   - 支持 `ROW_NUMBER`, `RANK`, `DENSE_RANK`, `LAG`, `LEAD` 等；生成 `OVER (PARTITION BY ... ORDER BY ...)`。  
   - 限制窗口函数只能应用在 `SELECT` 或计算字段中，不允许直接放 HAVING。  

### 3. API & 数据结构
1. **接口协议更新**：  
   ```
   {
     "filters": [{ "type": "column_vs_column", "left": {...}, "right": {...}, ... }],
     "computedFields": [{ "kind": "case", "branches": [...] }],
     "having": [{ ... }],
     "windowFunctions": [...]
   }
   ```  
2. **SQL 生成器**：重构为模块化函数，根据类型拼接 Where、Select、Group、Having、Order、Window。  
3. **错误提示**：当表达式语法错误、字段不存在、类型不匹配时返回具体原因（错误码 + message）。  

### 4. 透视接口
1. 保留原有“选择布局、指标、结果选项”接口结构，只需支持新增字段（比如 Top-N、显示内容）。  
2. 提供样例数据接口供前端渲染预览表（可抽样 2×2）。  

### 5. 兼容与安全
1. 对比旧 schema，确保不破坏旧版保存的可视化配置；需要提供迁移逻辑。  
2. 所有表达式白名单校验、防 SQL 注入。  
3. 增加单元测试：  
   - 列 vs 列、表达式组合；  
   - CASE WHEN & Window 函数；  
   - HAVING 多条件；  
   - 透视配置 + SQL 输出。  

---

## 最终样式要点（亮/暗主题统一）
1. 卡片：圆角 16px，背景 `var(--dq-surface-card)`，描边 `rgba(15,23,42,0.08)`。  
2. Tabs：统一使用 token `--dq-tab-font-size-primary/secondary`、`--dq-tab-active-color`。  
3. Buttons：复用全局 MUI 按钮规则（默认描边 + hover 橙填充；暗色下 hover 转橙背景）。  
4. 透视模块：  
   - 三列分栏（行/列/值、指标汇总、展示选项），虚线边框，透明背景；  
   - 预览使用 MUI Table 样式，表头浅蓝背景。  
5. 颜色：所有新色均来源 token；禁止硬编码。  

---

## 数据 & 交互验证清单
1. 列 vs 列 / 表达式与数值、日期字段组合是否正确。  
2. 计算字段在 SELECT、HAVING、排序、透视中均可引用。  
3. 窗口函数结果正确，且排序方向对最终值生效。  
4. HAVING 与 WHERE 同时存在时 SQL 顺序正确。  
5. 折叠状态记忆、模式切换、Top-N 等交互的持久化。  
6. 暗色模式下所有颜色对比良好。  

---

## 交付节奏建议
1. **Sprint 1**：前端 WHERE/计算字段 UI + 后端解析支持；  
2. **Sprint 2**：HAVING、排序、持久化；  
3. **Sprint 3**：透视页面压缩 + MUI Table 预览；  
4. 完成后统一 QA + 文档更新。  

---

## 文档 & 沟通
- 本任务说明为详版，供开发对齐；简版概要请见总结回复。  
- 相关设计稿请同步更新（Tabs、Button、三列栅格等样式表）。  
- API 变更需更新接口文档，并通知后端同学等待联调。
