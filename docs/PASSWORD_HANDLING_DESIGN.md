# å¯†ç å¤„ç†è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº† DuckQuery é¡¹ç›®ä¸­æ•°æ®åº“è¿æ¥å¯†ç çš„å®‰å…¨å¤„ç†æ–¹æ¡ˆï¼Œé‡‡ç”¨**å¯†æ–‡æ ‡è®°ï¼ˆEncrypted Markerï¼‰**æ¨¡å¼ï¼Œåœ¨ä¿è¯å®‰å…¨æ€§çš„åŒæ—¶æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡

1. **å®‰å…¨æ€§**ï¼šå¯†ç åŠ å¯†å­˜å‚¨ï¼ŒAPI ä¸è¿”å›æ˜æ–‡
2. **ç”¨æˆ·ä½“éªŒ**ï¼šç¼–è¾‘è¿æ¥æ—¶ä¸éœ€è¦é‡æ–°è¾“å…¥å¯†ç 
3. **çµæ´»æ€§**ï¼šç”¨æˆ·å¯ä»¥é€‰æ‹©ä¿æŒã€ä¿®æ”¹æˆ–æ¸…é™¤å¯†ç 
4. **å‘åå…¼å®¹**ï¼šä¸å½±å“ç°æœ‰åŠŸèƒ½

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒæ¦‚å¿µï¼šå¯†æ–‡æ ‡è®°

ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦ä¸² `***ENCRYPTED***` ä½œä¸ºå¯†ç å­—æ®µçš„æ ‡è®°ï¼š
- **å‰ç«¯ â†’ åç«¯**ï¼šè¡¨ç¤º"ä¿æŒåŸå¯†ç ä¸å˜"
- **åç«¯ â†’ å‰ç«¯**ï¼šè¡¨ç¤º"å·²æœ‰å¯†ç ï¼Œä½†ä¸è¿”å›æ˜æ–‡"

### æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åº“    â”‚ å¯†ç åŠ å¯†å­˜å‚¨
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ è¯»å–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åç«¯ API  â”‚ è§£å¯†å¯†ç  â†’ è¿”å›æ ‡è®° "***ENCRYPTED***"
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ HTTP Response
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ UI   â”‚ æ˜¾ç¤ºæ ‡è®° + æç¤º"å¯†ç å·²ä¿å­˜"
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ ç”¨æˆ·æ“ä½œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·é€‰æ‹©   â”‚ 1) ä¿æŒæ ‡è®° 2) è¾“å…¥æ–°å¯†ç  3) æ¸…ç©º
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ HTTP Request
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åç«¯ API  â”‚ è¯†åˆ«æ ‡è®° â†’ ä¿æŒåŸå¯†ç  / åŠ å¯†æ–°å¯†ç  / æ¸…é™¤
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ ä¿å­˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åº“    â”‚ å¯†ç åŠ å¯†å­˜å‚¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ’» å®ç°ç»†èŠ‚

### 1. åç«¯ï¼šè¿”å›å¯†æ–‡æ ‡è®°

**æ–‡ä»¶**ï¼š`api/services/datasource_aggregator.py`

```python
def _sanitize_connection_params(self, params: Dict[str, Any]) -> Dict[str, Any]:
    """
    è„±æ•è¿æ¥å‚æ•°
    
    å¯¹äºå¯†ç å­—æ®µï¼Œè¿”å›ç‰¹æ®Šæ ‡è®° ***ENCRYPTED*** è€Œä¸æ˜¯ç©ºå­—ç¬¦ä¸²
    è¿™æ ·å‰ç«¯å¯ä»¥è¯†åˆ«å‡ºå·²æœ‰å¯†ç ï¼Œç”¨æˆ·å¯ä»¥é€‰æ‹©ä¸ä¿®æ”¹
    """
    sanitized = params.copy()

    # å¯†ç å­—æ®µï¼šå¦‚æœå­˜åœ¨å¯†ç ï¼Œè¿”å›åŠ å¯†æ ‡è®°
    if "password" in sanitized and sanitized["password"]:
        sanitized["password"] = "***ENCRYPTED***"
    
    return sanitized
```

**å…³é”®ç‚¹**ï¼š
- åªåœ¨å¯†ç å­˜åœ¨æ—¶è¿”å›æ ‡è®°
- å¦‚æœå¯†ç ä¸ºç©ºï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²ï¼ˆè¡¨ç¤ºæœªè®¾ç½®å¯†ç ï¼‰

### 2. åç«¯ï¼šæ™ºèƒ½å¤„ç†å¯†ç 

**æ–‡ä»¶**ï¼š`api/core/metadata_manager.py`

```python
def save_metadata(self, table: str, id: str, data: dict) -> bool:
    """
    ä¿å­˜å…ƒæ•°æ®ï¼ˆæ•°æ®åº“è¿æ¥æˆ–æ–‡ä»¶æ•°æ®æºï¼‰
    
    å¯¹äºæ•°æ®åº“è¿æ¥ï¼Œæ™ºèƒ½å¤„ç†å¯†ç å­—æ®µï¼š
    - å¦‚æœå¯†ç æ˜¯ ***ENCRYPTED***ï¼Œä¿æŒåŸå¯†ç ä¸å˜
    - å¦‚æœå¯†ç æ˜¯æ–°å€¼ï¼ŒåŠ å¯†å¹¶ä¿å­˜
    - å¦‚æœå¯†ç ä¸ºç©ºï¼Œæ¸…é™¤å¯†ç 
    """
    if table == "system_database_connections" and "params" in data:
        data = data.copy()
        params = data["params"].copy()
        
        # æ£€æŸ¥å¯†ç å­—æ®µæ˜¯å¦æ˜¯åŠ å¯†æ ‡è®°
        if params.get("password") == "***ENCRYPTED***":
            # å¯†ç æ˜¯æ ‡è®°ï¼Œéœ€è¦ä¿æŒåŸå¯†ç 
            existing = self.get_metadata(table, id)
            if existing and "params" in existing:
                existing_params = existing["params"]
                if "password" in existing_params:
                    # ä½¿ç”¨åŸå¯†ç 
                    params["password"] = existing_params["password"]
                    logger.debug(f"ä¿æŒåŸå¯†ç ä¸å˜: {id}")
                else:
                    # åŸè¿æ¥æ²¡æœ‰å¯†ç ï¼Œæ¸…é™¤æ ‡è®°
                    params.pop("password", None)
            else:
                # æ–°è¿æ¥ä½†å¯†ç æ˜¯æ ‡è®°ï¼Œæ¸…é™¤æ ‡è®°
                params.pop("password", None)
        
        # åŠ å¯†æ•æ„Ÿå‚æ•°
        data["params"] = encrypt_json(params)
```

**å¤„ç†é€»è¾‘**ï¼š

| è¾“å…¥å¯†ç å€¼ | æ“ä½œ | ç»“æœ |
|-----------|------|------|
| `***ENCRYPTED***` | æŸ¥è¯¢åŸå¯†ç  | ä¿æŒåŸå¯†ç ä¸å˜ |
| æ–°å¯†ç å­—ç¬¦ä¸² | åŠ å¯† | ä¿å­˜æ–°å¯†ç  |
| ç©ºå­—ç¬¦ä¸² | æ¸…é™¤ | åˆ é™¤å¯†ç å­—æ®µ |
| `null` / `undefined` | æ¸…é™¤ | åˆ é™¤å¯†ç å­—æ®µ |

### 3. å‰ç«¯ï¼šè¿”å›å¯†æ–‡æ ‡è®°

**æ–‡ä»¶**ï¼š`frontend/src/new/DataSource/SavedConnectionsList.tsx`

```typescript
params: {
  host,
  port,
  database,
  user,
  schema,
  password: '***ENCRYPTED***', // å¯†ç æ ‡è®°ï¼Œè¡¨ç¤ºå·²æœ‰å¯†ç 
  path: item.metadata?.path || ''
}
```

**å…³é”®ç‚¹**ï¼š
- ä»åç«¯æ¥æ”¶åˆ°æ ‡è®°åï¼Œç›´æ¥ä¼ é€’ç»™è¡¨å•
- ä¸å°è¯•è§£å¯†æˆ–ä¿®æ”¹æ ‡è®°

### 4. å‰ç«¯ï¼šç”¨æˆ·ç•Œé¢æç¤º

**æ–‡ä»¶**ï¼š`frontend/src/new/DataSource/DatabaseForm.tsx`

```tsx
<div className="space-y-2">
  <Label htmlFor="password">
    {t("page.datasource.connection.password")}
  </Label>
  <Input
    id="password"
    type="password"
    value={password}
    onChange={e => setPassword(e.target.value)}
    placeholder={
      password === "***ENCRYPTED***" 
        ? "â€¢â€¢â€¢â€¢â€¢â€¢ï¼ˆå·²ä¿å­˜ï¼Œç•™ç©ºä¿æŒä¸å˜ï¼‰" 
        : "â€¢â€¢â€¢â€¢â€¢â€¢"
    }
  />
  {password === "***ENCRYPTED***" && (
    <p className="text-[11px] text-muted-foreground">
      å¯†ç å·²ä¿å­˜ï¼Œç•™ç©ºåˆ™ä¿æŒåŸå¯†ç ä¸å˜
    </p>
  )}
</div>
```

**ç”¨æˆ·ä½“éªŒ**ï¼š
- çœ‹åˆ°æ ‡è®°æ—¶ï¼Œæ˜¾ç¤ºå‹å¥½æç¤º
- ç”¨æˆ·å¯ä»¥é€‰æ‹©ï¼š
  1. ä¸ä¿®æ”¹ï¼šä¿æŒæ ‡è®°ä¸å˜
  2. ä¿®æ”¹ï¼šæ¸…ç©ºå¹¶è¾“å…¥æ–°å¯†ç 
  3. æ¸…é™¤ï¼šæ¸…ç©ºå­—æ®µ

## ğŸ”’ å®‰å…¨æ€§åˆ†æ

### å¨èƒæ¨¡å‹

| å¨èƒ | é˜²æŠ¤æªæ–½ | çŠ¶æ€ |
|------|---------|------|
| æ•°æ®åº“æ³„éœ² | å¯†ç åŠ å¯†å­˜å‚¨ | âœ… å·²é˜²æŠ¤ |
| API å“åº”æ‹¦æˆª | ä¸è¿”å›æ˜æ–‡å¯†ç  | âœ… å·²é˜²æŠ¤ |
| å‰ç«¯ç¼“å­˜æ³„éœ² | ä¸ç¼“å­˜æ˜æ–‡å¯†ç  | âœ… å·²é˜²æŠ¤ |
| æ ‡è®°ä¼ªé€  | åç«¯éªŒè¯å¹¶æŸ¥è¯¢åŸå¯†ç  | âœ… å·²é˜²æŠ¤ |
| ä¸­é—´äººæ”»å‡» | ä½¿ç”¨ HTTPS | âš ï¸ éœ€é…ç½® |

### åŠ å¯†æ–¹æ¡ˆ

**å½“å‰å®ç°**ï¼š`api/utils/encryption_utils.py`

```python
def encrypt_password(password: str) -> str:
    """åŠ å¯†å¯†ç ï¼ˆXOR + Base64ï¼‰"""
    key = get_encryption_key()
    encrypted_bytes = bytes([b ^ key[i % len(key)] for i, b in enumerate(password.encode())])
    return base64.b64encode(encrypted_bytes).decode()

def decrypt_password(encrypted: str) -> str:
    """è§£å¯†å¯†ç """
    key = get_encryption_key()
    encrypted_bytes = base64.b64decode(encrypted)
    decrypted_bytes = bytes([b ^ key[i % len(key)] for i, b in enumerate(encrypted_bytes)])
    return decrypted_bytes.decode()
```

**å®‰å…¨å»ºè®®**ï¼š
- âœ… å½“å‰æ–¹æ¡ˆï¼šé€‚ç”¨äºé˜²æ­¢æ˜æ–‡å­˜å‚¨
- ğŸ”„ ç”Ÿäº§ç¯å¢ƒï¼šå»ºè®®ä½¿ç”¨ AES-256 æˆ– Fernet åŠ å¯†
- ğŸ”‘ å¯†é’¥ç®¡ç†ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡ `DUCKQUERY_ENCRYPTION_KEY`

## ğŸ“Š æ€§èƒ½å½±å“

### é¢å¤–å¼€é”€

| æ“ä½œ | é¢å¤–æ—¶é—´ | å½±å“ |
|------|---------|------|
| åˆ—å‡ºè¿æ¥ | < 1ms | å¯å¿½ç•¥ |
| è·å–å•ä¸ªè¿æ¥ | < 1ms | å¯å¿½ç•¥ |
| ä¿å­˜è¿æ¥ï¼ˆæ ‡è®°ï¼‰ | ~5msï¼ˆæŸ¥è¯¢åŸå¯†ç ï¼‰ | å¾ˆå° |
| ä¿å­˜è¿æ¥ï¼ˆæ–°å¯†ç ï¼‰ | < 1ms | å¯å¿½ç•¥ |

### ä¼˜åŒ–æªæ–½

- âœ… ä½¿ç”¨ç¼“å­˜å‡å°‘æ•°æ®åº“æŸ¥è¯¢
- âœ… æ‰¹é‡æ“ä½œæ—¶å¤ç”¨è¿æ¥
- âœ… å¼‚æ­¥å¤„ç†åŠ å¯†æ“ä½œ

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

```python
def test_password_marker_handling():
    """æµ‹è¯•å¯†ç æ ‡è®°å¤„ç†"""
    # 1. ä¿å­˜æ–°è¿æ¥
    manager.save_metadata("system_database_connections", "test_conn", {
        "id": "test_conn",
        "params": {"password": "secret123"}
    })
    
    # 2. è·å–è¿æ¥ï¼ˆåº”è¿”å›æ ‡è®°ï¼‰
    conn = manager.get_metadata("system_database_connections", "test_conn")
    assert conn["params"]["password"] == "***ENCRYPTED***"
    
    # 3. ä¿å­˜æ ‡è®°ï¼ˆåº”ä¿æŒåŸå¯†ç ï¼‰
    manager.save_metadata("system_database_connections", "test_conn", {
        "id": "test_conn",
        "params": {"password": "***ENCRYPTED***"}
    })
    
    # 4. éªŒè¯å¯†ç æœªæ”¹å˜
    # ï¼ˆéœ€è¦è§£å¯†éªŒè¯ï¼‰
```

### é›†æˆæµ‹è¯•

å‚è€ƒï¼š`test_password_handling.md`

## ğŸ¯ æœ€ä½³å®è·µ

### å¼€å‘è€…æŒ‡å—

1. **ä¸è¦ç¡¬ç¼–ç æ ‡è®°**ï¼šä½¿ç”¨å¸¸é‡ `PASSWORD_ENCRYPTED_MARKER = "***ENCRYPTED***"`
2. **æ€»æ˜¯éªŒè¯æ ‡è®°**ï¼šåç«¯å¿…é¡»éªŒè¯æ ‡è®°å¹¶æŸ¥è¯¢åŸå¯†ç 
3. **æä¾›æ¸…æ™°æç¤º**ï¼šå‰ç«¯å¿…é¡»å‘ŠçŸ¥ç”¨æˆ·å¯†ç å·²ä¿å­˜
4. **æ—¥å¿—è„±æ•**ï¼šæ—¥å¿—ä¸­ä¸è®°å½•å¯†ç æˆ–æ ‡è®°

### ç”¨æˆ·æŒ‡å—

1. **ç¼–è¾‘è¿æ¥æ—¶**ï¼šå¦‚æœä¸éœ€è¦ä¿®æ”¹å¯†ç ï¼Œä¿æŒå­—æ®µä¸å˜å³å¯
2. **ä¿®æ”¹å¯†ç æ—¶**ï¼šæ¸…ç©ºå­—æ®µå¹¶è¾“å…¥æ–°å¯†ç 
3. **æ¸…é™¤å¯†ç æ—¶**ï¼šæ¸…ç©ºå­—æ®µå¹¶ä¿å­˜

## ğŸ”„ æœªæ¥æ”¹è¿›

### çŸ­æœŸï¼ˆ1-3ä¸ªæœˆï¼‰

- [ ] æ·»åŠ å¯†ç å¼ºåº¦æ£€æŸ¥
- [ ] æ”¯æŒå¯†ç è¿‡æœŸæé†’
- [ ] æ·»åŠ å¯†ç ä¿®æ”¹å†å²

### é•¿æœŸï¼ˆ3-6ä¸ªæœˆï¼‰

- [ ] å‡çº§åˆ° AES-256 åŠ å¯†
- [ ] é›†æˆå¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆKMSï¼‰
- [ ] æ”¯æŒå¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰
- [ ] å®ç°å¯†ç è½®æ¢ç­–ç•¥

## ğŸ“š å‚è€ƒèµ„æ–™

- [OWASP Password Storage Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)
- [NIST Digital Identity Guidelines](https://pages.nist.gov/800-63-3/)
- [Python Cryptography Library](https://cryptography.io/)

## ğŸ“ å˜æ›´å†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|---------|------|
| 2024-12-03 | 1.0 | åˆå§‹ç‰ˆæœ¬ - å¯†æ–‡æ ‡è®°æ–¹æ¡ˆ | AI Assistant |

---

**çŠ¶æ€**: âœ… å·²å®æ–½  
**æœ€åæ›´æ–°**: 2024-12-03
