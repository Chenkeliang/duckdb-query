<!DOCTYPE html>
<html lang="zh-CN" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>数据查询工作台 - DuckQuery Preview</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap");

      :root {
        /* Light Mode */
        --dq-background: 0 0% 100%;
        --dq-surface: 0 0% 100%;
        --dq-surface-hover: 240 5.9% 96%;
        --dq-foreground: 240 10% 3.9%;
        --dq-muted: 240 5.9% 90%;
        --dq-muted-fg: 240 3.8% 46.1%;
        --dq-border: 240 5.9% 90%;
        --dq-border-subtle: 240 5.9% 95%;
        --dq-primary: 221.2 83.2% 53.3%;
        --dq-primary-fg: 0 0% 100%;
        --dq-input-bg: 0 0% 100%;
        --dq-success: 142 76% 36%;
        --dq-nav-active-bg: 214 95% 93%;
        --dq-nav-active-border: 214 80% 88%;
        --dq-nav-active-fg: 221.2 83.2% 53.3%;
      }

      .dark {
        /* Dark Mode */
        --dq-background: 240 10% 3.9%;
        --dq-surface: 240 10% 3.9%;
        --dq-surface-hover: 240 3.7% 15.9%;
        --dq-foreground: 0 0% 98%;
        --dq-muted: 240 3.7% 15.9%;
        --dq-muted-fg: 240 5% 64.9%;
        --dq-border: 240 5% 21%;
        --dq-border-subtle: 240 5% 18%;
        --dq-primary: 24.6 95% 53.1%;
        --dq-primary-fg: 0 0% 100%;
        --dq-input-bg: 240 10% 3.9%;
        --dq-success: 142 76% 46%;
        --dq-nav-active-bg: 24.6 95% 53.1% / 0.1;
        --dq-nav-active-border: 24.6 95% 53.1% / 0.2;
        --dq-nav-active-fg: 24.6 95% 53.1%;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: hsl(var(--dq-background));
        color: hsl(var(--dq-foreground));
      }

      .bg-background {
        background-color: hsl(var(--dq-background));
      }

      .bg-surface {
        background-color: hsl(var(--dq-surface));
      }

      .bg-surface-hover:hover {
        background-color: hsl(var(--dq-surface-hover));
      }

      .bg-muted {
        background-color: hsl(var(--dq-muted));
      }

      .bg-primary {
        background-color: hsl(var(--dq-primary));
      }

      .text-foreground {
        color: hsl(var(--dq-foreground));
      }

      .text-muted-fg {
        color: hsl(var(--dq-muted-fg));
      }

      .text-primary {
        color: hsl(var(--dq-primary));
      }

      .text-success {
        color: hsl(var(--dq-success));
      }

      .border-border {
        border-color: hsl(var(--dq-border));
      }

      .border-border-subtle {
        border-color: hsl(var(--dq-border-subtle));
      }

      .duck-input {
        width: 100%;
        background-color: hsl(var(--dq-input-bg));
        border: 1px solid hsl(var(--dq-border));
        border-radius: 0.375rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        color: hsl(var(--dq-foreground));
        outline: none;
        transition: all 0.2s;
      }

      .duck-input:focus {
        border-color: hsl(var(--dq-primary));
        box-shadow: 0 0 0 2px hsl(var(--dq-primary) / 0.2);
      }

      .nav-active {
        background-color: hsl(var(--dq-nav-active-bg));
        color: hsl(var(--dq-nav-active-fg));
        border-color: hsl(var(--dq-nav-active-border));
      }

      .tab-btn {
        padding: 0 0.75rem;
        height: 100%;
        font-size: 0.75rem;
        font-weight: 500;
        border-radius: 6px;
        transition: all 0.2s;
        cursor: pointer;
        border: none;
        background: transparent;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .tab-btn.active {
        background-color: hsl(var(--dq-muted));
        color: hsl(var(--dq-foreground));
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      }

      .tab-btn:not(.active) {
        color: hsl(var(--dq-muted-fg));
      }

      .tab-btn:not(.active):hover {
        color: hsl(var(--dq-foreground));
      }

      .tree-item {
        padding: 0.25rem 0.5rem;
        font-size: 0.8125rem;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .tree-item:hover {
        background-color: hsl(var(--dq-surface-hover));
      }

      .tree-item.selected {
        background-color: hsl(var(--dq-muted));
      }

      .tree-item .item-name {
        flex: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .tree-item .item-count {
        font-size: 0.75rem;
        color: hsl(var(--dq-muted-fg));
        font-variant-numeric: tabular-nums;
        min-width: 3ch;
        text-align: right;
      }

      /* IDE 风格表格 */
      .ide-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.8125rem;
        font-family: "JetBrains Mono", monospace;
        background-color: hsl(var(--dq-surface));
      }

      .ide-table thead {
        position: sticky;
        top: 0;
        background-color: hsl(var(--dq-muted));
        z-index: 10;
      }

      .ide-table th {
        padding: 0.5rem 0.75rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.75rem;
        color: hsl(var(--dq-muted-fg));
        border-bottom: 1px solid hsl(var(--dq-border));
        border-right: 1px solid hsl(var(--dq-border-subtle));
        white-space: nowrap;
        user-select: none;
        position: relative;
      }

      .ide-table th:hover button {
        opacity: 1 !important;
      }

      .ide-table th:last-child {
        border-right: none;
      }

      .ide-table tbody tr {
        border-bottom: 1px solid hsl(var(--dq-border-subtle));
      }

      .ide-table tbody tr:hover {
        background-color: hsl(var(--dq-surface-hover));
      }

      .ide-table tbody tr.selected {
        background-color: hsl(var(--dq-primary) / 0.1);
      }

      .ide-table td {
        padding: 0.4rem 0.75rem;
        border-right: 1px solid hsl(var(--dq-border-subtle));
        color: hsl(var(--dq-foreground));
        font-variant-numeric: tabular-nums;
      }

      .ide-table td:last-child {
        border-right: none;
      }

      .ide-table tbody tr {
        background-color: hsl(var(--dq-surface));
      }

      /* 表格容器背景 - 调试用白色 */
      /* 表格容器背景，使用 flex 布局让表格贴底部 */
      #table-container {
        background-color: hsl(var(--dq-surface));
      }

      /* ide-table 样式已迁移到 Tailwind 组件层（frontend/src/styles/tailwind.css） */

      /* 结果工具栏 */
      .result-toolbar {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        background-color: hsl(var(--dq-surface));
        border-bottom: 1px solid hsl(var(--dq-border));
        font-size: 0.875rem;
        flex-shrink: 0;
      }

      /* 代码块样式 */
      .code-block {
        background-color: hsl(var(--dq-muted));
        border: 1px solid hsl(var(--dq-border));
        border-radius: 0.5rem;
        padding: 1rem;
        font-family: "JetBrains Mono", monospace;
        font-size: 0.8125rem;
        line-height: 1.6;
        overflow-x: auto;
        color: hsl(var(--dq-foreground));
      }

      /* 分隔容器 */
      .split-container {
        display: flex;
        flex-direction: column;
        flex: 1;
        overflow: hidden;
      }

      .split-pane-top {
        flex: 1;
        overflow: auto;
        min-height: 0;
      }

      .result-scroll-area {
        flex: 1;
        overflow: auto;
        min-height: 0;
      }

      .split-pane-bottom {
        border-top: 1px solid hsl(var(--dq-border));
        transition: height 0.3s ease;
      }

      .split-pane-bottom.collapsed {
        overflow: hidden;
        border-top: none;
      }

      /* 拖拽分隔线 */
      .resizer {
        height: 4px;
        background-color: hsl(var(--dq-border));
        cursor: ns-resize;
        position: relative;
        flex-shrink: 0;
        transition: background-color 0.2s;
      }

      .resizer:hover {
        background-color: hsl(var(--dq-primary));
      }

      .resizer::before {
        content: "";
        position: absolute;
        top: -4px;
        left: 0;
        right: 0;
        height: 12px;
      }

      /* 折叠按钮 */
      .collapse-btn {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 24px;
        height: 16px;
        background-color: hsl(var(--dq-surface));
        border: 1px solid hsl(var(--dq-border));
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: all 0.2s;
        cursor: pointer;
      }

      .resizer:hover .collapse-btn {
        opacity: 1;
      }

      .collapse-btn:hover {
        background-color: hsl(var(--dq-primary));
        border-color: hsl(var(--dq-primary));
        color: white;
      }

      /* 横向调整器 */
      .horizontal-resizer {
        width: 4px;
        background-color: transparent;
        cursor: ew-resize;
        position: relative;
        transition: background-color 0.2s;
        flex-shrink: 0;
      }

      .horizontal-resizer:hover {
        background-color: hsl(var(--dq-primary));
      }

      .horizontal-resizer::before {
        content: "";
        position: absolute;
        top: 0;
        left: -4px;
        bottom: 0;
        width: 12px;
      }

      /* 数据源面板折叠状态 */
      .datasource-panel-collapsed {
        width: 48px !important;
        min-width: 48px !important;
      }

      .datasource-panel-collapsed .datasource-title,
      .datasource-panel-collapsed .duck-input,
      .datasource-panel-collapsed .datasource-tree,
      .datasource-panel-collapsed .datasource-footer,
      .datasource-panel-collapsed #datasource-toggle-btn {
        display: none !important;
      }

      /* 折叠动画 */
      .sidebar-collapsed {
        width: 64px !important;
      }

      .sidebar-collapsed .sidebar-text {
        display: none;
      }

      .datasource-panel-collapsed {
        width: 0 !important;
        min-width: 0 !important;
        padding: 0 !important;
        border: none !important;
        overflow: hidden !important;
      }

      .transition-width {
        transition: width 0.3s ease, min-width 0.3s ease;
      }

      /* 查询模式卡片样式 */
      .query-mode-card {
        padding: 12px;
        border-radius: 8px;
        border: 1px solid hsl(var(--dq-border));
        background: hsl(var(--dq-surface));
        cursor: pointer;
        transition: all 0.2s;
      }

      .query-mode-card:hover {
        background: hsl(var(--dq-surface-hover));
        border-color: hsl(var(--dq-primary) / 0.3);
      }

      .query-mode-card.active {
        background: hsl(var(--dq-primary) / 0.1);
        border-color: hsl(var(--dq-primary));
      }

      .query-mode-card.active .w-8 {
        background: hsl(var(--dq-primary) / 0.2) !important;
      }

      .query-mode-card.active i {
        color: hsl(var(--dq-primary)) !important;
      }

      .query-mode-content {
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>

  <body class="bg-background h-screen w-full overflow-hidden flex">
    <!-- ======================================================================== -->
    <!-- 1. SIDEBAR (全局导航，可折叠) -->
    <!-- ======================================================================== -->
    <aside
      id="sidebar"
      class="w-64 bg-surface border-r border-border flex flex-col shrink-0 transition-width"
    >
      <!-- Logo -->
      <div class="h-14 flex items-center gap-3 px-5 border-b border-border">
        <div
          class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center text-white font-bold shadow-lg"
        >
          D
        </div>
        <div class="sidebar-text">
          <div class="font-bold text-sm tracking-wide text-foreground">
            DuckQuery
          </div>
          <div class="text-[10px] text-muted-fg font-mono">v2.0 Preview</div>
        </div>
      </div>

      <!-- 导航菜单 -->
      <nav class="flex-1 p-3 space-y-1 overflow-hidden">
        <button
          class="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg transition-all border border-transparent text-muted-fg hover:text-foreground hover:bg-surface-hover"
          title="数据源管理"
        >
          <i data-lucide="database" class="w-4 h-4 shrink-0"></i>
          <span class="sidebar-text truncate">数据源管理</span>
        </button>
        <button
          class="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg nav-active transition-all border"
          title="数据查询"
        >
          <i data-lucide="search" class="w-4 h-4 shrink-0"></i>
          <span class="sidebar-text truncate">数据查询</span>
        </button>
      </nav>

      <!-- 底部操作 -->
      <div class="p-3 border-t border-border space-y-2">
        <div class="grid grid-cols-2 gap-2">
          <button
            class="flex items-center justify-center rounded-lg border border-border bg-surface px-2 py-2 text-xs text-muted-fg hover:bg-surface-hover"
            title="切换主题"
          >
            <i data-lucide="sun" class="w-4 h-4"></i>
          </button>
          <button
            class="flex items-center justify-center rounded-lg border border-border bg-surface px-2 py-2 text-xs text-muted-fg hover:bg-surface-hover"
            title="切换语言"
          >
            <i data-lucide="languages" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </aside>

    <!-- ======================================================================== -->
    <!-- 2. MAIN CONTENT AREA -->
    <!-- ======================================================================== -->
    <main class="flex-1 flex flex-col bg-background overflow-hidden">
      <!-- Header with 二级 Tab -->
      <header
        class="h-14 bg-surface border-b border-border flex items-center justify-between px-6 shrink-0"
      >
        <div class="flex items-center gap-6">
          <h1 class="text-lg font-semibold">数据查询</h1>
          <div
            class="flex bg-muted/50 p-1 rounded-lg h-9 border border-border gap-1"
          >
            <button
              class="tab-btn active text-xs"
              onclick="switchSecondaryTab('query')"
            >
              <i data-lucide="search" class="w-3 h-3"></i>
              查询模式
            </button>
            <button
              class="tab-btn text-xs"
              onclick="switchSecondaryTab('tasks')"
            >
              <i data-lucide="clock" class="w-3 h-3"></i>
              异步任务
            </button>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button
            class="px-3 py-1.5 text-sm rounded-md border border-border hover:bg-surface-hover"
          >
            <i data-lucide="save" class="w-4 h-4 inline mr-1"></i>
            保存查询
          </button>
          <button
            class="px-3 py-1.5 text-sm rounded-md border border-border hover:bg-surface-hover"
          >
            <i data-lucide="download" class="w-4 h-4 inline mr-1"></i>
            导出
          </button>
        </div>
      </header>

      <!-- Content Area -->
      <div class="flex-1 flex overflow-hidden">
        <!-- ==================================================================== -->
        <!-- 左侧栏：数据源树形列表 (可折叠) -->
        <!-- ==================================================================== -->
        <div
          id="datasource-panel"
          class="bg-surface flex flex-col shrink-0"
          style="width: 256px;"
        >
          <!-- 顶部：标题 + 折叠按钮 -->
          <div
            class="h-12 flex items-center justify-between px-6 border-b border-border shrink-0"
          >
            <h2 class="text-sm font-semibold text-foreground datasource-title">
              数据源
            </h2>
            <button
              onclick="toggleDataSourcePanel()"
              class="p-1.5 rounded-lg hover:bg-surface-hover transition-colors"
              title="折叠/展开数据源面板"
              id="datasource-toggle-btn"
            >
              <i
                data-lucide="panel-left-close"
                class="w-4 h-4 text-muted-fg"
              ></i>
            </button>
          </div>

          <!-- 搜索框 -->
          <div
            class="h-12 px-6 border-b border-border shrink-0 flex items-center"
          >
            <div class="relative w-full">
              <i
                data-lucide="search"
                class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-fg"
              ></i>
              <input
                type="text"
                placeholder="搜索表名或字段..."
                class="duck-input pl-9 text-sm h-9 w-full"
              />
            </div>
          </div>

          <!-- 数据源树 -->
          <div class="flex-1 overflow-auto px-6 py-2" id="datasource-tree">
            <!-- DuckDB 表 -->
            <div class="mb-4">
              <div
                class="flex items-center gap-2 px-2 py-1.5 text-xs font-semibold text-muted-fg"
              >
                <i data-lucide="chevron-down" class="w-3 h-3"></i>
                <span>DuckDB 表</span>
              </div>
              <div class="mt-1 space-y-0.5">
                <div
                  class="tree-item selected"
                  ondblclick="selectTable('sales_data', event)"
                >
                  <i
                    data-lucide="table"
                    class="w-4 h-4 text-primary shrink-0"
                  ></i>
                  <span class="item-name">sales_data</span>
                </div>
                <div
                  class="tree-item"
                  ondblclick="selectTable('customer_info', event)"
                >
                  <i
                    data-lucide="table"
                    class="w-4 h-4 text-muted-fg shrink-0"
                  ></i>
                  <span class="item-name">customer_info</span>
                </div>
                <div
                  class="tree-item"
                  ondblclick="selectTable('product_catalog', event)"
                >
                  <i
                    data-lucide="table"
                    class="w-4 h-4 text-muted-fg shrink-0"
                  ></i>
                  <span class="item-name">product_catalog</span>
                </div>
              </div>
            </div>

            <!-- 外部数据库 -->
            <div class="mb-4">
              <div
                class="flex items-center gap-2 px-2 py-1.5 text-xs font-semibold text-muted-fg cursor-pointer hover:text-foreground transition-colors"
                onclick="toggleExternalDb()"
              >
                <i
                  data-lucide="chevron-down"
                  class="w-3 h-3"
                  id="external-db-chevron"
                ></i>
                <span>外部数据库</span>
              </div>
              <div class="mt-1 space-y-0.5" id="external-db-list">
                <!-- MySQL 连接 -->
                <div class="space-y-0.5">
                  <div
                    class="tree-item cursor-pointer"
                    onclick="toggleMysqlTables(event)"
                  >
                    <i
                      data-lucide="chevron-down"
                      class="w-3 h-3 text-muted-fg shrink-0"
                      id="mysql-chevron"
                    ></i>
                    <i
                      data-lucide="database"
                      class="w-4 h-4 text-muted-fg shrink-0"
                    ></i>
                    <span class="item-name">MySQL - 生产库</span>
                    <span
                      class="w-2 h-2 rounded-full bg-success shrink-0"
                    ></span>
                  </div>

                  <!-- MySQL 下的表 -->
                  <div class="ml-6 space-y-0.5" id="mysql-tables">
                    <div
                      class="tree-item"
                      ondblclick="selectTable('orders', event)"
                    >
                      <i
                        data-lucide="table"
                        class="w-4 h-4 text-muted-fg shrink-0"
                      ></i>
                      <span class="item-name">orders</span>
                    </div>
                    <div
                      class="tree-item"
                      ondblclick="selectTable('users', event)"
                    >
                      <i
                        data-lucide="table"
                        class="w-4 h-4 text-muted-fg shrink-0"
                      ></i>
                      <span class="item-name">users</span>
                    </div>
                    <div
                      class="tree-item"
                      ondblclick="selectTable('products', event)"
                    >
                      <i
                        data-lucide="table"
                        class="w-4 h-4 text-muted-fg shrink-0"
                      ></i>
                      <span class="item-name">products</span>
                    </div>
                  </div>
                </div>

                <!-- PostgreSQL 连接 -->
                <div class="space-y-0.5">
                  <div
                    class="tree-item cursor-pointer"
                    onclick="togglePostgresTables(event)"
                  >
                    <i
                      data-lucide="chevron-right"
                      class="w-3 h-3 text-muted-fg shrink-0"
                      id="postgres-chevron"
                    ></i>
                    <i
                      data-lucide="database"
                      class="w-4 h-4 text-muted-fg shrink-0"
                    ></i>
                    <span class="item-name">PostgreSQL - 分析库</span>
                    <span
                      class="w-2 h-2 rounded-full bg-muted-fg shrink-0"
                    ></span>
                  </div>

                  <!-- PostgreSQL 下的表（默认折叠） -->
                  <div class="ml-6 space-y-0.5 hidden" id="postgres-tables">
                    <div
                      class="tree-item"
                      ondblclick="selectTable('analytics_events', event)"
                    >
                      <i
                        data-lucide="table"
                        class="w-4 h-4 text-muted-fg shrink-0"
                      ></i>
                      <span class="item-name">analytics_events</span>
                    </div>
                    <div
                      class="tree-item"
                      ondblclick="selectTable('user_sessions', event)"
                    >
                      <i
                        data-lucide="table"
                        class="w-4 h-4 text-muted-fg shrink-0"
                      ></i>
                      <span class="item-name">user_sessions</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 快速操作 -->
          <div
            class="px-6 py-3 border-t border-border flex gap-2 shrink-0 datasource-footer"
          >
            <button
              class="flex-1 px-3 py-2 text-xs rounded-md border border-border hover:bg-surface-hover transition-colors"
            >
              <i data-lucide="refresh-cw" class="w-3 h-3 inline mr-1"></i>
              刷新
            </button>
            <button
              class="flex-1 px-3 py-2 text-xs rounded-md border border-border hover:bg-surface-hover transition-colors"
            >
              <i data-lucide="plus" class="w-3 h-3 inline mr-1"></i>
              添加
            </button>
          </div>

          <!-- 横向拖拽边框 -->
          <div class="border-r border-border"></div>
        </div>

        <!-- 横向调整器 -->
        <div class="horizontal-resizer" id="horizontal-resizer"></div>

        <!-- 展开数据源面板按钮 (垂直显示) -->
        <button
          id="expand-datasource-btn"
          onclick="toggleDataSourcePanel()"
          class="hidden w-12 bg-surface border-r border-border hover:bg-surface-hover transition-colors flex-col items-center justify-center shrink-0 py-6 gap-3"
          title="展开数据源面板"
        >
          <i data-lucide="panel-left-open" class="w-4 h-4"></i>
          <span class="text-xs text-muted-fg" style="writing-mode: vertical-rl;"
            >数据源</span
          >
        </button>

        <!-- ==================================================================== -->
        <!-- 主查询区域 -->
        <!-- ==================================================================== -->
        <div class="flex-1 flex flex-col bg-background overflow-hidden">
          <!-- 查询模式内容 -->
          <div id="query-mode" class="flex-1 flex flex-col overflow-hidden">
            <!-- 三级 Tab (固定在顶部) -->
            <div
              class="h-12 border-b border-border flex items-center px-4 bg-muted/30 shrink-0"
            >
              <div class="flex gap-1 bg-muted p-1 rounded-lg h-9">
                <button
                  class="tab-btn active text-xs"
                  onclick="switchThirdTab('visual')"
                >
                  <i data-lucide="layout-grid" class="w-3 h-3 inline mr-1"></i>
                  可视化查询
                </button>
                <button class="tab-btn text-xs" onclick="switchThirdTab('sql')">
                  <i data-lucide="code" class="w-3 h-3 inline mr-1"></i>
                  SQL 查询
                </button>
                <button
                  class="tab-btn text-xs"
                  onclick="switchThirdTab('join')"
                >
                  <i data-lucide="git-merge" class="w-3 h-3 inline mr-1"></i>
                  关联查询
                </button>
                <button class="tab-btn text-xs" onclick="switchThirdTab('set')">
                  <i data-lucide="layers" class="w-3 h-3 inline mr-1"></i>
                  集合操作
                </button>
                <button
                  class="tab-btn text-xs"
                  onclick="switchThirdTab('pivot')"
                >
                  <i data-lucide="table-2" class="w-3 h-3 inline mr-1"></i>
                  透视表
                </button>
              </div>
            </div>

            <!-- 可视化查询内容 -->
            <div
              id="visual-content"
              class="flex flex-1 flex-col overflow-hidden bg-surface"
              style="display: flex;"
            >
              <!-- 查询构建器 -->
              <div
                class="bg-surface flex flex-col overflow-hidden"
                id="query-builder-pane"
                style="flex: 1; min-height: 0;"
              >
                <!-- 数据源选择行 (固定在顶部) -->
                <div
                  class="h-12 px-6 border-b border-border shrink-0 flex items-center justify-between gap-3"
                >
                  <div class="flex items-center gap-2 text-sm flex-1 min-w-0">
                    <i data-lucide="table" class="w-4 h-4 text-primary"></i>
                    <span class="text-muted-fg">数据源:</span>
                    <span class="font-semibold" id="selected-table-name">
                      sales_data
                    </span>
                    <span class="text-xs text-muted-fg px-2 py-0.5 bg-muted rounded ml-2">双击左侧切换</span>
                  </div>
                  <div class="flex gap-2 shrink-0">
                    <button
                      class="px-4 h-9 bg-primary text-primary-fg rounded-md text-sm font-medium hover:opacity-90 transition-opacity flex items-center gap-1.5"
                      title="执行查询"
                    >
                      <i data-lucide="play" class="w-4 h-4"></i>
                      执行
                    </button>
                    <button
                      class="px-4 h-9 border border-border rounded-md text-sm font-medium hover:bg-surface-hover transition-colors flex items-center gap-1.5"
                      title="保存为表"
                    >
                      <i data-lucide="save" class="w-4 h-4"></i>
                      保存
                    </button>
                  </div>
                </div>

                <!-- 查询构建器内容 (左右布局) -->
                <div class="flex-1 overflow-hidden flex">
                  <!-- 左侧：模式切换卡片 -->
                  <div
                    class="w-64 border-r border-border overflow-auto p-4 space-y-3 bg-muted/20"
                  >
                    <div class="text-xs font-semibold text-muted-fg mb-3 px-2">
                      查询构建模式
                    </div>

                    <!-- 字段选择卡片 -->
                    <div
                      class="query-mode-card active"
                      onclick="switchQueryMode('fields')"
                      id="mode-fields"
                    >
                      <div class="flex items-center gap-3">
                        <div
                          class="w-8 h-8 rounded-lg bg-primary/10 flex items-center justify-center"
                        >
                          <i
                            data-lucide="columns"
                            class="w-4 h-4 text-primary"
                          ></i>
                        </div>
                        <div class="flex-1 min-w-0">
                          <div class="font-medium text-sm">字段选择</div>
                          <div class="text-xs text-muted-fg">SELECT</div>
                        </div>
                        <div
                          class="text-xs bg-primary/20 text-primary px-2 py-0.5 rounded"
                        >
                          2/4
                        </div>
                      </div>
                    </div>

                    <!-- 计算字段卡片 -->
                    <div
                      class="query-mode-card"
                      onclick="switchQueryMode('calculated')"
                      id="mode-calculated"
                    >
                      <div class="flex items-center gap-3">
                        <div
                          class="w-8 h-8 rounded-lg bg-muted flex items-center justify-center"
                        >
                          <i
                            data-lucide="function-square"
                            class="w-4 h-4 text-muted-fg"
                          ></i>
                        </div>
                        <div class="flex-1 min-w-0">
                          <div class="font-medium text-sm">计算字段</div>
                          <div class="text-xs text-muted-fg">公式/CASE</div>
                        </div>
                        <div
                          class="text-xs bg-muted text-muted-fg px-2 py-0.5 rounded"
                          id="calculated-count"
                        >
                          0
                        </div>
                      </div>
                    </div>

                    <!-- 筛选条件卡片 -->
                    <div
                      class="query-mode-card"
                      onclick="switchQueryMode('filter')"
                      id="mode-filter"
                    >
                      <div class="flex items-center gap-3">
                        <div
                          class="w-8 h-8 rounded-lg bg-muted flex items-center justify-center"
                        >
                          <i
                            data-lucide="filter"
                            class="w-4 h-4 text-muted-fg"
                          ></i>
                        </div>
                        <div class="flex-1 min-w-0">
                          <div class="font-medium text-sm">筛选条件</div>
                          <div class="text-xs text-muted-fg">WHERE</div>
                        </div>
                        <div
                          class="text-xs bg-muted text-muted-fg px-2 py-0.5 rounded"
                        >
                          3
                        </div>
                      </div>
                    </div>

                    <!-- 分组聚合卡片 -->
                    <div
                      class="query-mode-card"
                      onclick="switchQueryMode('group')"
                      id="mode-group"
                    >
                      <div class="flex items-center gap-3">
                        <div
                          class="w-8 h-8 rounded-lg bg-muted flex items-center justify-center"
                        >
                          <i
                            data-lucide="layers"
                            class="w-4 h-4 text-muted-fg"
                          ></i>
                        </div>
                        <div class="flex-1 min-w-0">
                          <div class="font-medium text-sm">分组聚合</div>
                          <div class="text-xs text-muted-fg">GROUP BY</div>
                        </div>
                        <div
                          class="text-xs bg-muted text-muted-fg px-2 py-0.5 rounded"
                        >
                          1
                        </div>
                      </div>
                    </div>

                    <!-- 排序卡片 -->
                    <div
                      class="query-mode-card"
                      onclick="switchQueryMode('order')"
                      id="mode-order"
                    >
                      <div class="flex items-center gap-3">
                        <div
                          class="w-8 h-8 rounded-lg bg-muted flex items-center justify-center"
                        >
                          <i
                            data-lucide="arrow-up-down"
                            class="w-4 h-4 text-muted-fg"
                          ></i>
                        </div>
                        <div class="flex-1 min-w-0">
                          <div class="font-medium text-sm">排序</div>
                          <div class="text-xs text-muted-fg">ORDER BY</div>
                        </div>
                        <div
                          class="text-xs bg-muted text-muted-fg px-2 py-0.5 rounded"
                        >
                          1
                        </div>
                      </div>
                    </div>

                    <!-- 限制结果卡片 -->
                    <div
                      class="query-mode-card"
                      onclick="switchQueryMode('limit')"
                      id="mode-limit"
                    >
                      <div class="flex items-center gap-3">
                        <div
                          class="w-8 h-8 rounded-lg bg-muted flex items-center justify-center"
                        >
                          <i
                            data-lucide="list"
                            class="w-4 h-4 text-muted-fg"
                          ></i>
                        </div>
                        <div class="flex-1 min-w-0">
                          <div class="font-medium text-sm">限制结果</div>
                          <div class="text-xs text-muted-fg">LIMIT</div>
                        </div>
                        <div
                          class="text-xs bg-success/20 text-success px-2 py-0.5 rounded"
                        >
                          启用
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- 右侧：动态内容区 -->
                  <div
                    class="flex-1 overflow-auto p-6 space-y-4"
                    id="query-mode-contents"
                  >
                    <!-- 字段选择模式 -->
                    <div
                      id="content-fields"
                      class="query-mode-content"
                      style="display: block;"
                    >
                      <div class="mb-4">
                        <h3
                          class="text-base font-semibold flex items-center gap-2"
                        >
                          <i
                            data-lucide="columns"
                            class="w-5 h-5 text-primary"
                          ></i>
                          选择字段
                        </h3>
                        <p class="text-sm text-muted-fg mt-1">
                          选择要在查询结果中显示的列
                        </p>
                      </div>
                      <div class="space-y-2">
                        <!-- 普通字段 -->
                        <label
                          class="flex items-center gap-2 text-sm px-2 py-1.5 rounded hover:bg-surface-hover"
                        >
                          <input
                            type="checkbox"
                            checked
                            class="accent-primary"
                          />
                          <span class="flex-1">name</span>
                          <span class="text-xs text-muted-fg">VARCHAR</span>
                        </label>
                        <label
                          class="flex items-center gap-2 text-sm px-2 py-1.5 rounded hover:bg-surface-hover"
                        >
                          <input
                            type="checkbox"
                            checked
                            class="accent-primary"
                          />
                          <span class="flex-1">amount</span>
                          <span class="text-xs text-muted-fg">INTEGER</span>
                        </label>
                        <label
                          class="flex items-center gap-2 text-sm px-2 py-1.5 rounded hover:bg-surface-hover"
                        >
                          <input type="checkbox" class="accent-primary" />
                          <span class="flex-1">date</span>
                          <span class="text-xs text-muted-fg">DATE</span>
                        </label>

                        <!-- JSON/STRUCT 字段示例（增强版） -->
                        <label
                          class="flex items-center gap-2 text-sm px-2 py-1.5 rounded hover:bg-surface-hover group relative"
                        >
                          <input type="checkbox" class="accent-primary" />
                          <i
                            data-lucide="braces"
                            class="w-4 h-4 text-warning"
                          ></i>
                          <span class="flex-1">metadata</span>
                          <span class="text-xs text-muted-fg">JSON</span>
                          <button
                            class="opacity-0 group-hover:opacity-100 text-primary hover:bg-primary/10 p-1 rounded transition-opacity"
                            onclick="event.preventDefault(); event.stopPropagation(); openJsonConfigurator('metadata')"
                            title="展开 JSON 字段"
                          >
                            <i data-lucide="settings" class="w-3.5 h-3.5"></i>
                          </button>
                        </label>

                        <label
                          class="flex items-center gap-2 text-sm px-2 py-1.5 rounded hover:bg-surface-hover"
                        >
                          <input type="checkbox" class="accent-primary" />
                          <span class="flex-1">status</span>
                          <span class="text-xs text-muted-fg">VARCHAR</span>
                        </label>
                      </div>

                      <!-- JSON 字段选择器弹窗 -->
                      <div
                        id="json-field-selector"
                        class="fixed bg-surface border border-border rounded-lg shadow-2xl"
                        style="display: none; width: 400px; z-index: 1060;"
                      >
                        <div class="p-4">
                          <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold">
                              选择 metadata 字段
                            </h3>
                            <button
                              class="px-1.5 py-0.5 rounded hover:bg-surface-hover"
                              onclick="toggleJsonFieldSelector()"
                            >
                              <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                          </div>

                          <div class="space-y-2 mb-3">
                            <label
                              class="flex items-center gap-2 text-xs px-2 py-1.5 rounded hover:bg-surface-hover border border-border"
                            >
                              <input type="checkbox" class="accent-primary" />
                              <span class="flex-1 font-mono"
                                >metadata.user_id</span
                              >
                              <span class="text-xs text-muted-fg">INTEGER</span>
                            </label>
                            <label
                              class="flex items-center gap-2 text-xs px-2 py-1.5 rounded hover:bg-surface-hover border border-border"
                            >
                              <input type="checkbox" class="accent-primary" />
                              <span class="flex-1 font-mono"
                                >metadata.timestamp</span
                              >
                              <span class="text-xs text-muted-fg"
                                >TIMESTAMP</span
                              >
                            </label>
                            <label
                              class="flex items-center gap-2 text-xs px-2 py-1.5 rounded hover:bg-surface-hover border border-border"
                            >
                              <input type="checkbox" class="accent-primary" />
                              <span class="flex-1 font-mono"
                                >metadata.tags</span
                              >
                              <span class="text-xs text-muted-fg">ARRAY</span>
                            </label>
                            <label
                              class="flex items-center gap-2 text-xs px-2 py-1.5 rounded hover:bg-surface-hover border border-border"
                            >
                              <input type="checkbox" class="accent-primary" />
                              <span class="flex-1 font-mono"
                                >metadata.source</span
                              >
                              <span class="text-xs text-muted-fg">VARCHAR</span>
                            </label>
                          </div>

                          <div
                            class="p-2 bg-muted/50 rounded text-xs text-muted-fg"
                          >
                            <i
                              data-lucide="info"
                              class="w-3 h-3 inline mr-1"
                            ></i>
                            使用点号访问嵌套字段，如
                            <code class="px-1 py-0.5 bg-surface rounded"
                              >metadata.user_id</code
                            >
                          </div>

                          <div class="flex gap-2 mt-3">
                            <button
                              class="flex-1 px-3 py-2 text-xs rounded border border-border hover:bg-surface-hover"
                              onclick="toggleJsonFieldSelector()"
                            >
                              取消
                            </button>
                            <button
                              class="flex-1 px-3 py-2 text-xs rounded bg-primary text-primary-foreground hover:opacity-90"
                              onclick="toggleJsonFieldSelector()"
                            >
                              确定
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 计算字段内容区 -->
                    <div
                      id="content-calculated"
                      class="query-mode-content"
                      style="display: none;"
                    >
                      <div class="mb-4">
                        <h3
                          class="text-base font-semibold flex items-center gap-2"
                        >
                          <i
                            data-lucide="function-square"
                            class="w-5 h-5 text-primary"
                          ></i>
                          计算字段
                        </h3>
                        <p class="text-sm text-muted-fg mt-1">
                          创建自定义计算列（公式运算、条件逻辑、窗口函数）
                        </p>
                      </div>

                      <!-- 模式切换 -->
                      <div class="flex gap-2 mb-4 p-1 bg-muted/30 rounded-lg">
                        <button
                          class="flex-1 px-3 py-2 text-sm rounded-md transition-all calc-mode-btn bg-surface shadow-sm text-foreground"
                          onclick="switchCalcMode('formula')"
                          id="calc-mode-formula"
                        >
                          <i
                            data-lucide="calculator"
                            class="w-4 h-4 inline mr-1"
                          ></i>
                          组合运算
                        </button>
                        <button
                          class="flex-1 px-3 py-2 text-sm rounded-md transition-all calc-mode-btn text-muted-fg"
                          onclick="switchCalcMode('case')"
                          id="calc-mode-case"
                        >
                          <i
                            data-lucide="split"
                            class="w-4 h-4 inline mr-1"
                          ></i>
                          CASE WHEN
                        </button>
                        <button
                          class="flex-1 px-3 py-2 text-sm rounded-md transition-all calc-mode-btn text-muted-fg"
                          onclick="switchCalcMode('window')"
                          id="calc-mode-window"
                        >
                          <i
                            data-lucide="trending-up"
                            class="w-4 h-4 inline mr-1"
                          ></i>
                          窗口函数
                        </button>
                      </div>

                      <!-- 组合运算模式 -->
                      <div id="calc-content-formula" class="space-y-3">
                        <div
                          class="text-xs text-muted-fg mb-2 flex items-center gap-1"
                        >
                          <i data-lucide="info" class="w-3 h-3"></i>
                          对数值字段进行加减乘除运算
                        </div>

                        <!-- 示例计算字段 -->
                        <div
                          class="border border-border rounded-lg p-4 bg-muted/10"
                        >
                          <div class="flex items-center gap-2 mb-3">
                            <input
                              type="text"
                              placeholder="字段名称（如：total_price）"
                              class="duck-input flex-1"
                              value="total_price"
                            />
                            <button
                              class="text-error hover:bg-error/10 p-2 rounded transition-colors"
                              title="删除"
                            >
                              <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                          </div>

                          <div class="flex items-center gap-2">
                            <select class="duck-input flex-1">
                              <option value="">选择列</option>
                              <option selected>price</option>
                              <option>quantity</option>
                              <option>discount</option>
                            </select>
                            <select
                              class="duck-input w-16 text-center font-bold"
                            >
                              <option>*</option>
                              <option>+</option>
                              <option>-</option>
                              <option>/</option>
                            </select>
                            <select class="duck-input flex-1">
                              <option value="">选择列</option>
                              <option>price</option>
                              <option selected>quantity</option>
                              <option>discount</option>
                            </select>
                          </div>

                          <div class="mt-3 pt-3 border-t border-border">
                            <div class="text-xs text-muted-fg mb-1">
                              SQL 预览：
                            </div>
                            <code
                              class="text-xs font-mono text-foreground bg-muted/50 px-2 py-1 rounded block"
                            >
                              price * quantity AS total_price
                            </code>
                          </div>
                        </div>

                        <button
                          class="w-full py-2.5 border-2 border-dashed border-primary/50 text-primary rounded-lg hover:bg-primary/5 transition-colors flex items-center justify-center gap-2"
                        >
                          <i data-lucide="plus" class="w-4 h-4"></i>
                          添加组合运算字段
                        </button>
                      </div>

                      <!-- CASE WHEN 模式 -->
                      <div
                        id="calc-content-case"
                        class="space-y-3"
                        style="display: none;"
                      >
                        <div
                          class="text-xs text-muted-fg mb-2 flex items-center gap-1"
                        >
                          <i data-lucide="info" class="w-3 h-3"></i>
                          根据条件返回不同的值
                        </div>

                        <!-- 示例 CASE 字段 -->
                        <div
                          class="border border-border rounded-lg p-4 bg-muted/10"
                        >
                          <div class="flex items-center gap-2 mb-3">
                            <input
                              type="text"
                              placeholder="字段名称（如：price_level）"
                              class="duck-input flex-1"
                              value="price_level"
                            />
                            <button
                              class="text-error hover:bg-error/10 p-2 rounded"
                              title="删除"
                            >
                              <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                          </div>

                          <div class="space-y-2">
                            <!-- WHEN 条件 1 -->
                            <div
                              class="border border-border/50 rounded p-3 bg-surface"
                            >
                              <div
                                class="text-xs font-medium text-muted-fg mb-2"
                              >
                                WHEN 条件 1
                              </div>
                              <div class="flex items-center gap-2 mb-2">
                                <select class="duck-input flex-1">
                                  <option selected>price</option>
                                  <option>amount</option>
                                </select>
                                <select class="duck-input w-20">
                                  <option>&gt;</option>
                                  <option>&lt;</option>
                                  <option>=</option>
                                  <option>&gt;=</option>
                                  <option>&lt;=</option>
                                </select>
                                <input
                                  type="text"
                                  class="duck-input w-24"
                                  value="1000"
                                  placeholder="值"
                                />
                              </div>
                              <div class="flex items-center gap-2">
                                <span
                                  class="text-xs text-muted-fg whitespace-nowrap"
                                  >THEN 返回：</span
                                >
                                <input
                                  type="text"
                                  class="duck-input flex-1"
                                  value="'高价'"
                                  placeholder="结果值"
                                />
                              </div>
                            </div>

                            <!-- WHEN 条件 2 -->
                            <div
                              class="border border-border/50 rounded p-3 bg-surface"
                            >
                              <div
                                class="text-xs font-medium text-muted-fg mb-2"
                              >
                                WHEN 条件 2
                              </div>
                              <div class="flex items-center gap-2 mb-2">
                                <select class="duck-input flex-1">
                                  <option selected>price</option>
                                  <option>amount</option>
                                </select>
                                <select class="duck-input w-20">
                                  <option selected>&gt;</option>
                                  <option>&lt;</option>
                                  <option>=</option>
                                </select>
                                <input
                                  type="text"
                                  class="duck-input w-24"
                                  value="500"
                                  placeholder="值"
                                />
                              </div>
                              <div class="flex items-center gap-2">
                                <span
                                  class="text-xs text-muted-fg whitespace-nowrap"
                                  >THEN 返回：</span
                                >
                                <input
                                  type="text"
                                  class="duck-input flex-1"
                                  value="'中价'"
                                  placeholder="结果值"
                                />
                              </div>
                            </div>

                            <!-- ELSE 默认值 -->
                            <div
                              class="border border-primary/20 rounded p-3 bg-primary/5"
                            >
                              <div class="flex items-center gap-2">
                                <span
                                  class="text-xs font-medium text-foreground whitespace-nowrap"
                                  >ELSE 默认：</span
                                >
                                <input
                                  type="text"
                                  class="duck-input flex-1"
                                  value="'低价'"
                                  placeholder="默认结果值"
                                />
                              </div>
                            </div>

                            <button
                              class="w-full py-2 border border-dashed border-border text-sm text-muted-fg hover:text-foreground hover:border-primary/50 rounded"
                            >
                              <i
                                data-lucide="plus"
                                class="w-4 h-4 inline mr-1"
                              ></i>
                              添加 WHEN 条件
                            </button>
                          </div>

                          <div class="mt-3 pt-3 border-t border-border">
                            <div class="text-xs text-muted-fg mb-1">
                              SQL 预览：
                            </div>
                            <code
                              class="text-xs font-mono text-foreground bg-muted/50 px-2 py-1 rounded block overflow-x-auto"
                            >
                              CASE WHEN price > 1000 THEN '高价' WHEN price >
                              500 THEN '中价' ELSE '低价' END AS price_level
                            </code>
                          </div>
                        </div>

                        <button
                          class="w-full py-2.5 border-2 border-dashed border-primary/50 text-primary rounded-lg hover:bg-primary/5"
                        >
                          <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                          添加 CASE WHEN 字段
                        </button>
                      </div>

                      <!-- 窗口函数模式 -->
                      <div
                        id="calc-content-window"
                        class="space-y-3"
                        style="display: none;"
                      >
                        <div
                          class="text-xs text-muted-fg mb-2 flex items-center gap-1"
                        >
                          <i data-lucide="info" class="w-3 h-3"></i>
                          在分组内计算排名、累计值等
                        </div>

                        <!-- 示例窗口函数字段 -->
                        <div
                          class="border border-border rounded-lg p-4 bg-muted/10"
                        >
                          <div class="flex items-center gap-2 mb-3">
                            <input
                              type="text"
                              placeholder="字段名称（如：row_num）"
                              class="duck-input flex-1"
                              value="sales_rank"
                            />
                            <button
                              class="text-error hover:bg-error/10 p-2 rounded"
                              title="删除"
                            >
                              <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                          </div>

                          <div class="space-y-3">
                            <!-- 窗口函数选择 -->
                            <div>
                              <label class="text-xs font-medium mb-1 block"
                                >窗口函数</label
                              >
                              <select class="duck-input">
                                <option value="ROW_NUMBER"
                                  >ROW_NUMBER() - 行号</option
                                >
                                <option value="RANK" selected
                                  >RANK() - 排名（有间隔）</option
                                >
                                <option value="DENSE_RANK"
                                  >DENSE_RANK() - 密集排名</option
                                >
                                <option value="SUM">SUM() - 累计求和</option>
                                <option value="AVG">AVG() - 累计平均</option>
                                <option value="LAG">LAG() - 上一行值</option>
                                <option value="LEAD">LEAD() - 下一行值</option>
                              </select>
                            </div>

                            <!-- PARTITION BY -->
                            <div>
                              <label class="text-xs font-medium mb-1 block">
                                分组列 (PARTITION BY)
                                <span class="text-muted-fg font-normal"
                                  >- 可选</span
                                >
                              </label>
                              <select class="duck-input" multiple size="3">
                                <option selected>category</option>
                                <option>region</option>
                                <option>product_id</option>
                              </select>
                              <div class="text-xs text-muted-fg mt-1">
                                按住 Ctrl/Cmd 多选
                              </div>
                            </div>

                            <!-- ORDER BY -->
                            <div>
                              <label class="text-xs font-medium mb-1 block">
                                排序列 (ORDER BY)
                                <span class="text-error">*</span>
                              </label>
                              <div class="flex gap-2">
                                <select class="duck-input flex-1">
                                  <option>date</option>
                                  <option selected>amount</option>
                                  <option>created_at</option>
                                </select>
                                <select class="duck-input w-24">
                                  <option>ASC</option>
                                  <option selected>DESC</option>
                                </select>
                              </div>
                            </div>
                          </div>

                          <div class="mt-3 pt-3 border-t border-border">
                            <div class="text-xs text-muted-fg mb-1">
                              SQL 预览：
                            </div>
                            <code
                              class="text-xs font-mono text-foreground bg-muted/50 px-2 py-1 rounded block overflow-x-auto"
                            >
                              RANK() OVER (PARTITION BY category ORDER BY amount
                              DESC) AS sales_rank
                            </code>
                          </div>
                        </div>

                        <button
                          class="w-full py-2.5 border-2 border-dashed border-primary/50 text-primary rounded-lg hover:bg-primary/5"
                        >
                          <i data-lucide="plus" class="w-4 h-4 inline mr-1"></i>
                          添加窗口函数字段
                        </button>
                      </div>
                    </div>

                    <!-- 筛选条件模式 -->
                    <div
                      id="content-filter"
                      class="query-mode-content"
                      style="display: none;"
                    >
                      <div class="mb-4">
                        <h3
                          class="text-base font-semibold flex items-center gap-2"
                        >
                          <i
                            data-lucide="filter"
                            class="w-5 h-5 text-primary"
                          ></i>
                          筛选条件
                        </h3>
                        <p class="text-sm text-muted-fg mt-1">
                          添加 WHERE 条件过滤数据
                        </p>
                      </div>

                      <!-- 条件 1: 固定值模式 -->
                      <div class="flex gap-2 mb-2">
                        <select class="duck-input flex-1">
                          <option>amount</option>
                          <option>name</option>
                          <option>date</option>
                        </select>
                        <select class="duck-input w-24">
                          <option>></option>
                          <option>=</option>
                          <option>&lt;</option>
                          <option>>=</option>
                        </select>

                        <!-- 值类型选择器 -->
                        <select
                          class="duck-input w-32"
                          id="valueType1"
                          onchange="switchValueType(1, this.value)"
                        >
                          <option value="fixed">固定值</option>
                          <option value="column">对比列</option>
                          <option value="expression">表达式</option>
                        </select>

                        <!-- 固定值输入 -->
                        <input
                          type="text"
                          class="duck-input flex-1"
                          placeholder="1000"
                          value="1000"
                          id="fixedValue1"
                        />

                        <!-- 列选择器（默认隐藏）-->
                        <select
                          class="duck-input flex-1"
                          id="columnValue1"
                          style="display: none;"
                        >
                          <option>price</option>
                          <option>cost</option>
                          <option>discount</option>
                          <option>tax</option>
                        </select>

                        <!-- 表达式输入（默认隐藏）-->
                        <input
                          type="text"
                          class="duck-input flex-1"
                          placeholder="price * 1.1 + tax"
                          id="expressionValue1"
                          style="display: none;"
                        />

                        <!-- 类型转换按钮 -->
                        <button
                          class="px-3 py-2 text-xs rounded-md border border-border hover:bg-surface-hover"
                          title="类型转换"
                          onclick="toggleTypeCast(1)"
                        >
                          <i data-lucide="repeat" class="w-4 h-4"></i>
                        </button>

                        <button
                          class="px-3 py-2 text-xs rounded-md border border-border hover:bg-surface-hover"
                          title="添加条件"
                        >
                          <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                        <button
                          class="px-3 py-2 text-xs rounded-md border border-border hover:bg-surface-hover text-red-400"
                          title="删除条件"
                        >
                          <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                      </div>

                      <!-- 条件 2: 列对列比较示例 -->
                      <div class="flex gap-2 mb-2">
                        <select class="duck-input flex-1">
                          <option>amount</option>
                          <option selected>price</option>
                          <option>date</option>
                        </select>
                        <select class="duck-input w-24">
                          <option>></option>
                          <option>=</option>
                          <option>&lt;</option>
                          <option selected>!=</option>
                        </select>

                        <!-- 值类型选择器 -->
                        <select
                          class="duck-input w-32"
                          id="valueType2"
                          onchange="switchValueType(2, this.value)"
                        >
                          <option value="fixed">固定值</option>
                          <option value="column" selected>对比列</option>
                          <option value="expression">表达式</option>
                        </select>

                        <!-- 固定值输入（隐藏）-->
                        <input
                          type="text"
                          class="duck-input flex-1"
                          placeholder="输入值"
                          id="fixedValue2"
                          style="display: none;"
                        />

                        <!-- 列选择器 -->
                        <select class="duck-input flex-1" id="columnValue2">
                          <option>amount</option>
                          <option selected>cost</option>
                          <option>discount</option>
                          <option>tax</option>
                        </select>

                        <!-- 表达式输入（隐藏）-->
                        <input
                          type="text"
                          class="duck-input flex-1"
                          placeholder="price * 1.1 + tax"
                          id="expressionValue2"
                          style="display: none;"
                        />

                        <!-- 类型转换按钮 -->
                        <button
                          class="px-3 py-2 text-xs rounded-md border border-border hover:bg-surface-hover"
                          title="类型转换"
                          onclick="toggleTypeCast(2)"
                        >
                          <i data-lucide="repeat" class="w-4 h-4"></i>
                        </button>

                        <button
                          class="px-3 py-2 text-xs rounded-md border border-border hover:bg-surface-hover"
                          title="添加条件"
                        >
                          <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                        <button
                          class="px-3 py-2 text-xs rounded-md border border-border hover:bg-surface-hover text-red-400"
                          title="删除条件"
                        >
                          <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                      </div>

                      <!-- 条件 3: 表达式示例 -->
                      <div class="flex gap-2">
                        <select class="duck-input flex-1">
                          <option>amount</option>
                          <option>price</option>
                          <option selected>total</option>
                        </select>
                        <select class="duck-input w-24">
                          <option selected>></option>
                          <option>=</option>
                          <option>&lt;</option>
                          <option>>=</option>
                        </select>

                        <!-- 值类型选择器 -->
                        <select
                          class="duck-input w-32"
                          id="valueType3"
                          onchange="switchValueType(3, this.value)"
                        >
                          <option value="fixed">固定值</option>
                          <option value="column">对比列</option>
                          <option value="expression" selected>表达式</option>
                        </select>

                        <!-- 固定值输入（隐藏）-->
                        <input
                          type="text"
                          class="duck-input flex-1"
                          placeholder="输入值"
                          id="fixedValue3"
                          style="display: none;"
                        />

                        <!-- 列选择器（隐藏）-->
                        <select
                          class="duck-input flex-1"
                          id="columnValue3"
                          style="display: none;"
                        >
                          <option>price</option>
                          <option>cost</option>
                          <option>discount</option>
                          <option>tax</option>
                        </select>

                        <!-- 表达式输入 -->
                        <input
                          type="text"
                          class="duck-input flex-1"
                          placeholder="price * 1.1 + tax"
                          value="(price + tax) * 1.2"
                          id="expressionValue3"
                        />

                        <!-- 类型转换按钮 -->
                        <button
                          class="px-3 py-2 text-xs rounded-md border border-border hover:bg-surface-hover"
                          title="类型转换"
                          onclick="toggleTypeCast(3)"
                        >
                          <i data-lucide="repeat" class="w-4 h-4"></i>
                        </button>

                        <button
                          class="px-3 py-2 text-xs rounded-md border border-border hover:bg-surface-hover"
                          title="添加条件"
                        >
                          <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                        <button
                          class="px-3 py-2 text-xs rounded-md border border-border hover:bg-surface-hover text-red-400"
                          title="删除条件"
                        >
                          <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                      </div>

                      <!-- 高级选项提示 -->
                      <div
                        class="mt-3 p-2 bg-muted rounded text-xs text-muted-fg flex items-start gap-2"
                      >
                        <i
                          data-lucide="info"
                          class="w-3.5 h-3.5 flex-shrink-0 mt-0.5"
                        ></i>
                        <div>
                          <strong class="text-foreground">高级筛选模式:</strong>
                          支持固定值、列对列比较、表达式三种模式。表达式支持算术运算（+,
                          -, *, /）和函数调用。点击
                          <i data-lucide="repeat" class="w-3 h-3 inline"></i>
                          图标可进行 DuckDB 类型转换。
                        </div>
                      </div>
                    </div>

                    <!-- 类型转换弹窗 -->
                    <div
                      id="type-cast-popup"
                      class="fixed bg-surface border border-border rounded-lg shadow-2xl"
                      style="display: none; width: 320px; z-index: 1060;"
                    >
                      <div class="p-4">
                        <div class="flex items-center justify-between mb-3">
                          <h3 class="text-sm font-semibold">DuckDB 类型转换</h3>
                          <button
                            class="px-1.5 py-0.5 rounded hover:bg-surface-hover"
                            onclick="closeTypeCast()"
                          >
                            <i data-lucide="x" class="w-4 h-4"></i>
                          </button>
                        </div>

                        <div class="space-y-3">
                          <!-- 转换方式 -->
                          <div>
                            <label class="block text-xs font-medium mb-1.5"
                              >转换方式</label
                            >
                            <select class="duck-input text-xs" id="cast-method">
                              <option value="try_cast"
                                >TRY_CAST (推荐，失败返回NULL)</option
                              >
                              <option value="cast">CAST (失败报错)</option>
                              <option value="suffix"
                                >::类型 (DuckDB语法)</option
                              >
                            </select>
                          </div>

                          <!-- 目标类型 -->
                          <div>
                            <label class="block text-xs font-medium mb-1.5"
                              >目标类型</label
                            >
                            <select
                              class="duck-input text-xs"
                              id="cast-target-type"
                            >
                              <optgroup label="数值类型">
                                <option value="INTEGER"
                                  >INTEGER (32位整数)</option
                                >
                                <option value="BIGINT"
                                  >BIGINT (64位整数)</option
                                >
                                <option value="DOUBLE">DOUBLE (浮点数)</option>
                                <option value="DECIMAL"
                                  >DECIMAL (精确数值)</option
                                >
                              </optgroup>
                              <optgroup label="文本类型">
                                <option value="VARCHAR">VARCHAR (文本)</option>
                              </optgroup>
                              <optgroup label="日期/时间">
                                <option value="DATE">DATE (日期)</option>
                                <option value="TIMESTAMP"
                                  >TIMESTAMP (时间戳)</option
                                >
                              </optgroup>
                              <optgroup label="其他">
                                <option value="BOOLEAN"
                                  >BOOLEAN (布尔值)</option
                                >
                              </optgroup>
                            </select>
                          </div>

                          <!-- 预览 -->
                          <div>
                            <label class="block text-xs font-medium mb-1.5"
                              >转换预览</label
                            >
                            <div class="code-block text-xs" id="cast-preview">
                              TRY_CAST(amount AS INTEGER)
                            </div>
                          </div>

                          <!-- 说明 -->
                          <div
                            class="p-2 bg-muted/50 rounded text-xs text-muted-fg"
                          >
                            <div class="flex items-start gap-1.5">
                              <i
                                data-lucide="info"
                                class="w-3 h-3 flex-shrink-0 mt-0.5"
                              ></i>
                              <div>
                                <strong>TRY_CAST</strong> 在转换失败时返回
                                NULL，不会中断查询。适合处理脏数据。
                              </div>
                            </div>
                          </div>

                          <!-- 操作按钮 -->
                          <div class="flex gap-2">
                            <button
                              class="flex-1 px-3 py-2 text-xs rounded border border-border hover:bg-surface-hover"
                              onclick="closeTypeCast()"
                            >
                              取消
                            </button>
                            <button
                              class="flex-1 px-3 py-2 text-xs rounded bg-primary text-primary-foreground hover:opacity-90"
                              onclick="applyTypeCast()"
                            >
                              应用转换
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 分组聚合模式 -->
                    <div
                      id="content-group"
                      class="query-mode-content"
                      style="display: none;"
                    >
                      <div class="mb-4">
                        <h3
                          class="text-base font-semibold flex items-center gap-2"
                        >
                          <i
                            data-lucide="layers"
                            class="w-5 h-5 text-primary"
                          ></i>
                          分组与聚合
                        </h3>
                        <p class="text-sm text-muted-fg mt-1">
                          按列分组并计算聚合函数
                        </p>
                      </div>

                      <!-- 分组字段 -->
                      <div class="mb-4">
                        <label class="block text-sm font-medium mb-2"
                          >分组字段 (GROUP BY)</label
                        >
                        <div class="flex flex-wrap gap-2">
                          <button
                            class="px-3 py-1.5 text-xs rounded-md border border-border bg-muted/30 hover:bg-surface-hover flex items-center gap-1.5"
                          >
                            <span>category</span>
                            <i data-lucide="x" class="w-3 h-3"></i>
                          </button>
                          <button
                            class="px-3 py-1.5 text-xs rounded-md border border-dashed border-border hover:bg-surface-hover text-muted-fg"
                          >
                            <i
                              data-lucide="plus"
                              class="w-3 h-3 inline mr-1"
                            ></i>
                            添加分组
                          </button>
                        </div>
                      </div>

                      <!-- 聚合函数 -->
                      <div class="mb-4">
                        <label class="block text-sm font-medium mb-2"
                          >聚合函数</label
                        >
                        <div class="space-y-2">
                          <div class="flex gap-2">
                            <select class="duck-input flex-1">
                              <option selected>SUM</option>
                              <option>AVG</option>
                              <option>COUNT</option>
                              <option>MAX</option>
                              <option>MIN</option>
                            </select>
                            <select class="duck-input flex-1">
                              <option selected>amount</option>
                              <option>price</option>
                              <option>quantity</option>
                            </select>
                            <input
                              type="text"
                              class="duck-input w-32"
                              placeholder="别名"
                              value="total_amount"
                            />
                            <button
                              class="px-3 py-2 text-xs rounded-md border border-border hover:bg-surface-hover"
                            >
                              <i data-lucide="plus" class="w-4 h-4"></i>
                            </button>
                            <button
                              class="px-3 py-2 text-xs rounded-md border border-border hover:bg-surface-hover text-red-400"
                            >
                              <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                          </div>
                        </div>
                      </div>

                      <!-- HAVING 条件 -->
                      <div>
                        <label class="block text-sm font-medium mb-2"
                          >聚合筛选 (HAVING)</label
                        >
                        <div class="flex gap-2">
                          <select class="duck-input flex-1">
                            <option selected>total_amount</option>
                            <option>record_count</option>
                          </select>
                          <select class="duck-input w-24">
                            <option selected>></option>
                            <option>=</option>
                            <option>&lt;</option>
                          </select>
                          <input
                            type="text"
                            class="duck-input flex-1"
                            placeholder="值"
                            value="10000"
                          />
                          <button
                            class="px-3 py-2 text-xs rounded-md border border-border hover:bg-surface-hover"
                          >
                            <i data-lucide="plus" class="w-4 h-4"></i>
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- 排序模式 -->
                    <div
                      id="content-order"
                      class="query-mode-content"
                      style="display: none;"
                    >
                      <div class="mb-4">
                        <h3
                          class="text-base font-semibold flex items-center gap-2"
                        >
                          <i
                            data-lucide="arrow-up-down"
                            class="w-5 h-5 text-primary"
                          ></i>
                          排序
                        </h3>
                        <p class="text-sm text-muted-fg mt-1">
                          指定结果集的排序方式
                        </p>
                      </div>
                      <div class="space-y-2">
                        <div class="flex gap-2">
                          <select class="duck-input flex-1">
                            <option selected>total_amount</option>
                            <option>category</option>
                            <option>name</option>
                          </select>
                          <select class="duck-input w-28">
                            <option selected>降序 (DESC)</option>
                            <option>升序 (ASC)</option>
                          </select>
                          <button
                            class="px-3 py-2 text-xs rounded-md border border-border hover:bg-surface-hover"
                          >
                            <i data-lucide="plus" class="w-4 h-4"></i>
                          </button>
                          <button
                            class="px-3 py-2 text-xs rounded-md border border-border hover:bg-surface-hover text-red-400"
                          >
                            <i data-lucide="x" class="w-4 h-4"></i>
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- 限制结果模式 -->
                    <div
                      id="content-limit"
                      class="query-mode-content"
                      style="display: none;"
                    >
                      <div class="mb-4">
                        <h3
                          class="text-base font-semibold flex items-center gap-2"
                        >
                          <i
                            data-lucide="list"
                            class="w-5 h-5 text-primary"
                          ></i>
                          限制结果数
                        </h3>
                        <p class="text-sm text-muted-fg mt-1">
                          限制返回的记录数量
                        </p>
                      </div>
                      <div class="flex gap-3 items-center">
                        <label class="flex items-center gap-2">
                          <input
                            type="checkbox"
                            checked
                            class="accent-primary"
                          />
                          <span class="text-sm">启用 LIMIT</span>
                        </label>
                        <input
                          type="number"
                          class="duck-input w-24"
                          placeholder="行数"
                          value="100"
                          min="1"
                        />
                        <span class="text-xs text-muted-fg">行</span>
                      </div>
                    </div>

                    <!-- 生成的 SQL (固定在底部，始终显示) -->
                    <div class="mt-4 pt-4 border-t border-border">
                      <label class="block text-sm font-medium mb-2"
                        >生成的 SQL</label
                      >
                      <div class="code-block">
                        <span class="text-purple-400">SELECT</span>
                        category,<br />
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(amount)
                        <span class="text-purple-400">AS</span>
                        total_amount<br />
                        <span class="text-purple-400">FROM</span>
                        sales_data<br />
                        <span class="text-purple-400">WHERE</span> amount >
                        1000<br />
                        &nbsp;&nbsp;<span class="text-purple-400">AND</span>
                        price != cost<br />
                        &nbsp;&nbsp;<span class="text-purple-400">AND</span>
                        total > (price + tax) * 1.2<br />
                        <span class="text-purple-400">GROUP BY</span>
                        category<br />
                        <span class="text-purple-400">HAVING</span>
                        total_amount > 10000<br />
                        <span class="text-purple-400">ORDER BY</span>
                        total_amount <span class="text-purple-400">DESC</span
                        ><br />
                        <span class="text-purple-400">LIMIT</span> 100
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 可拖拽分隔线 -->
              <div class="resizer" id="resizer">
                <button
                  class="collapse-btn"
                  onclick="toggleResultPane(event)"
                  title="折叠/展开结果面板"
                >
                  <i
                    data-lucide="chevron-down"
                    class="w-3 h-3"
                    id="collapse-icon"
                  ></i>
                </button>
              </div>

              <!-- 查询结果面板 -->
              <div
                class="flex flex-col border-t border-border"
                id="result-pane"
                style="height: 400px; flex-shrink: 0;"
              >
                <!-- 数据表格 -->
                <div
                  class="flex flex-col flex-1 min-h-0 overflow-hidden bg-surface"
                >
                  <!-- 结果表格 -->
                  <div class="flex flex-col flex-1 min-h-0 overflow-hidden">
                    <!-- 工具栏 -->
                    <div
                      class="result-toolbar sticky top-0 z-sticky border-t-0"
                    >
                      <i data-lucide="table" class="w-3.5 h-3.5"></i>
                      <span class="font-medium">查询结果</span>
                      <span class="opacity-60">·</span>
                      <span>20 行</span>
                      <span class="opacity-60">·</span>
                      <span>3 列</span>
                      <div class="flex-1"></div>
                      <span class="text-xs opacity-60">执行时间: 0.8s</span>
                      <button
                        class="px-2 py-1 rounded hover:bg-surface text-xs flex items-center gap-1"
                        title="导出"
                      >
                        <i data-lucide="download" class="w-3 h-3"></i>
                      </button>
                      <button
                        class="px-2 py-1 rounded hover:bg-surface text-xs flex items-center gap-1"
                        title="刷新"
                      >
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                      </button>
                    </div>

                    <!-- 表格区域 -->
                    <div
                      class="result-scroll-area overflow-x-auto overflow-y-auto"
                      id="table-container"
                    >
                      <table class="ide-table">
                        <thead>
                          <tr>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i>
                                  col_1
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover opacity-0 group-hover:opacity-100 transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_2
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_3
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_4
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_5
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_6
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_7
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_8
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_9
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_10
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_11
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_12
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_13
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_14
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_15
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_16
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_17
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_18
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_19
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_20
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_21
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_22
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_23
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                            <th>
                              <div
                                class="flex items-center justify-between gap-1"
                              >
                                <div class="flex items-center gap-1">
                                  <i
                                    data-lucide="type"
                                    class="w-3 h-3 opacity-50"
                                  ></i
                                  >col_24
                                </div>
                                <button
                                  class="px-1 py-0.5 rounded hover:bg-surface-hover transition-opacity"
                                  title="筛选"
                                >
                                  <i data-lucide="filter" class="w-3 h-3"></i>
                                </button>
                              </div>
                            </th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td>row1_c1</td>
                            <td>row1_c2</td>
                            <td>row1_c3</td>
                            <td>row1_c4</td>
                            <td>row1_c5</td>
                            <td>row1_c6</td>
                            <td>row1_c7</td>
                            <td>row1_c8</td>
                            <td>row1_c9</td>
                            <td>row1_c10</td>
                            <td>row1_c11</td>
                            <td>row1_c12</td>
                            <td>row1_c13</td>
                            <td>row1_c14</td>
                            <td>row1_c15</td>
                            <td>row1_c16</td>
                            <td>row1_c17</td>
                            <td>row1_c18</td>
                            <td>row1_c19</td>
                            <td>row1_c20</td>
                            <td>row1_c21</td>
                            <td>row1_c22</td>
                            <td>row1_c23</td>
                            <td>row1_c24</td>
                          </tr>
                          <tr>
                            <td>row2_c1</td>
                            <td>row2_c2</td>
                            <td>row2_c3</td>
                            <td>row2_c4</td>
                            <td>row2_c5</td>
                            <td>row2_c6</td>
                            <td>row2_c7</td>
                            <td>row2_c8</td>
                            <td>row2_c9</td>
                            <td>row2_c10</td>
                            <td>row2_c11</td>
                            <td>row2_c12</td>
                            <td>row2_c13</td>
                            <td>row2_c14</td>
                            <td>row2_c15</td>
                            <td>row2_c16</td>
                            <td>row2_c17</td>
                            <td>row2_c18</td>
                            <td>row2_c19</td>
                            <td>row2_c20</td>
                            <td>row2_c21</td>
                            <td>row2_c22</td>
                            <td>row2_c23</td>
                            <td>row2_c24</td>
                          </tr>
                          <tr>
                            <td>row3_c1</td>
                            <td>row3_c2</td>
                            <td>row3_c3</td>
                            <td>row3_c4</td>
                            <td>row3_c5</td>
                            <td>row3_c6</td>
                            <td>row3_c7</td>
                            <td>row3_c8</td>
                            <td>row3_c9</td>
                            <td>row3_c10</td>
                            <td>row3_c11</td>
                            <td>row3_c12</td>
                            <td>row3_c13</td>
                            <td>row3_c14</td>
                            <td>row3_c15</td>
                            <td>row3_c16</td>
                            <td>row3_c17</td>
                            <td>row3_c18</td>
                            <td>row3_c19</td>
                            <td>row3_c20</td>
                            <td>row3_c21</td>
                            <td>row3_c22</td>
                            <td>row3_c23</td>
                            <td>row3_c24</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <!-- Excel 风格列过滤弹窗 -->
                  <div
                    id="column-filter-popup"
                    class="dq-popover z-popover"
                    style="display: none; width: 280px;"
                  >
                    <!-- 弹窗头部 -->
                    <div
                      class="flex items-center justify-between p-3 border-b border-border"
                    >
                      <div class="flex items-center gap-2">
                        <i
                          data-lucide="filter"
                          class="w-4 h-4 text-primary"
                        ></i>
                        <span
                          class="text-sm font-medium"
                          id="filter-column-name"
                          >筛选 amount</span
                        >
                        <span class="text-xs text-muted-fg ml-2"
                          >(当前 100 行)</span
                        >
                        <div class="relative group ml-1">
                          <i
                            data-lucide="info"
                            class="w-3.5 h-3.5 text-muted-fg cursor-help hover:text-foreground transition-colors"
                          ></i>
                          <!-- Tooltip -->
                          <div
                            class="absolute left-1/2 -translate-x-1/2 top-full mt-2 w-64 p-3 bg-[hsl(240,10%,10%)] text-white text-xs rounded-md shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-[1070]"
                            style="line-height: 1.5;"
                          >
                            <div class="font-medium mb-1">💡 快速过滤说明</div>
                            <div>
                              列过滤仅作用于当前显示的结果（前 100 行）。<br />
                              需要全量数据过滤？请使用左侧<strong>"筛选条件"</strong>卡片配置
                              SQL WHERE 子句。
                            </div>
                            <!-- 箭头 -->
                            <div
                              class="absolute left-1/2 -translate-x-1/2 -top-1 w-2 h-2 bg-[hsl(240,10%,10%)] rotate-45"
                            ></div>
                          </div>
                        </div>
                      </div>
                      <button
                        class="px-1.5 py-0.5 rounded hover:bg-surface-hover"
                        onclick="closeColumnFilter()"
                      >
                        <i data-lucide="x" class="w-4 h-4"></i>
                      </button>
                    </div>

                    <!-- 搜索框 -->
                    <div class="p-3 border-b border-border-subtle">
                      <input
                        type="text"
                        class="duck-input"
                        placeholder="搜索值..."
                        id="filter-search-input"
                      />
                    </div>

                    <!-- 快捷操作 -->
                    <div class="p-2 border-b border-border-subtle flex gap-2">
                      <button
                        class="flex-1 px-2 py-1.5 text-xs rounded border border-border hover:bg-surface-hover"
                        onclick="selectAllValues()"
                      >
                        全选
                      </button>
                      <button
                        class="flex-1 px-2 py-1.5 text-xs rounded border border-border hover:bg-surface-hover"
                        onclick="clearAllValues()"
                      >
                        清空
                      </button>
                      <button
                        class="flex-1 px-2 py-1.5 text-xs rounded border border-border hover:bg-surface-hover"
                        onclick="selectUniqueValues()"
                      >
                        唯一值
                      </button>
                    </div>

                    <!-- 值列表 -->
                    <div class="p-2 max-h-64 overflow-auto">
                      <label
                        class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-surface-hover text-sm cursor-pointer"
                      >
                        <input type="checkbox" checked class="accent-primary" />
                        <span>1000</span>
                        <span class="ml-auto text-xs text-muted-fg">(1)</span>
                      </label>
                      <label
                        class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-surface-hover text-sm cursor-pointer"
                      >
                        <input type="checkbox" checked class="accent-primary" />
                        <span>1500</span>
                        <span class="ml-auto text-xs text-muted-fg">(1)</span>
                      </label>
                      <label
                        class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-surface-hover text-sm cursor-pointer"
                      >
                        <input type="checkbox" checked class="accent-primary" />
                        <span>2000</span>
                        <span class="ml-auto text-xs text-muted-fg">(1)</span>
                      </label>
                    </div>

                    <!-- 底部操作按钮 -->
                    <div class="p-3 border-t border-border flex gap-2">
                      <button
                        class="flex-1 px-3 py-2 text-sm rounded border border-border hover:bg-surface-hover"
                        onclick="closeColumnFilter()"
                      >
                        取消
                      </button>
                      <button
                        class="flex-1 px-3 py-2 text-sm rounded bg-primary text-primary-foreground hover:opacity-90"
                        onclick="applyColumnFilter()"
                      >
                        确定
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- ========== visual-content 结束 ========== -->

            <!-- SQL 查询内容 - 与可视化查询一致的结构 -->
            <div
              id="sql-content"
              class="flex flex-1 flex-col overflow-hidden bg-surface"
              style="display: none;"
            >
              <!-- SQL 编辑器区域 -->
              <div class="bg-surface flex flex-col overflow-hidden" id="sql-editor-pane" style="flex: 1; min-height: 0;">
                <!-- 顶部工具栏 -->
                <div class="h-12 px-6 border-b border-border shrink-0 flex items-center justify-between bg-muted/20">
                  <div class="flex items-center gap-3">
                    <i data-lucide="code" class="w-4 h-4 text-primary"></i>
                    <span class="text-sm font-medium">SQL 查询</span>
                    <span class="text-xs text-muted-fg px-2 py-0.5 bg-muted rounded">双击左侧插入表名</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <button class="px-3 py-1.5 text-xs rounded-md border border-border hover:bg-surface-hover">
                      <i data-lucide="file-text" class="w-3 h-3 inline mr-1"></i>
                      模板
                    </button>
                    <button class="px-3 py-1.5 text-xs rounded-md border border-border hover:bg-surface-hover">
                      <i data-lucide="wand-2" class="w-3 h-3 inline mr-1"></i>
                      格式化
                    </button>
                    <button class="px-4 py-1.5 bg-primary text-white rounded-md text-sm font-medium hover:opacity-90 flex items-center gap-1.5">
                      <i data-lucide="play" class="w-3.5 h-3.5"></i>
                      执行
                    </button>
                  </div>
                </div>
                
                <!-- SQL 编辑器内容 -->
                <div class="flex-1 overflow-auto p-6 space-y-4">
                  <!-- SQL 编辑器 -->
                  <div class="flex flex-col">
                    <textarea
                      class="duck-input font-mono text-sm resize-none"
                      placeholder="-- 输入 SQL 查询语句
SELECT * FROM sales_data
WHERE amount > 1000
ORDER BY date DESC
LIMIT 100;"
                      style="min-height: 300px;"
                    >SELECT name, amount, date
FROM sales_data
WHERE amount > 1000
  AND date >= '2024-01-01'
ORDER BY amount DESC
LIMIT 100;</textarea>
                  </div>

                  <!-- 快捷操作 -->
                  <div class="flex items-center gap-3">
                    <button class="px-4 py-2 border border-border rounded-md text-sm font-medium hover:bg-surface-hover flex items-center gap-2">
                      <i data-lucide="save" class="w-4 h-4"></i>
                      保存查询
                    </button>
                    <button class="px-4 py-2 border border-border rounded-md text-sm font-medium hover:bg-surface-hover flex items-center gap-2">
                      <i data-lucide="eye" class="w-4 h-4"></i>
                      查询计划
                    </button>
                    <div class="flex-1"></div>
                    <div class="text-xs text-muted-fg">
                      <i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                      支持 DuckDB SQL 语法
                    </div>
                  </div>

                  <!-- 查询历史 -->
                  <div>
                    <label class="text-sm font-semibold mb-2 block">查询历史</label>
                    <div class="space-y-2">
                      <div class="p-3 rounded-lg border border-border bg-muted/30 hover:border-primary/50 cursor-pointer transition-colors">
                        <div class="flex items-start justify-between mb-1">
                          <code class="text-xs font-mono text-foreground">SELECT * FROM sales_data WHERE...</code>
                          <span class="text-xs text-muted-fg">2 分钟前</span>
                        </div>
                        <div class="flex items-center gap-3 text-xs text-muted-fg">
                          <span>✓ 成功</span>
                          <span>100 行</span>
                          <span>0.3s</span>
                        </div>
                      </div>
                      <div class="p-3 rounded-lg border border-border bg-muted/30 hover:border-primary/50 cursor-pointer transition-colors">
                        <div class="flex items-start justify-between mb-1">
                          <code class="text-xs font-mono text-foreground">SELECT category, SUM(amount)...</code>
                          <span class="text-xs text-muted-fg">5 分钟前</span>
                        </div>
                        <div class="flex items-center gap-3 text-xs text-muted-fg">
                          <span>✓ 成功</span>
                          <span>12 行</span>
                          <span>0.1s</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 可拖拽分隔线 -->
              <div class="resizer" id="sql-resizer">
                <button class="collapse-btn" onclick="toggleSqlResultPane(event)" title="折叠/展开结果面板">
                  <i data-lucide="chevron-down" class="w-3 h-3" id="sql-collapse-icon"></i>
                </button>
              </div>

              <!-- SQL 查询结果面板 -->
              <div class="flex flex-col border-t border-border" id="sql-result-pane" style="height: 300px; flex-shrink: 0;">
                <div class="flex flex-col flex-1 min-h-0 overflow-hidden bg-surface">
                  <div class="flex flex-col flex-1 min-h-0 overflow-hidden">
                    <!-- 工具栏 -->
                    <div class="result-toolbar sticky top-0 z-sticky border-t-0">
                      <i data-lucide="table" class="w-3.5 h-3.5"></i>
                      <span class="font-medium">查询结果</span>
                      <span class="opacity-60">·</span>
                      <span>100 行</span>
                      <span class="opacity-60">·</span>
                      <span>3 列</span>
                      <div class="flex-1"></div>
                      <span class="text-xs opacity-60">执行时间: 0.3s</span>
                      <button class="px-2 py-1 rounded hover:bg-surface text-xs flex items-center gap-1" title="导出">
                        <i data-lucide="download" class="w-3 h-3"></i>
                      </button>
                      <button class="px-2 py-1 rounded hover:bg-surface text-xs flex items-center gap-1" title="刷新">
                        <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                      </button>
                    </div>

                    <!-- 表格区域 -->
                    <div class="result-scroll-area overflow-x-auto overflow-y-auto">
                      <table class="ide-table">
                        <thead>
                          <tr>
                            <th>name</th>
                            <th>amount</th>
                            <th>date</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr><td>订单A</td><td>2500</td><td>2024-01-15</td></tr>
                          <tr><td>订单B</td><td>1800</td><td>2024-01-16</td></tr>
                          <tr><td>订单C</td><td>3200</td><td>2024-01-17</td></tr>
                          <tr><td>订单D</td><td>1500</td><td>2024-01-18</td></tr>
                          <tr><td>订单E</td><td>2100</td><td>2024-01-19</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 关联查询内容 - 新版横向卡片布局 -->
            <div
              id="join-content"
              class="flex flex-1 flex-col overflow-hidden bg-surface"
              style="display: none;"
            >
              <!-- 查询配置区域 -->
              <div class="bg-surface flex flex-col overflow-hidden" id="join-config-pane" style="flex: 1; min-height: 0;">
                <!-- 顶部工具栏 -->
                <div class="h-12 px-6 border-b border-border shrink-0 flex items-center justify-between bg-muted/20">
                  <div class="flex items-center gap-3">
                    <i data-lucide="git-merge" class="w-4 h-4 text-primary"></i>
                    <span class="text-sm font-medium">关联查询</span>
                    <span class="text-xs text-muted-fg px-2 py-0.5 bg-muted rounded">双击左侧数据源添加表</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <button onclick="clearJoinTables()" class="px-3 py-1.5 text-xs rounded-md border border-border hover:bg-surface-hover text-muted-fg">
                      <i data-lucide="trash-2" class="w-3 h-3 inline mr-1"></i>
                      清空
                    </button>
                    <button class="px-4 py-1.5 bg-primary text-white rounded-md text-sm font-medium hover:opacity-90 flex items-center gap-1.5">
                      <i data-lucide="play" class="w-3.5 h-3.5"></i>
                      执行
                    </button>
                  </div>
                </div>

                <!-- 横向数据源卡片区域 -->
                <div class="flex-1 overflow-auto p-6">
                <!-- 已选择的表卡片 - 横向排列 -->
                <div id="join-tables-container" class="flex items-start gap-4 min-h-[300px] pb-4">
                  <!-- 空状态提示 -->
                  <div id="join-empty-state" class="flex-1 flex flex-col items-center justify-center text-center py-12 border-2 border-dashed border-border rounded-xl">
                    <i data-lucide="git-merge" class="w-12 h-12 text-muted-fg mb-4"></i>
                    <h3 class="text-sm font-medium mb-2">开始关联查询</h3>
                    <p class="text-xs text-muted-fg max-w-xs">
                      双击左侧数据源面板中的表来添加到关联查询。<br/>
                      第一个添加的表将作为主表。
                    </p>
                  </div>
                </div>

                <!-- 生成的 SQL 预览 -->
                <div id="join-sql-preview" class="mt-4 hidden">
                  <div class="flex items-center justify-between mb-2">
                    <label class="text-sm font-medium flex items-center gap-2">
                      <i data-lucide="code" class="w-4 h-4 text-primary"></i>
                      生成的 SQL
                    </label>
                    <button class="text-xs text-primary hover:underline">复制</button>
                  </div>
                  <div class="code-block text-xs" id="join-sql-code">
                    <span class="text-purple-400">SELECT</span> *<br/>
                    <span class="text-purple-400">FROM</span> <span id="join-sql-tables">...</span>
                  </div>
                </div>

              </div>
              </div>

              <!-- 可拖拽分隔线 -->
              <div class="resizer" id="join-resizer">
                <button
                  class="collapse-btn"
                  onclick="toggleJoinResultPane(event)"
                  title="折叠/展开结果面板"
                >
                  <i
                    data-lucide="chevron-down"
                    class="w-3 h-3"
                    id="join-collapse-icon"
                  ></i>
                </button>
              </div>

              <!-- 查询结果面板 -->
              <div
                class="flex flex-col border-t border-border"
                id="join-result-pane"
                style="height: 300px; flex-shrink: 0;"
              >
                <div class="flex flex-col flex-1 min-h-0 overflow-hidden bg-surface">
                  <div class="flex flex-col flex-1 min-h-0 overflow-hidden">
                    <!-- 工具栏 -->
                    <div class="result-toolbar sticky top-0 z-sticky border-t-0">
                      <i data-lucide="table" class="w-3.5 h-3.5"></i>
                      <span class="font-medium">查询结果</span>
                      <span class="opacity-60">·</span>
                      <span>3 行</span>
                      <span class="opacity-60">·</span>
                      <span>5 列</span>
                      <div class="flex-1"></div>
                      <span class="text-xs opacity-60">执行时间: 0.5s</span>
                      <button
                        class="px-2 py-1 rounded hover:bg-surface text-xs flex items-center gap-1"
                        title="导出"
                      >
                        <i data-lucide="download" class="w-3 h-3"></i>
                      </button>
                    </div>

                    <!-- 表格区域 -->
                    <div class="result-scroll-area overflow-x-auto overflow-y-auto">
                      <table class="ide-table">
                        <thead>
                          <tr>
                            <th>id</th>
                            <th>customer_name</th>
                            <th>product_name</th>
                            <th>amount</th>
                            <th>date</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr><td>1</td><td>张三</td><td>产品A</td><td>1500</td><td>2024-01-15</td></tr>
                          <tr><td>2</td><td>李四</td><td>产品B</td><td>2300</td><td>2024-01-16</td></tr>
                          <tr><td>3</td><td>王五</td><td>产品C</td><td>890</td><td>2024-01-17</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ========== set-content 开始 ========== -->
            <!-- 集合操作内容 - 新版横向卡片布局 -->
            <div
              id="set-content"
              class="flex flex-1 flex-col overflow-hidden bg-surface"
              style="display: none;"
            >
              <!-- 顶部工具栏 -->
              <div class="h-12 px-6 border-b border-border shrink-0 flex items-center justify-between bg-muted/20">
                <div class="flex items-center gap-3">
                  <i data-lucide="layers" class="w-4 h-4 text-primary"></i>
                  <span class="text-sm font-medium">集合操作</span>
                  <span class="text-xs text-muted-fg px-2 py-0.5 bg-muted rounded">双击左侧数据源添加表</span>
                </div>
                <div class="flex items-center gap-2">
                  <!-- 集合操作类型选择 -->
                  <div class="flex bg-muted p-0.5 rounded-md h-8 gap-0.5">
                    <button onclick="switchSetOperation('union')" id="set-op-union" class="px-2.5 text-xs font-medium rounded bg-surface text-foreground shadow-sm">UNION</button>
                    <button onclick="switchSetOperation('union-all')" id="set-op-union-all" class="px-2.5 text-xs font-medium rounded text-muted-fg hover:text-foreground">UNION ALL</button>
                    <button onclick="switchSetOperation('intersect')" id="set-op-intersect" class="px-2.5 text-xs font-medium rounded text-muted-fg hover:text-foreground">INTERSECT</button>
                    <button onclick="switchSetOperation('except')" id="set-op-except" class="px-2.5 text-xs font-medium rounded text-muted-fg hover:text-foreground">EXCEPT</button>
                  </div>
                  <button onclick="clearSetTables()" class="px-3 py-1.5 text-xs rounded-md border border-border hover:bg-surface-hover text-muted-fg">
                    <i data-lucide="trash-2" class="w-3 h-3 inline mr-1"></i>
                    清空
                  </button>
                  <button class="px-4 py-1.5 bg-primary text-white rounded-md text-sm font-medium hover:opacity-90 flex items-center gap-1.5">
                    <i data-lucide="play" class="w-3.5 h-3.5"></i>
                    执行
                  </button>
                </div>
              </div>

              <!-- 横向数据源卡片区域 -->
              <div class="flex-1 overflow-auto p-6">
                <!-- 已选择的表卡片 - 横向排列 -->
                <div id="set-tables-container" class="flex items-start gap-4 min-h-[300px] pb-4">
                  <!-- 空状态提示 -->
                  <div id="set-empty-state" class="flex-1 flex flex-col items-center justify-center text-center py-12 border-2 border-dashed border-border rounded-xl">
                    <i data-lucide="layers" class="w-12 h-12 text-muted-fg mb-4"></i>
                    <h3 class="text-sm font-medium mb-2">开始集合操作</h3>
                    <p class="text-xs text-muted-fg max-w-xs">
                      双击左侧数据源面板中的表来添加到集合操作。<br/>
                      可以添加多个表进行 UNION / INTERSECT / EXCEPT 操作。
                    </p>
                  </div>
                </div>

                <!-- BY NAME 选项 -->
                <div id="set-byname-option" class="mt-4 hidden">
                  <div class="p-3 bg-muted/30 rounded-lg border border-border inline-flex items-center gap-3">
                    <label class="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" id="set-byname-checkbox" class="accent-primary" checked />
                      <span class="text-sm font-medium">BY NAME</span>
                    </label>
                    <span class="text-xs text-muted-fg">按列名匹配（DuckDB 特性）</span>
                  </div>
                </div>

                <!-- 生成的 SQL 预览 -->
                <div id="set-sql-preview" class="mt-4 hidden">
                  <div class="flex items-center justify-between mb-2">
                    <label class="text-sm font-medium flex items-center gap-2">
                      <i data-lucide="code" class="w-4 h-4 text-primary"></i>
                      生成的 SQL
                    </label>
                    <button class="text-xs text-primary hover:underline">复制</button>
                  </div>
                  <div class="code-block text-xs" id="set-sql-code">
                    <span class="text-purple-400">SELECT</span> *<br/>
                    <span class="text-purple-400">FROM</span> <span id="set-sql-tables">...</span>
                  </div>
                </div>

              </div>
              </div>

              <!-- 可拖拽分隔线 -->
              <div class="resizer" id="set-resizer">
                <button
                  class="collapse-btn"
                  onclick="toggleSetResultPane(event)"
                  title="折叠/展开结果面板"
                >
                  <i
                    data-lucide="chevron-down"
                    class="w-3 h-3"
                    id="set-collapse-icon"
                  ></i>
                </button>
              </div>

              <!-- 查询结果面板 -->
              <div
                class="flex flex-col border-t border-border"
                id="set-result-pane"
                style="height: 300px; flex-shrink: 0;"
              >
                <div class="flex flex-col flex-1 min-h-0 overflow-hidden bg-surface">
                  <div class="flex flex-col flex-1 min-h-0 overflow-hidden">
                    <!-- 工具栏 -->
                    <div class="result-toolbar sticky top-0 z-sticky border-t-0">
                      <i data-lucide="table" class="w-3.5 h-3.5"></i>
                      <span class="font-medium">查询结果</span>
                      <span class="opacity-60">·</span>
                      <span>3 行</span>
                      <span class="opacity-60">·</span>
                      <span>4 列</span>
                      <div class="flex-1"></div>
                      <span class="text-xs opacity-60">执行时间: 0.4s</span>
                      <button
                        class="px-2 py-1 rounded hover:bg-surface text-xs flex items-center gap-1"
                        title="导出"
                      >
                        <i data-lucide="download" class="w-3 h-3"></i>
                      </button>
                    </div>

                    <!-- 表格区域 -->
                    <div class="result-scroll-area overflow-x-auto overflow-y-auto">
                      <table class="ide-table">
                        <thead>
                          <tr>
                            <th>id</th>
                            <th>name</th>
                            <th>source</th>
                            <th>value</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr><td>1</td><td>记录A</td><td>表1</td><td>100</td></tr>
                          <tr><td>2</td><td>记录B</td><td>表1</td><td>200</td></tr>
                          <tr><td>3</td><td>记录C</td><td>表2</td><td>150</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- ========== set-content 结束 ========== -->

            <!-- 透视表内容 - 新版横向卡片布局 -->
            <div id="pivot-content" class="flex flex-1 flex-col overflow-hidden bg-surface" style="display: none;">
            <!-- 顶部工具栏 -->
            <div class="h-12 px-6 border-b border-border shrink-0 flex items-center justify-between bg-muted/20">
              <div class="flex items-center gap-3">
                <i data-lucide="table-2" class="w-4 h-4 text-primary"></i>
                <span class="text-sm font-medium">透视表</span>
                <span class="text-xs text-muted-fg">|</span>
                <span class="text-sm">数据源: <span class="font-semibold" id="pivot-table-name">sales_data</span></span>
                <span class="text-xs text-muted-fg px-2 py-0.5 bg-muted rounded">双击左侧切换</span>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="clearPivotConfig()" class="px-3 py-1.5 text-xs rounded-md border border-border hover:bg-surface-hover text-muted-fg">
                  <i data-lucide="trash-2" class="w-3 h-3 inline mr-1"></i>
                  清空配置
                </button>
                <button class="px-4 py-1.5 bg-primary text-white rounded-md text-sm font-medium hover:opacity-90 flex items-center gap-1.5">
                  <i data-lucide="play" class="w-3.5 h-3.5"></i>
                  执行
                </button>
              </div>
            </div>
            
            <!-- 横向配置区域 -->
            <div class="flex-1 overflow-auto p-6">
              <!-- 配置卡片 - 横向排列 -->
              <div class="flex items-start gap-4 min-h-[300px] pb-4" id="pivot-config-container">
                
                <!-- 行维度卡片 -->
                <div class="datasource-card shrink-0 animate-slide-in" style="min-width: 260px; max-width: 280px;">
                  <div class="p-3 border-b border-border flex items-center justify-between">
                    <div class="flex items-center gap-2">
                      <i data-lucide="rows" class="w-4 h-4 text-primary"></i>
                      <span class="font-medium text-sm">行维度</span>
                    </div>
                    <span class="text-xs px-1.5 py-0.5 bg-primary/20 text-primary rounded">2</span>
                  </div>
                  <div class="p-3">
                    <div class="text-xs text-muted-fg mb-3">作为表格的行分组</div>
                    <div class="space-y-2 mb-3">
                      <div class="flex items-center gap-2 p-2 bg-muted/30 rounded border border-border">
                        <i data-lucide="grip-vertical" class="w-3.5 h-3.5 text-muted-fg cursor-move"></i>
                        <span class="text-sm flex-1">category</span>
                        <button class="text-error hover:bg-error/10 p-1 rounded" title="移除">
                          <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                      </div>
                      <div class="flex items-center gap-2 p-2 bg-muted/30 rounded border border-border">
                        <i data-lucide="grip-vertical" class="w-3.5 h-3.5 text-muted-fg cursor-move"></i>
                        <span class="text-sm flex-1">region</span>
                        <button class="text-error hover:bg-error/10 p-1 rounded" title="移除">
                          <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                      </div>
                    </div>
                    <button class="w-full py-2 border border-dashed border-primary/50 text-primary rounded text-xs hover:bg-primary/5">
                      <i data-lucide="plus" class="w-3 h-3 inline mr-1"></i>
                      添加行维度
                    </button>
                  </div>
                </div>

                <!-- 列维度卡片 -->
                <div class="datasource-card shrink-0 animate-slide-in" style="min-width: 260px; max-width: 280px;">
                  <div class="p-3 border-b border-border flex items-center justify-between">
                    <div class="flex items-center gap-2">
                      <i data-lucide="columns" class="w-4 h-4 text-primary"></i>
                      <span class="font-medium text-sm">列维度</span>
                    </div>
                    <span class="text-xs px-1.5 py-0.5 bg-primary/20 text-primary rounded">1</span>
                  </div>
                  <div class="p-3">
                    <div class="text-xs text-muted-fg mb-3">作为表格的列分组</div>
                    <div class="space-y-2 mb-3">
                      <div class="flex items-center gap-2 p-2 bg-muted/30 rounded border border-border">
                        <i data-lucide="grip-vertical" class="w-3.5 h-3.5 text-muted-fg cursor-move"></i>
                        <span class="text-sm flex-1">year</span>
                        <button class="text-error hover:bg-error/10 p-1 rounded" title="移除">
                          <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                      </div>
                    </div>
                    <button class="w-full py-2 border border-dashed border-primary/50 text-primary rounded text-xs hover:bg-primary/5">
                      <i data-lucide="plus" class="w-3 h-3 inline mr-1"></i>
                      添加列维度
                    </button>
                  </div>
                </div>

                <!-- 聚合指标卡片 -->
                <div class="datasource-card shrink-0 animate-slide-in" style="min-width: 280px; max-width: 320px;">
                  <div class="p-3 border-b border-border flex items-center justify-between">
                    <div class="flex items-center gap-2">
                      <i data-lucide="sigma" class="w-4 h-4 text-primary"></i>
                      <span class="font-medium text-sm">聚合指标</span>
                    </div>
                    <span class="text-xs px-1.5 py-0.5 bg-primary/20 text-primary rounded">1</span>
                  </div>
                  <div class="p-3">
                    <div class="text-xs text-muted-fg mb-3">统计计算指标</div>
                    <div class="space-y-2 mb-3">
                      <div class="p-2 bg-muted/30 rounded border border-border">
                        <div class="flex items-center justify-between mb-2">
                          <span class="text-xs font-medium">总金额</span>
                          <button class="text-error hover:bg-error/10 p-1 rounded" title="移除">
                            <i data-lucide="x" class="w-3 h-3"></i>
                          </button>
                        </div>
                        <div class="flex gap-2">
                          <select class="duck-input text-xs flex-1 py-1">
                            <option selected>SUM</option>
                            <option>AVG</option>
                            <option>COUNT</option>
                            <option>MIN</option>
                            <option>MAX</option>
                          </select>
                          <select class="duck-input text-xs flex-1 py-1">
                            <option selected>amount</option>
                            <option>quantity</option>
                            <option>price</option>
                          </select>
                        </div>
                      </div>
                    </div>
                    <button class="w-full py-2 border border-dashed border-primary/50 text-primary rounded text-xs hover:bg-primary/5">
                      <i data-lucide="plus" class="w-3 h-3 inline mr-1"></i>
                      添加指标
                    </button>
                  </div>
                </div>

              </div>

              <!-- SQL 预览 -->
              <div class="mt-4">
                <div class="flex items-center justify-between mb-2">
                  <label class="text-sm font-medium flex items-center gap-2">
                    <i data-lucide="code" class="w-4 h-4 text-primary"></i>
                    生成的 SQL
                  </label>
                  <button class="text-xs text-primary hover:underline">复制</button>
                </div>
                <pre class="code-block text-xs overflow-x-auto">SELECT
  category,
  region,
  SUM(CASE WHEN year = 2023 THEN amount END) AS "2023_总金额",
  SUM(CASE WHEN year = 2024 THEN amount END) AS "2024_总金额"
FROM sales_data
GROUP BY category, region
ORDER BY category, region</pre>
              </div>

              <!-- 提示信息 -->
              <div class="p-3 bg-muted/50 rounded-lg text-xs text-muted-fg flex items-start gap-2 mt-4">
                <i data-lucide="info" class="w-4 h-4 flex-shrink-0 mt-0.5"></i>
                <div>
                  <strong class="text-foreground">透视表说明：</strong><br />
                  • 行维度：决定表格的行（如类别、地区）<br />
                  • 列维度：决定表格的列（如年份、季度）<br />
                  • 聚合指标：在交叉点显示的统计值（如总金额、平均价格）
                </div>
              </div>
            </div>
          </div>
          </div>
          <!-- 查询模式内容结束 -->

          <!-- 异步任务模式 -->
          <div id="tasks-content" class="flex-1 flex flex-col hidden">
            <div class="flex-1 overflow-auto p-6 space-y-4">
              <!-- 标题 -->
              <div class="mb-4">
                <h3 class="text-base font-semibold flex items-center gap-2">
                  <i data-lucide="clock" class="w-5 h-5 text-primary"></i>
                  异步任务列表
                </h3>
                <p class="text-sm text-muted-fg mt-1">
                  查看和管理后台运行的查询任务
                </p>
              </div>

              <!-- 任务列表 -->
              <div class="space-y-3">
                <!-- 任务 1 - 运行中 -->
                <div class="p-4 rounded-lg border border-border bg-muted/30">
                  <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                      <div class="flex items-center gap-2 mb-1">
                        <span class="text-sm font-medium">大数据聚合查询</span>
                        <span
                          class="px-2 py-0.5 text-xs rounded bg-primary/20 text-primary"
                        >
                          运行中
                        </span>
                      </div>
                      <code class="text-xs text-muted-fg font-mono">
                        SELECT category, SUM(amount) FROM large_dataset...
                      </code>
                    </div>
                    <button
                      class="px-2 py-1 text-xs rounded border border-border hover:bg-surface-hover"
                    >
                      取消
                    </button>
                  </div>
                  <div class="space-y-2">
                    <div class="flex items-center gap-2">
                      <div
                        class="flex-1 h-2 bg-muted rounded-full overflow-hidden"
                      >
                        <div
                          class="h-full bg-primary w-3/4 transition-all"
                        ></div>
                      </div>
                      <span class="text-xs text-muted-fg">75%</span>
                    </div>
                    <div class="flex items-center gap-4 text-xs text-muted-fg">
                      <span>开始时间: 2024-01-15 10:30:00</span>
                      <span>已运行: 2m 15s</span>
                    </div>
                  </div>
                </div>

                <!-- 任务 2 - 已完成 -->
                <div class="p-4 rounded-lg border border-border bg-muted/30">
                  <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                      <div class="flex items-center gap-2 mb-1">
                        <span class="text-sm font-medium">用户行为分析</span>
                        <span
                          class="px-2 py-0.5 text-xs rounded bg-success/20 text-success"
                        >
                          已完成
                        </span>
                      </div>
                      <code class="text-xs text-muted-fg font-mono">
                        SELECT user_id, COUNT(*) FROM events...
                      </code>
                    </div>
                    <div class="flex gap-1">
                      <button
                        class="px-2 py-1 text-xs rounded border border-border hover:bg-surface-hover"
                      >
                        查看结果
                      </button>
                      <button
                        class="px-2 py-1 text-xs rounded border border-border hover:bg-surface-hover"
                      >
                        下载
                      </button>
                    </div>
                  </div>
                  <div class="flex items-center gap-4 text-xs text-muted-fg">
                    <span>✓ 成功</span>
                    <span>1,234,567 行</span>
                    <span>耗时: 5m 32s</span>
                    <span>完成时间: 2024-01-15 10:25:00</span>
                  </div>
                </div>

                <!-- 任务 3 - 失败 -->
                <div class="p-4 rounded-lg border border-border bg-muted/30">
                  <div class="flex items-start justify-between mb-3">
                    <div class="flex-1">
                      <div class="flex items-center gap-2 mb-1">
                        <span class="text-sm font-medium">数据导出任务</span>
                        <span
                          class="px-2 py-0.5 text-xs rounded bg-error/20 text-error"
                        >
                          失败
                        </span>
                      </div>
                      <code class="text-xs text-muted-fg font-mono">
                        COPY (SELECT * FROM sales) TO 'export.csv'...
                      </code>
                    </div>
                    <button
                      class="px-2 py-1 text-xs rounded border border-border hover:bg-surface-hover"
                    >
                      重试
                    </button>
                  </div>
                  <div class="space-y-2">
                    <div class="text-xs text-error">
                      ❌ 错误: 磁盘空间不足
                    </div>
                    <div class="flex items-center gap-4 text-xs text-muted-fg">
                      <span>失败时间: 2024-01-15 10:20:00</span>
                      <span>已运行: 30s</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 空状态提示 -->
              <div class="hidden p-8 text-center text-muted-fg">
                <i
                  data-lucide="inbox"
                  class="w-12 h-12 mx-auto mb-2 opacity-50"
                ></i>
                <p>暂无异步任务</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script>
      // 初始化 Lucide 图标
      lucide.createIcons();

      // 折叠 Sidebar
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("sidebar-collapsed");

        // 重新初始化图标
        setTimeout(() => {
          lucide.createIcons();
        }, 100);
      }

      // 二级 Tab 切换
      function switchSecondaryTab(tab) {
        // 移除所有二级 Tab 的 active 类
        const tabs = document.querySelectorAll(
          '.tab-btn[onclick^="switchSecondaryTab"]'
        );
        tabs.forEach(t => t.classList.remove("active"));

        // 添加当前 Tab 的 active 类
        event.currentTarget.classList.add("active");

        // 隐藏所有内容区
        const queryMode = document.getElementById("query-mode");
        const tasksContent = document.getElementById("tasks-content");

        if (tab === "query") {
          // 显示查询模式（包含四个三级 Tab）
          if (queryMode) {
            queryMode.classList.remove("hidden");
            // 切回查询模式时，默认显示可视化三级页，避免右侧内容黑屏
            switchThirdTab("visual");
          }
          if (tasksContent) tasksContent.classList.add("hidden");
        } else if (tab === "tasks") {
          // 显示异步任务模式
          if (queryMode) queryMode.classList.add("hidden");
          if (tasksContent) tasksContent.classList.remove("hidden");
        }

        // 重新初始化图标
        setTimeout(() => {
          lucide.createIcons();
        }, 50);
      }

      // 三级 Tab 切换
      function switchThirdTab(tab) {
        // 隐藏所有内容区
        const contents = [
          "visual-content",
          "sql-content",
          "join-content",
          "set-content",
          "pivot-content"
        ];
        contents.forEach(contentId => {
          const element = document.getElementById(contentId);
          if (element) {
            element.style.display = "none";
            element.classList.add("hidden");
          }
        });

        // 移除所有三级标签的激活状态
        const tabs = document.querySelectorAll(
          '.tab-btn[onclick^="switchThirdTab"]'
        );
        tabs.forEach(t => t.classList.remove("active"));

        // 显示选中的内容区
        let targetContent = "";
        if (tab === "visual") {
          targetContent = "visual-content";
        } else if (tab === "sql") {
          targetContent = "sql-content";
        } else if (tab === "join") {
          targetContent = "join-content";
        } else if (tab === "set") {
          targetContent = "set-content";
        } else if (tab === "pivot") {
          targetContent = "pivot-content";
        }

        const targetElement = document.getElementById(targetContent);
        if (targetElement) {
          targetElement.style.display = "flex";
          targetElement.classList.remove("hidden");
        }

        // 激活对应的标签按钮
        const clickedTab = event ? event.currentTarget : null;
        if (clickedTab) {
          clickedTab.classList.add("active");
        }

        // 重新初始化图标
        setTimeout(() => {
          lucide.createIcons();
        }, 50);
      }

      // 切换外部数据库分组
      function toggleExternalDb() {
        const list = document.getElementById("external-db-list");
        const chevron = document.getElementById("external-db-chevron");
        list.classList.toggle("hidden");

        // 切换图标
        if (list.classList.contains("hidden")) {
          chevron.setAttribute("data-lucide", "chevron-right");
        } else {
          chevron.setAttribute("data-lucide", "chevron-down");
        }
        lucide.createIcons();
      }

      // 切换 MySQL 表列表
      function toggleMysqlTables(event) {
        event.stopPropagation();
        const tables = document.getElementById("mysql-tables");
        const chevron = document.getElementById("mysql-chevron");
        tables.classList.toggle("hidden");

        // 切换图标
        if (tables.classList.contains("hidden")) {
          chevron.setAttribute("data-lucide", "chevron-right");
        } else {
          chevron.setAttribute("data-lucide", "chevron-down");
        }
        lucide.createIcons();
      }

      // 切换 PostgreSQL 表列表
      function togglePostgresTables(event) {
        event.stopPropagation();
        const tables = document.getElementById("postgres-tables");
        const chevron = document.getElementById("postgres-chevron");
        tables.classList.toggle("hidden");

        // 切换图标
        if (tables.classList.contains("hidden")) {
          chevron.setAttribute("data-lucide", "chevron-right");
        } else {
          chevron.setAttribute("data-lucide", "chevron-down");
        }
        lucide.createIcons();
      }

      // 分隔线拖拽功能
      let isResizing = false;
      let startY = 0;
      let startTopHeight = 0;
      let startBottomHeight = 0;

      const resizer = document.getElementById("resizer");
      const queryBuilderPane = document.getElementById("query-builder-pane");
      const resultPane = document.getElementById("result-pane");
      const container = document.getElementById("visual-content");

      resizer.addEventListener("mousedown", e => {
        if (
          e.target.classList.contains("collapse-btn") ||
          e.target.closest(".collapse-btn")
        ) {
          return;
        }

        isResizing = true;
        startY = e.clientY;
        startTopHeight = queryBuilderPane.offsetHeight;
        startBottomHeight = resultPane.offsetHeight;

        document.body.style.cursor = "ns-resize";
        document.body.style.userSelect = "none";
      });

      document.addEventListener("mousemove", e => {
        if (!isResizing) return;

        const deltaY = e.clientY - startY;
        const containerHeight = container.offsetHeight;
        const resizerHeight = resizer.offsetHeight;

        let newTopHeight = startTopHeight + deltaY;
        let newBottomHeight = startBottomHeight - deltaY;

        // 限制最小高度
        const minTopHeight = 200; // 查询构建器最小高度
        const minBottomHeight = 100; // 结果表格最小高度
        if (newTopHeight < minTopHeight) {
          newTopHeight = minTopHeight;
          newBottomHeight = containerHeight - minTopHeight - resizerHeight;
        } else if (newBottomHeight < minBottomHeight) {
          newBottomHeight = minBottomHeight;
          newTopHeight = containerHeight - minBottomHeight - resizerHeight;
        }

        queryBuilderPane.style.height = newTopHeight + "px";
        resultPane.style.height = newBottomHeight + "px";

        // 更新保存的高度
        savedResultHeight = newBottomHeight;
      });

      document.addEventListener("mouseup", () => {
        if (isResizing) {
          isResizing = false;
          document.body.style.cursor = "";
          document.body.style.userSelect = "";
        }
      });

      // 折叠/展开结果面板
      let savedResultHeight = 400; // 保存折叠前的高度

      function toggleResultPane(event) {
        event.stopPropagation();
        if (!resultPane || !queryBuilderPane) return;
        
        const icon = document.getElementById("collapse-icon");
        const currentHeight = resultPane.offsetHeight;
        
        if (currentHeight > 50) {
          // 折叠 - 保存当前高度
          savedResultHeight = currentHeight;
          resultPane.style.height = "0px";
          resultPane.classList.add("collapsed");
          queryBuilderPane.style.height = "calc(100% - 4px)";
          if (icon) icon.setAttribute("data-lucide", "chevron-up");
        } else {
          // 展开 - 恢复保存的高度
          const expandHeight = savedResultHeight || 400;
          resultPane.style.height = expandHeight + "px";
          resultPane.classList.remove("collapsed");
          queryBuilderPane.style.height = `calc(100% - ${expandHeight}px - 4px)`;
          if (icon) icon.setAttribute("data-lucide", "chevron-down");
        }

        lucide.createIcons();
      }

      // 初始化高度
      window.addEventListener("load", () => {
        if (!container || !queryBuilderPane || !resultPane) return;
        
        const containerHeight = container.offsetHeight;
        const topHeight = Math.floor(containerHeight * 0.5); // 查询构建器 50%
        const bottomHeight = containerHeight - topHeight - 4; // 结果表格 50%

        queryBuilderPane.style.height = topHeight + "px";
        resultPane.style.height = bottomHeight + "px";
        savedResultHeight = bottomHeight;
        
        console.log("初始化高度 - 上:", topHeight, "下:", bottomHeight);
      });

      // 横向拖拽调整数据源面板宽度
      let isResizingHorizontal = false;
      let startX = 0;
      let startWidth = 0;
      let savedPanelWidth = 256; // 保存用户调整的宽度

      const horizontalResizer = document.getElementById("horizontal-resizer");
      const datasourcePanel = document.getElementById("datasource-panel");

      if (horizontalResizer && datasourcePanel) {
        horizontalResizer.addEventListener("mousedown", e => {
          // 如果已折叠，不允许拖拽
          if (
            datasourcePanel.classList.contains("datasource-panel-collapsed")
          ) {
            return;
          }

          isResizingHorizontal = true;
          startX = e.clientX;
          startWidth = datasourcePanel.offsetWidth;

          document.body.style.cursor = "ew-resize";
          document.body.style.userSelect = "none";
        });

        document.addEventListener("mousemove", e => {
          if (!isResizingHorizontal) return;

          const deltaX = e.clientX - startX;
          let newWidth = startWidth + deltaX;

          // 自动折叠阈值
          const collapseThreshold = 50;
          const minWidth = 50;
          const maxWidth = 600;

          if (newWidth <= collapseThreshold) {
            // 触发自动折叠
            datasourcePanel.classList.add("datasource-panel-collapsed");
            const expandBtn = document.getElementById("expand-datasource-btn");
            expandBtn.classList.remove("hidden");
            expandBtn.classList.add("flex");

            // 停止拖拽
            isResizingHorizontal = false;
            document.body.style.cursor = "";
            document.body.style.userSelect = "";

            // 重新初始化图标
            setTimeout(() => {
              lucide.createIcons();
            }, 50);
            return;
          }

          if (newWidth < minWidth) newWidth = minWidth;
          if (newWidth > maxWidth) newWidth = maxWidth;

          datasourcePanel.style.width = newWidth + "px";
          savedPanelWidth = newWidth; // 保存当前宽度
        });

        document.addEventListener("mouseup", () => {
          if (isResizingHorizontal) {
            isResizingHorizontal = false;
            document.body.style.cursor = "";
            document.body.style.userSelect = "";
          }
        });
      }

      // 切换数据源面板折叠/展开
      function toggleDataSourcePanel() {
        const panel = document.getElementById("datasource-panel");
        const expandBtn = document.getElementById("expand-datasource-btn");

        if (panel.classList.contains("datasource-panel-collapsed")) {
          // 展开：恢复到保存的宽度（至少 180px）
          panel.classList.remove("datasource-panel-collapsed");
          const expandWidth = Math.max(savedPanelWidth, 180);
          panel.style.width = expandWidth + "px";
          savedPanelWidth = expandWidth; // 更新保存的宽度
          expandBtn.classList.add("hidden");
          expandBtn.classList.remove("flex");
        } else {
          // 折叠：保存当前宽度
          savedPanelWidth = panel.offsetWidth;
          panel.classList.add("datasource-panel-collapsed");
          expandBtn.classList.remove("hidden");
          expandBtn.classList.add("flex");
        }

        // 重新初始化图标
        setTimeout(() => {
          lucide.createIcons();
        }, 50);
      }

      // 双击选择表
      function selectTable(tableName, event) {
        event.stopPropagation();

        // 更新选中状态
        const allTreeItems = document.querySelectorAll(".tree-item");
        allTreeItems.forEach(item => {
          item.classList.remove("selected");
          const icon = item.querySelector('i[data-lucide="table"]');
          if (icon) {
            icon.classList.remove("text-primary");
            icon.classList.add("text-muted-fg");
          }
        });

        // 选中当前项
        event.currentTarget.classList.add("selected");
        const currentIcon = event.currentTarget.querySelector(
          'i[data-lucide="table"]'
        );
        if (currentIcon) {
          currentIcon.classList.remove("text-muted-fg");
          currentIcon.classList.add("text-primary");
        }

        // 更新右侧显示的表名
        const selectedTableName = document.getElementById(
          "selected-table-name"
        );
        if (selectedTableName) {
          selectedTableName.textContent = tableName;
        }

        // 重新初始化图标
        lucide.createIcons();
      }

      // ======================================================================
      // 值类型切换函数（固定值/列对列/表达式）
      // ======================================================================
      function switchValueType(conditionId, valueType) {
        const fixedInput = document.getElementById(`fixedValue${conditionId}`);
        const columnSelect = document.getElementById(
          `columnValue${conditionId}`
        );
        const expressionInput = document.getElementById(
          `expressionValue${conditionId}`
        );

        // 隐藏所有输入
        fixedInput.style.display = "none";
        columnSelect.style.display = "none";
        expressionInput.style.display = "none";

        // 显示选中的输入类型
        if (valueType === "fixed") {
          fixedInput.style.display = "block";
        } else if (valueType === "column") {
          columnSelect.style.display = "block";
        } else if (valueType === "expression") {
          expressionInput.style.display = "block";
        }
      }

      // ======================================================================
      // 列过滤弹窗控制函数
      // ======================================================================
      function toggleColumnFilter(event, columnName) {
        event.stopPropagation();
        const popup = document.getElementById("column-filter-popup");
        const columnNameSpan = document.getElementById("filter-column-name");

        // 更新弹窗标题
        columnNameSpan.textContent = `筛选 ${columnName}`;

        // 计算弹窗位置（显示在按钮下方）
        const button = event.currentTarget;
        const rect = button.getBoundingClientRect();

        // 确保弹窗不超出视口
        const popupWidth = 280;
        let left = rect.left;
        let top = rect.bottom + 5;

        // 如果右侧空间不足，向左对齐
        if (left + popupWidth > window.innerWidth) {
          left = Math.max(10, window.innerWidth - popupWidth - 10);
        }

        // 如果下方空间不足，显示在按钮上方
        const popupHeight = 400; // 估算高度
        if (top + popupHeight > window.innerHeight) {
          top = rect.top - popupHeight - 5;
        }

        popup.style.display = "block";
        popup.style.left = left + "px";
        popup.style.top = top + "px";

        // 重新初始化图标
        setTimeout(() => {
          lucide.createIcons();
        }, 50);
      }

      function closeColumnFilter() {
        const popup = document.getElementById("column-filter-popup");
        popup.style.display = "none";
      }

      function selectAllValues() {
        const checkboxes = document.querySelectorAll(
          "#column-filter-popup input[type='checkbox']"
        );
        checkboxes.forEach(cb => (cb.checked = true));
      }

      function clearAllValues() {
        const checkboxes = document.querySelectorAll(
          "#column-filter-popup input[type='checkbox']"
        );
        checkboxes.forEach(cb => (cb.checked = false));
      }

      function selectUniqueValues() {
        // 这里是演示，实际应该只选择唯一值
        console.log("选择唯一值");
      }

      function applyColumnFilter() {
        // 应用过滤条件（前端过滤，不联动后端）
        console.log("应用前端过滤");
        closeColumnFilter();

        // 这里可以添加前端过滤逻辑
        // 例如：根据勾选的值过滤表格行
      }

      // 显示自定义通知弹窗
      function showNotification(title, message) {
        // 创建弹窗
        const notification = document.createElement("div");
        notification.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: hsl(var(--dq-surface));
          border: 1px solid hsl(var(--dq-border));
          border-radius: 12px;
          padding: 24px;
          box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
          z-index: 1080;
          min-width: 320px;
          max-width: 480px;
        `;

        notification.innerHTML = `
          <div style="margin-bottom: 16px;">
            <h3 style="font-size: 16px; font-weight: 600; color: hsl(var(--dq-foreground)); margin: 0;">
              ${title}
            </h3>
          </div>
          <div style="margin-bottom: 20px;">
            <p style="font-size: 14px; color: hsl(var(--dq-muted-fg)); margin: 0; line-height: 1.5;">
              ${message}
            </p>
          </div>
          <div style="display: flex; justify-content: flex-end;">
            <button onclick="this.closest('div[style*=fixed]').remove()"
                    style="padding: 8px 16px;
                           border-radius: 6px;
                           border: none;
                           background: hsl(var(--dq-primary));
                           color: hsl(var(--dq-primary-fg));
                           font-size: 14px;
                           font-weight: 500;
                           cursor: pointer;">
              确定
            </button>
          </div>
        `;

        // 添加背景遮罩
        const backdrop = document.createElement("div");
        backdrop.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.5);
          backdrop-filter: blur(2px);
          z-index: 1070;
        `;
        backdrop.onclick = () => {
          backdrop.remove();
          notification.remove();
        };

        document.body.appendChild(backdrop);
        document.body.appendChild(notification);
      }

      // 点击页面其他地方关闭弹窗
      document.addEventListener("click", function(event) {
        const popup = document.getElementById("column-filter-popup");
        if (popup && !popup.contains(event.target)) {
          popup.style.display = "none";
        }
      });

      // ======================================================================
      // 查询模式切换函数
      // ======================================================================
      function switchQueryMode(mode) {
        // 隐藏所有内容区
        const contents = document.querySelectorAll(".query-mode-content");
        contents.forEach(c => {
          c.style.display = "none";
        });

        // 移除所有卡片的激活状态
        const cards = document.querySelectorAll(".query-mode-card");
        cards.forEach(card => card.classList.remove("active"));

        // 显示选中的内容区
        const content = document.getElementById("content-" + mode);
        if (content) {
          content.style.display = "block";
        }

        // 激活选中的卡片
        const card = document.getElementById("mode-" + mode);
        if (card) {
          card.classList.add("active");
        }

        // 重新初始化图标
        setTimeout(() => {
          lucide.createIcons();
        }, 50);
      }

      // ======================================================================
      // DuckDB 类型转换函数
      // ======================================================================
      let currentCastConditionId = null;

      function toggleTypeCast(conditionId) {
        currentCastConditionId = conditionId;
        const popup = document.getElementById("type-cast-popup");

        // 计算弹窗位置（居中显示）
        popup.style.display = "block";
        popup.style.left = "50%";
        popup.style.top = "50%";
        popup.style.transform = "translate(-50%, -50%)";

        // 更新预览
        updateCastPreview();

        // 重新初始化图标
        setTimeout(() => {
          lucide.createIcons();
        }, 50);
      }

      function closeTypeCast() {
        const popup = document.getElementById("type-cast-popup");
        popup.style.display = "none";
        currentCastConditionId = null;
      }

      function updateCastPreview() {
        const method = document.getElementById("cast-method").value;
        const targetType = document.getElementById("cast-target-type").value;
        const preview = document.getElementById("cast-preview");

        // 假设当前列是 amount_text
        const columnName = "amount_text";

        let castSQL = "";
        if (method === "try_cast") {
          castSQL = `TRY_CAST(${columnName} AS ${targetType})`;
        } else if (method === "cast") {
          castSQL = `CAST(${columnName} AS ${targetType})`;
        } else if (method === "suffix") {
          castSQL = `${columnName}::${targetType}`;
        }

        preview.textContent = castSQL;
      }

      function applyTypeCast() {
        const method = document.getElementById("cast-method").value;
        const targetType = document.getElementById("cast-target-type").value;

        // 这里实际应该更新对应条件的列选择器
        console.log(
          `应用类型转换: ${method}, ${targetType} 到条件 ${currentCastConditionId}`
        );

        // 显示成功提示
        showNotification(
          "类型转换已应用",
          `已将列转换为 ${targetType} 类型（使用 ${method.toUpperCase()}）`
        );

        closeTypeCast();
      }

      // 监听类型选择变化，更新预览
      // ======================================================================
      // JSON 字段选择器
      // ======================================================================
      function toggleJsonFieldSelector() {
        const popup = document.getElementById("json-field-selector");

        if (popup.style.display === "none" || popup.style.display === "") {
          // 显示弹窗（居中）
          popup.style.display = "block";
          popup.style.left = "50%";
          popup.style.top = "50%";
          popup.style.transform = "translate(-50%, -50%)";
        } else {
          // 隐藏弹窗
          popup.style.display = "none";
        }

        // 重新初始化图标
        setTimeout(() => {
          lucide.createIcons();
        }, 50);
      }

      document.addEventListener("DOMContentLoaded", function() {
        const castMethod = document.getElementById("cast-method");
        const castType = document.getElementById("cast-target-type");

        if (castMethod) {
          castMethod.addEventListener("change", updateCastPreview);
        }
        if (castType) {
          castType.addEventListener("change", updateCastPreview);
        }
      });

      // ======================================================================
      // 计算字段模式切换
      // ======================================================================
      function switchCalcMode(mode) {
        // 移除所有按钮的激活状态
        const buttons = document.querySelectorAll(".calc-mode-btn");
        buttons.forEach(btn => {
          btn.classList.remove("bg-surface", "shadow-sm", "text-foreground");
          btn.classList.add("text-muted-fg");
        });

        // 隐藏所有内容
        const formula = document.getElementById("calc-content-formula");
        const caseContent = document.getElementById("calc-content-case");
        const windowContent = document.getElementById("calc-content-window");

        if (formula) formula.style.display = "none";
        if (caseContent) caseContent.style.display = "none";
        if (windowContent) windowContent.style.display = "none";

        // 显示选中的内容
        const targetContent = document.getElementById("calc-content-" + mode);
        if (targetContent) {
          targetContent.style.display = "block";
        }

        // 激活选中的按钮
        const targetBtn = document.getElementById("calc-mode-" + mode);
        if (targetBtn) {
          targetBtn.classList.remove("text-muted-fg");
          targetBtn.classList.add("bg-surface", "shadow-sm", "text-foreground");
        }

        // 重新初始化图标
        setTimeout(() => {
          lucide.createIcons();
        }, 50);
      }

      // ======================================================================
      // JSON 字段展开管理
      // ======================================================================
      function openJsonConfigurator(columnName) {
        const dialog = document.getElementById("json-configurator-dialog");
        if (dialog) {
          dialog.classList.remove("hidden");
          dialog.classList.add("flex");

          // 设置源列名
          const sourceSelect = document.getElementById("json-source-column");
          if (sourceSelect && columnName) {
            sourceSelect.value = columnName;
          }

          // 重新初始化图标
          setTimeout(() => {
            lucide.createIcons();
          }, 50);
        }
      }

      function closeJsonConfigurator() {
        const dialog = document.getElementById("json-configurator-dialog");
        if (dialog) {
          dialog.classList.remove("flex");
          dialog.classList.add("hidden");
        }
      }

      function addJsonFieldMapping() {
        const container = document.getElementById("json-field-mappings");
        if (!container) return;

        const newRow = document.createElement("div");
        newRow.className =
          "grid grid-cols-12 gap-2 items-center p-2 border border-border rounded bg-muted/20";
        newRow.innerHTML = `
          <div class="col-span-3">
            <input type="text" class="duck-input text-sm" placeholder="列名" />
          </div>
          <div class="col-span-4">
            <input type="text" class="duck-input font-mono text-sm" placeholder="JSON 路径（如 $.field）" />
          </div>
          <div class="col-span-3">
            <select class="duck-input text-sm">
              <option>VARCHAR</option>
              <option>INTEGER</option>
              <option>DOUBLE</option>
              <option>BOOLEAN</option>
              <option>DATE</option>
              <option>TIMESTAMP</option>
              <option>JSON</option>
            </select>
          </div>
          <div class="col-span-2 flex items-center gap-1">
            <input type="checkbox" class="accent-primary" />
            <span class="text-xs text-muted-fg">NULL</span>
            <button class="text-error hover:bg-error/10 p-1 rounded ml-auto" onclick="removeJsonFieldMapping(this)" title="删除">
              <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
            </button>
          </div>
        `;

        container.appendChild(newRow);

        // 重新初始化图标
        setTimeout(() => {
          lucide.createIcons();
        }, 50);
      }

      function removeJsonFieldMapping(button) {
        const row = button.closest(".grid");
        if (row) {
          row.remove();
        }
      }

      function applyJsonConfiguration() {
        // 收集配置信息
        const mappings = [];
        const rows = document.querySelectorAll("#json-field-mappings .grid");

        rows.forEach(row => {
          const inputs = row.querySelectorAll('input[type="text"]');
          const select = row.querySelector("select");
          const nullCheckbox = row.querySelector('input[type="checkbox"]');

          if (inputs.length >= 2) {
            mappings.push({
              columnName: inputs[0].value,
              jsonPath: inputs[1].value,
              dataType: select.value,
              allowNull: nullCheckbox.checked
            });
          }
        });

        console.log("JSON 配置:", mappings);
        alert(`已配置 ${mappings.length} 个 JSON 字段映射`);

        // 关闭对话框
        closeJsonConfigurator();
      }

      // ======================================================================
      // 统一数据源选择管理 - 支持多表选择和联动
      // ======================================================================
      
      // 当前活动的 Tab
      let currentTab = 'visual';
      
      // 各 Tab 的已选择表
      const selectedTables = {
        visual: [],  // 可视化查询 - 单表
        sql: [],     // SQL 查询 - 单表
        join: [],    // 关联查询 - 多表
        set: [],     // 集合操作 - 多表
        pivot: []    // 透视表 - 单表
      };
      
      // 集合操作类型
      let currentSetOperation = 'union';
      
      // 模拟表结构数据
      const tableSchemas = {
        'sales_data': {
          source: 'DuckDB',
          columns: [
            { name: 'id', type: 'INTEGER' },
            { name: 'customer_id', type: 'INTEGER' },
            { name: 'product_id', type: 'INTEGER' },
            { name: 'amount', type: 'DECIMAL' },
            { name: 'date', type: 'DATE' },
            { name: 'status', type: 'VARCHAR' }
          ]
        },
        'customer_info': {
          source: 'DuckDB',
          columns: [
            { name: 'id', type: 'INTEGER' },
            { name: 'name', type: 'VARCHAR' },
            { name: 'email', type: 'VARCHAR' },
            { name: 'created_at', type: 'TIMESTAMP' }
          ]
        },
        'product_catalog': {
          source: 'DuckDB',
          columns: [
            { name: 'id', type: 'INTEGER' },
            { name: 'name', type: 'VARCHAR' },
            { name: 'category', type: 'VARCHAR' },
            { name: 'price', type: 'DECIMAL' }
          ]
        },
        'orders': {
          source: 'MySQL',
          columns: [
            { name: 'order_id', type: 'INT' },
            { name: 'user_id', type: 'INT' },
            { name: 'total', type: 'DECIMAL' },
            { name: 'order_date', type: 'DATETIME' }
          ]
        },
        'users': {
          source: 'MySQL',
          columns: [
            { name: 'user_id', type: 'INT' },
            { name: 'username', type: 'VARCHAR' },
            { name: 'email', type: 'VARCHAR' }
          ]
        },
        'products': {
          source: 'MySQL',
          columns: [
            { name: 'product_id', type: 'INT' },
            { name: 'title', type: 'VARCHAR' },
            { name: 'price', type: 'DECIMAL' }
          ]
        }
      };

      // 重写 selectTable 函数 - 支持多表选择
      function selectTable(tableName, event) {
        event.stopPropagation();
        
        const isMultiSelect = currentTab === 'join' || currentTab === 'set';
        const tables = selectedTables[currentTab];
        const tableIndex = tables.indexOf(tableName);
        
        if (isMultiSelect) {
          // 多表模式：切换选择状态
          if (tableIndex > -1) {
            // 已选中，取消选择
            tables.splice(tableIndex, 1);
          } else {
            // 未选中，添加
            tables.push(tableName);
          }
        } else {
          // 单表模式：替换选择
          selectedTables[currentTab] = [tableName];
        }
        
        // 更新左侧树的选中状态
        updateTreeSelection();
        
        // 更新右侧内容区
        updateContentArea();
        
        // 重新初始化图标
        lucide.createIcons();
      }

      // 更新左侧树的选中状态
      function updateTreeSelection() {
        const tables = selectedTables[currentTab];
        const allTreeItems = document.querySelectorAll('.tree-item');
        
        allTreeItems.forEach(item => {
          const nameSpan = item.querySelector('.item-name');
          if (!nameSpan) return;
          
          const tableName = nameSpan.textContent.trim();
          const icon = item.querySelector('i[data-lucide="table"]');
          
          if (tables.includes(tableName)) {
            item.classList.add('selected');
            if (icon) {
              icon.classList.remove('text-muted-fg');
              icon.classList.add('text-primary');
            }
          } else {
            item.classList.remove('selected');
            if (icon) {
              icon.classList.remove('text-primary');
              icon.classList.add('text-muted-fg');
            }
          }
        });
      }

      // 更新右侧内容区
      function updateContentArea() {
        if (currentTab === 'join') {
          updateJoinContent();
        } else if (currentTab === 'set') {
          updateSetContent();
        } else if (currentTab === 'visual') {
          // 更新可视化查询的表名显示
          const tables = selectedTables.visual;
          const nameEl = document.getElementById('selected-table-name');
          if (nameEl && tables.length > 0) {
            nameEl.textContent = tables[0];
          }
        } else if (currentTab === 'pivot') {
          // 更新透视表的表名显示
          const tables = selectedTables.pivot;
          const nameEl = document.getElementById('pivot-table-name');
          if (nameEl && tables.length > 0) {
            nameEl.textContent = tables[0];
          }
        } else if (currentTab === 'sql') {
          // SQL 查询模式 - 可以在编辑器中插入表名
          const tables = selectedTables.sql;
          // 可以扩展：双击时插入表名到 SQL 编辑器
        }
      }

      // 更新关联查询内容
      function updateJoinContent() {
        const container = document.getElementById('join-tables-container');
        const emptyState = document.getElementById('join-empty-state');
        const sqlPreview = document.getElementById('join-sql-preview');
        const resultPreview = document.getElementById('join-result-preview');
        const tables = selectedTables.join;
        
        if (tables.length === 0) {
          // 显示空状态
          container.innerHTML = '';
          container.appendChild(createEmptyState('join'));
          if (sqlPreview) sqlPreview.classList.add('hidden');
          if (resultPreview) resultPreview.classList.add('hidden');
          return;
        }
        
        // 清空容器
        container.innerHTML = '';
        
        // 创建表卡片
        tables.forEach((tableName, index) => {
          // 添加表卡片
          const card = createTableCard(tableName, index === 0, 'join');
          container.appendChild(card);
          
          // 如果不是最后一个，添加 JOIN 连接器
          if (index < tables.length - 1) {
            const connector = createJoinConnector(tableName, tables[index + 1], index);
            container.appendChild(connector);
          }
        });
        
        // 显示 SQL 预览
        if (sqlPreview) {
          sqlPreview.classList.remove('hidden');
          updateJoinSqlPreview();
        }
        
        // 显示结果预览（当有2个以上表时）
        if (resultPreview && tables.length >= 2) {
          resultPreview.classList.remove('hidden');
        } else if (resultPreview) {
          resultPreview.classList.add('hidden');
        }
        
        lucide.createIcons();
      }

      // 更新集合操作内容
      function updateSetContent() {
        const container = document.getElementById('set-tables-container');
        const sqlPreview = document.getElementById('set-sql-preview');
        const byNameOption = document.getElementById('set-byname-option');
        const tables = selectedTables.set;
        
        const resultPreview = document.getElementById('set-result-preview');
        
        if (tables.length === 0) {
          container.innerHTML = '';
          container.appendChild(createEmptyState('set'));
          if (sqlPreview) sqlPreview.classList.add('hidden');
          if (byNameOption) byNameOption.classList.add('hidden');
          if (resultPreview) resultPreview.classList.add('hidden');
          return;
        }
        
        container.innerHTML = '';
        
        tables.forEach((tableName, index) => {
          const card = createTableCard(tableName, index === 0, 'set');
          container.appendChild(card);
          
          if (index < tables.length - 1) {
            const connector = createSetConnector(index);
            container.appendChild(connector);
          }
        });
        
        if (sqlPreview) {
          sqlPreview.classList.remove('hidden');
          updateSetSqlPreview();
        }
        if (byNameOption) byNameOption.classList.remove('hidden');
        
        // 显示结果预览（当有2个以上表时）
        if (resultPreview && tables.length >= 2) {
          resultPreview.classList.remove('hidden');
        } else if (resultPreview) {
          resultPreview.classList.add('hidden');
        }
        
        lucide.createIcons();
      }

      // 创建空状态元素
      function createEmptyState(type) {
        const div = document.createElement('div');
        div.id = type + '-empty-state';
        div.className = 'flex-1 flex flex-col items-center justify-center text-center py-12 border-2 border-dashed border-border rounded-xl';
        
        const icon = type === 'join' ? 'git-merge' : 'layers';
        const title = type === 'join' ? '开始关联查询' : '开始集合操作';
        const desc = type === 'join' 
          ? '双击左侧数据源面板中的表来添加到关联查询。<br/>第一个添加的表将作为主表。'
          : '双击左侧数据源面板中的表来添加到集合操作。<br/>可以添加多个表进行 UNION / INTERSECT / EXCEPT 操作。';
        
        div.innerHTML = `
          <i data-lucide="${icon}" class="w-12 h-12 text-muted-fg mb-4"></i>
          <h3 class="text-sm font-medium mb-2">${title}</h3>
          <p class="text-xs text-muted-fg max-w-xs">${desc}</p>
        `;
        return div;
      }

      // 创建表卡片
      function createTableCard(tableName, isPrimary, type) {
        const schema = tableSchemas[tableName] || { source: 'Unknown', columns: [] };
        const div = document.createElement('div');
        div.className = `datasource-card ${isPrimary ? 'primary' : ''} shrink-0 animate-slide-in`;
        div.style.cssText = 'animation: slideIn 0.3s ease;';
        
        const columnsHtml = schema.columns.slice(0, 6).map(col => `
          <label class="flex items-center gap-2 text-xs px-2 py-1 rounded hover:bg-muted/50 cursor-pointer">
            <input type="checkbox" class="accent-primary w-3 h-3" checked />
            <span class="flex-1 truncate">${col.name}</span>
            <span class="text-muted-fg text-[10px]">${col.type}</span>
          </label>
        `).join('');
        
        const moreColumns = schema.columns.length > 6 ? `<div class="text-xs text-muted-fg text-center py-1">+${schema.columns.length - 6} 更多字段</div>` : '';
        
        div.innerHTML = `
          <div class="p-3 border-b border-border flex items-center justify-between">
            <div class="flex items-center gap-2">
              <i data-lucide="table" class="w-4 h-4 ${isPrimary ? 'text-primary' : 'text-muted-fg'}"></i>
              <span class="font-medium text-sm">${tableName}</span>
              ${isPrimary ? '<span class="text-[10px] px-1.5 py-0.5 bg-primary/20 text-primary rounded">主表</span>' : ''}
            </div>
            <button onclick="removeTableFromSelection('${tableName}', '${type}')" class="text-muted-fg hover:text-error p-1 rounded hover:bg-error/10" title="移除">
              <i data-lucide="x" class="w-4 h-4"></i>
            </button>
          </div>
          <div class="p-3">
            <div class="text-xs text-muted-fg mb-2 flex items-center gap-1">
              <i data-lucide="database" class="w-3 h-3"></i>
              ${schema.source}
            </div>
            <div class="space-y-0.5 max-h-40 overflow-auto">
              ${columnsHtml}
              ${moreColumns}
            </div>
          </div>
        `;
        
        return div;
      }

      // 创建 JOIN 连接器
      function createJoinConnector(leftTable, rightTable, index) {
        const div = document.createElement('div');
        div.className = 'join-connector shrink-0';
        div.innerHTML = `
          <div class="flex flex-col items-center gap-2 px-2">
            <select class="duck-input text-xs w-28 text-center" id="join-type-${index}">
              <option value="INNER JOIN">INNER JOIN</option>
              <option value="LEFT JOIN" selected>LEFT JOIN</option>
              <option value="RIGHT JOIN">RIGHT JOIN</option>
              <option value="FULL JOIN">FULL JOIN</option>
            </select>
            <div class="w-16 h-0.5 bg-primary/50"></div>
            <div class="text-[10px] text-muted-fg">ON</div>
            <div class="flex items-center gap-1 text-xs">
              <select class="duck-input text-xs py-1 px-2" style="width: 80px;">
                ${getColumnOptions(leftTable)}
              </select>
              <span>=</span>
              <select class="duck-input text-xs py-1 px-2" style="width: 80px;">
                ${getColumnOptions(rightTable)}
              </select>
            </div>
          </div>
        `;
        return div;
      }

      // 创建集合操作连接器
      function createSetConnector(index) {
        const div = document.createElement('div');
        div.className = 'set-connector shrink-0 flex items-center justify-center px-4';
        
        const opText = currentSetOperation.toUpperCase().replace('-', ' ');
        div.innerHTML = `
          <div class="px-3 py-1.5 bg-primary text-white text-xs font-semibold rounded-full">
            ${opText}
          </div>
        `;
        return div;
      }

      // 获取列选项
      function getColumnOptions(tableName) {
        const schema = tableSchemas[tableName];
        if (!schema) return '<option>-</option>';
        return schema.columns.map(col => `<option value="${col.name}">${col.name}</option>`).join('');
      }

      // 从选择中移除表
      function removeTableFromSelection(tableName, type) {
        const tables = selectedTables[type];
        const index = tables.indexOf(tableName);
        if (index > -1) {
          tables.splice(index, 1);
        }
        updateTreeSelection();
        updateContentArea();
      }

      // 清空 JOIN 表
      function clearJoinTables() {
        selectedTables.join = [];
        updateTreeSelection();
        updateJoinContent();
      }

      // 清空集合操作表
      function clearSetTables() {
        selectedTables.set = [];
        updateTreeSelection();
        updateSetContent();
      }

      // 清空透视表配置
      function clearPivotConfig() {
        // 这里可以添加清空透视表配置的逻辑
        console.log('清空透视表配置');
      }

      // SQL 结果面板折叠功能
      let savedSqlResultHeight = 300;
      function toggleSqlResultPane(event) {
        event.stopPropagation();
        const sqlResultPane = document.getElementById('sql-result-pane');
        const sqlEditorPane = document.getElementById('sql-editor-pane');
        const icon = document.getElementById('sql-collapse-icon');
        
        if (!sqlResultPane || !sqlEditorPane) return;
        
        const collapsed = sqlResultPane.classList.contains('collapsed');
        
        if (collapsed) {
          // 展开
          sqlResultPane.classList.remove('collapsed');
          sqlResultPane.style.height = savedSqlResultHeight + 'px';
          if (icon) icon.setAttribute('data-lucide', 'chevron-down');
        } else {
          // 折叠前保存当前高度
          savedSqlResultHeight = sqlResultPane.offsetHeight;
          sqlResultPane.classList.add('collapsed');
          sqlResultPane.style.height = '0px';
          if (icon) icon.setAttribute('data-lucide', 'chevron-up');
        }
        
        lucide.createIcons();
      }

      // JOIN 结果面板折叠功能
      let savedJoinResultHeight = 300;
      function toggleJoinResultPane(event) {
        event.stopPropagation();
        const joinResultPane = document.getElementById('join-result-pane');
        const icon = document.getElementById('join-collapse-icon');
        
        if (!joinResultPane) return;
        
        const collapsed = joinResultPane.classList.contains('collapsed');
        
        if (collapsed) {
          joinResultPane.classList.remove('collapsed');
          joinResultPane.style.height = savedJoinResultHeight + 'px';
          if (icon) icon.setAttribute('data-lucide', 'chevron-down');
        } else {
          savedJoinResultHeight = joinResultPane.offsetHeight;
          joinResultPane.classList.add('collapsed');
          joinResultPane.style.height = '0px';
          if (icon) icon.setAttribute('data-lucide', 'chevron-up');
        }
        
        lucide.createIcons();
      }

      // SET 结果面板折叠功能
      let savedSetResultHeight = 300;
      function toggleSetResultPane(event) {
        event.stopPropagation();
        const setResultPane = document.getElementById('set-result-pane');
        const icon = document.getElementById('set-collapse-icon');
        
        if (!setResultPane) return;
        
        const collapsed = setResultPane.classList.contains('collapsed');
        
        if (collapsed) {
          setResultPane.classList.remove('collapsed');
          setResultPane.style.height = savedSetResultHeight + 'px';
          if (icon) icon.setAttribute('data-lucide', 'chevron-down');
        } else {
          savedSetResultHeight = setResultPane.offsetHeight;
          setResultPane.classList.add('collapsed');
          setResultPane.style.height = '0px';
          if (icon) icon.setAttribute('data-lucide', 'chevron-up');
        }
        
        lucide.createIcons();
      }

      // 切换集合操作类型
      function switchSetOperation(op) {
        currentSetOperation = op;
        
        // 更新按钮状态
        ['union', 'union-all', 'intersect', 'except'].forEach(o => {
          const btn = document.getElementById('set-op-' + o);
          if (btn) {
            if (o === op) {
              btn.className = 'px-2.5 text-xs font-medium rounded bg-surface text-foreground shadow-sm';
            } else {
              btn.className = 'px-2.5 text-xs font-medium rounded text-muted-fg hover:text-foreground';
            }
          }
        });
        
        // 更新内容
        updateSetContent();
      }

      // 更新 JOIN SQL 预览
      function updateJoinSqlPreview() {
        const tables = selectedTables.join;
        if (tables.length === 0) return;
        
        let sql = `<span class="text-purple-400">SELECT</span> *<br/>`;
        sql += `<span class="text-purple-400">FROM</span> ${tables[0]}<br/>`;
        
        for (let i = 1; i < tables.length; i++) {
          const joinType = document.getElementById('join-type-' + (i-1))?.value || 'LEFT JOIN';
          sql += `<span class="text-purple-400">${joinType}</span> ${tables[i]}<br/>`;
          sql += `&nbsp;&nbsp;<span class="text-purple-400">ON</span> ${tables[0]}.id = ${tables[i]}.id<br/>`;
        }
        
        const codeEl = document.getElementById('join-sql-code');
        if (codeEl) codeEl.innerHTML = sql;
      }

      // 更新集合操作 SQL 预览
      function updateSetSqlPreview() {
        const tables = selectedTables.set;
        if (tables.length === 0) return;
        
        const byName = document.getElementById('set-byname-checkbox')?.checked;
        const opText = currentSetOperation.toUpperCase().replace('-', ' ') + (byName ? ' BY NAME' : '');
        
        let sql = '';
        tables.forEach((table, i) => {
          sql += `<span class="text-purple-400">SELECT</span> * <span class="text-purple-400">FROM</span> ${table}`;
          if (i < tables.length - 1) {
            sql += `<br/><br/><span class="text-purple-400">${opText}</span><br/><br/>`;
          }
        });
        
        const codeEl = document.getElementById('set-sql-code');
        if (codeEl) codeEl.innerHTML = sql;
      }

      // 重写 switchThirdTab 函数
      const originalSwitchThirdTab = switchThirdTab;
      switchThirdTab = function(tab) {
        currentTab = tab;
        
        // 调用原始函数
        originalSwitchThirdTab(tab);
        
        // 更新左侧树的选中状态
        updateTreeSelection();
      };

      // 添加 CSS 动画
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { opacity: 0; transform: translateX(-20px); }
          to { opacity: 1; transform: translateX(0); }
        }
        .animate-slide-in { animation: slideIn 0.3s ease; }
        .datasource-card {
          border: 1px solid hsl(var(--dq-border));
          border-radius: 0.75rem;
          background: hsl(var(--dq-surface));
          transition: all 0.2s;
          min-width: 240px;
          max-width: 280px;
        }
        .datasource-card:hover {
          border-color: hsl(var(--dq-primary) / 0.5);
        }
        .datasource-card.primary {
          border-color: hsl(var(--dq-primary));
          box-shadow: 0 0 0 1px hsl(var(--dq-primary) / 0.2);
        }
        .tree-item.selected {
          background-color: hsl(var(--dq-primary) / 0.15);
          border: 1px solid hsl(var(--dq-primary) / 0.3);
        }
      `;
      document.head.appendChild(style);

      // 初始化
      document.addEventListener('DOMContentLoaded', function() {
        // 默认选中 sales_data
        selectedTables.visual = ['sales_data'];
        updateTreeSelection();
      });
    </script>

    <!-- ========== JSON 展开配置对话框（完整版）========== -->
    <div
      id="json-configurator-dialog"
      class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center"
      style="z-index: 60;"
      onclick="if(event.target === this) closeJsonConfigurator()"
    >
      <div
        class="bg-surface border border-border rounded-xl shadow-2xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col"
      >
        <!-- 对话框头部 -->
        <div
          class="flex items-center justify-between p-5 border-b border-border shrink-0"
        >
          <div class="flex items-center gap-3">
            <div
              class="w-10 h-10 rounded-lg bg-warning/10 flex items-center justify-center"
            >
              <i data-lucide="braces" class="w-5 h-5 text-warning"></i>
            </div>
            <div>
              <h3 class="text-lg font-semibold">JSON 字段展开配置</h3>
              <p class="text-sm text-muted-fg">配置 JSON_TABLE 提取嵌套数据</p>
            </div>
          </div>
          <button
            onclick="closeJsonConfigurator()"
            class="text-muted-fg hover:text-foreground p-1"
          >
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <!-- 对话框内容 -->
        <div class="flex-1 overflow-y-auto p-5 space-y-4">
          <!-- 源 JSON 列 -->
          <div>
            <label class="text-sm font-medium mb-2 block">
              源 JSON 列 <span class="text-error">*</span>
            </label>
            <select class="duck-input" id="json-source-column">
              <option selected>metadata</option>
              <option>user_data</option>
              <option>config_json</option>
            </select>
          </div>

          <!-- 行路径 -->
          <div>
            <label class="text-sm font-medium mb-2 block">
              行路径 (Row Path) <span class="text-error">*</span>
            </label>
            <input
              type="text"
              class="duck-input font-mono text-sm"
              value="$.items[*]"
              placeholder="例: $.data[*] 或 $.users[*]"
            />
            <div class="text-xs text-muted-fg mt-1 flex items-start gap-1">
              <i data-lucide="info" class="w-3 h-3 mt-0.5 shrink-0"></i>
              <span>
                使用 JSONPath 语法。<code class="px-1 bg-muted rounded">$</code>
                表示根节点，
                <code class="px-1 bg-muted rounded">[*]</code> 表示数组所有元素
              </span>
            </div>
          </div>

          <!-- 关联方式 -->
          <div>
            <label class="text-sm font-medium mb-2 block">关联方式</label>
            <div class="flex gap-3">
              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="json-join-type"
                  value="left"
                  checked
                  class="accent-primary"
                />
                <span class="text-sm">LEFT JOIN - 保留主表所有行</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="json-join-type"
                  value="inner"
                  class="accent-primary"
                />
                <span class="text-sm">INNER JOIN - 仅保留匹配行</span>
              </label>
            </div>
          </div>

          <!-- 字段映射列表 -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <label class="text-sm font-medium">
                字段映射 <span class="text-error">*</span>
              </label>
              <button
                class="text-xs text-primary hover:underline flex items-center gap-1"
                onclick="addJsonFieldMapping()"
              >
                <i data-lucide="plus" class="w-3 h-3"></i>
                添加字段
              </button>
            </div>

            <div class="space-y-2" id="json-field-mappings">
              <!-- 字段映射行 -->
              <div
                class="grid grid-cols-12 gap-2 items-center p-2 border border-border rounded bg-muted/20"
              >
                <div class="col-span-3">
                  <input
                    type="text"
                    class="duck-input text-sm"
                    value="item_name"
                    placeholder="列名"
                  />
                </div>
                <div class="col-span-4">
                  <input
                    type="text"
                    class="duck-input font-mono text-sm"
                    value="$.name"
                    placeholder="JSON 路径"
                  />
                </div>
                <div class="col-span-3">
                  <select class="duck-input text-sm">
                    <option selected>VARCHAR</option>
                    <option>INTEGER</option>
                    <option>DOUBLE</option>
                    <option>BOOLEAN</option>
                    <option>DATE</option>
                    <option>TIMESTAMP</option>
                    <option>JSON</option>
                  </select>
                </div>
                <div class="col-span-2 flex items-center gap-1">
                  <input
                    type="checkbox"
                    class="accent-primary"
                    title="允许为空"
                  />
                  <span class="text-xs text-muted-fg">NULL</span>
                  <button
                    class="text-error hover:bg-error/10 p-1 rounded ml-auto"
                    onclick="removeJsonFieldMapping(this)"
                    title="删除"
                  >
                    <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                  </button>
                </div>
              </div>

              <div
                class="grid grid-cols-12 gap-2 items-center p-2 border border-border rounded bg-muted/20"
              >
                <div class="col-span-3">
                  <input
                    type="text"
                    class="duck-input text-sm"
                    value="item_price"
                    placeholder="列名"
                  />
                </div>
                <div class="col-span-4">
                  <input
                    type="text"
                    class="duck-input font-mono text-sm"
                    value="$.price"
                    placeholder="JSON 路径"
                  />
                </div>
                <div class="col-span-3">
                  <select class="duck-input text-sm">
                    <option>VARCHAR</option>
                    <option>INTEGER</option>
                    <option selected>DOUBLE</option>
                    <option>BOOLEAN</option>
                  </select>
                </div>
                <div class="col-span-2 flex items-center gap-1">
                  <input type="checkbox" class="accent-primary" />
                  <span class="text-xs text-muted-fg">NULL</span>
                  <button
                    class="text-error hover:bg-error/10 p-1 rounded ml-auto"
                    onclick="removeJsonFieldMapping(this)"
                  >
                    <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- 列头提示 -->
            <div
              class="grid grid-cols-12 gap-2 text-xs text-muted-fg mt-1 px-2"
            >
              <div class="col-span-3">列名</div>
              <div class="col-span-4">JSON 路径</div>
              <div class="col-span-3">数据类型</div>
              <div class="col-span-2">选项</div>
            </div>
          </div>

          <!-- SQL 预览 -->
          <div>
            <label
              class="text-sm font-medium mb-2 block flex items-center gap-2"
            >
              <i data-lucide="code" class="w-4 h-4"></i>
              生成的 SQL
            </label>
            <pre class="code-block text-xs overflow-x-auto">
SELECT
  t.*,
  jt.item_name,
  jt.item_price
FROM sales_data t
LEFT JOIN JSON_TABLE(
  t.metadata,
  '$.items[*]',
  COLUMNS(
    item_name VARCHAR PATH '$.name',
    item_price DOUBLE PATH '$.price'
  )
) AS jt ON true</pre
            >
          </div>
        </div>

        <!-- 对话框底部按钮 -->
        <div class="flex justify-end gap-3 p-5 border-t border-border shrink-0">
          <button
            onclick="closeJsonConfigurator()"
            class="px-4 py-2 border border-border rounded-md text-sm font-medium hover:bg-surface-hover"
          >
            取消
          </button>
          <button
            class="px-4 py-2 bg-primary text-primary-foreground rounded-md text-sm font-medium hover:opacity-90"
            onclick="applyJsonConfiguration()"
          >
            应用配置
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
