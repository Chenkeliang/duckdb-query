version: '3.8'

services:
  # 后端API服务
  backend:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: dataquery-backend
    ports:
      - "8000:8000"
    environment:
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - ENV=development
    volumes:
      - ./api:/app
      - ./data:/app/data
    networks:
      - dataquery-network
    restart: unless-stopped

  # 前端服务 (简化版)
  frontend:
    image: node:18-alpine
    container_name: dataquery-frontend
    working_dir: /app
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:8000
      - REACT_APP_UI_MODE=modern
      - CHOKIDAR_USEPOLLING=true
    volumes:
      - ./frontend:/app
      - /app/node_modules
    networks:
      - dataquery-network
    depends_on:
      - backend
    restart: unless-stopped
    command: >
      sh -c "
        echo '🎨 安装现代化UI依赖...' &&
        npm install &&
        npm install @fontsource/inter ag-grid-react ag-grid-community &&
        echo '📝 配置现代化UI...' &&
        mkdir -p src/theme src/components/Layout src/styles &&
        cat > src/theme/modernTheme.js << 'EOF'
      import { createTheme } from '@mui/material/styles';
      export const modernTheme = createTheme({
        palette: {
          primary: { main: '#2563eb' },
          background: { default: '#f8fafc' }
        },
        typography: {
          fontFamily: 'Inter, sans-serif'
        }
      });
      export default modernTheme;
      EOF
        cat > src/styles/modern.css << 'EOF'
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
      body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
      EOF
        cat > src/ModernApp.jsx << 'EOF'
      import React from 'react';
      import { ThemeProvider, CssBaseline, Box, AppBar, Toolbar, Typography, Container } from '@mui/material';
      import { modernTheme } from './theme/modernTheme';
      import App from './App';
      import './styles/modern.css';
      
      const ModernApp = () => (
        <ThemeProvider theme={modernTheme}>
          <CssBaseline />
          <Box sx={{ minHeight: '100vh', backgroundColor: 'background.default' }}>
            <AppBar position='static' elevation={1}>
              <Toolbar>
                <Typography variant='h6' sx={{ fontWeight: 600 }}>
                  DataQuery Pro - 现代化数据分析平台
                </Typography>
              </Toolbar>
            </AppBar>
            <Container maxWidth='xl' sx={{ py: 3 }}>
              <App />
            </Container>
          </Box>
        </ThemeProvider>
      );
      export default ModernApp;
      EOF
        cat > src/index.js << 'EOF'
      import React from 'react';
      import ReactDOM from 'react-dom/client';
      import ModernApp from './ModernApp';
      
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<ModernApp />);
      EOF
        echo '🚀 启动开发服务器...' &&
        npm start
      "

networks:
  dataquery-network:
    driver: bridge
