# 统一查询界面整合方案

## 项目背景

当前系统存在两个独立的查询功能模块：
1. **查询TAB页**：图形化查询构建器，支持多表JOIN可视化配置
2. **SQL执行器TAB页**：直接SQL语句执行，支持任意复杂查询

为了提升用户体验和功能整合度，需要将这两个模块合并为统一的查询界面。

## 当前功能分析

### 查询TAB页功能
- 图形化查询构建器（拖拽式多表连接）
- 支持JOIN可视化配置
- 自动列名优化
- 结果表格展示优化

### SQL执行器TAB页功能
- 直接SQL语句执行
- 支持任意复杂查询
- 数据库连接管理
- 结果展示（基础表格）

## 整合目标

### 核心目标
1. **功能统一**：保留两个模块的所有功能
2. **界面优化**：提供一致的用户体验
3. **能力增强**：结合两者优势，提供更多查询方式

### 具体目标
1. 保留图形化查询构建器的所有功能
2. 保留SQL直接执行的所有功能
3. 统一结果展示界面（使用已优化的StableTable组件）
4. 统一数据库连接管理
5. 提供灵活的查询模式切换

## 技术实现方案

### 架构设计

```
统一查询页面布局：
┌─────────────────────────────────────────────────────────────┐
│ 数据源管理区域                                               │
│ ┌─────────────────┬─────────────────┬─────────────────┐ │
│ │ 文件上传        │ DuckDB表管理    │ 数据库连接      │ │
│ │ (现有功能保留)  │ (现有功能保留)  │ (现有功能保留)  │ │
│ └─────────────────┴─────────────────┴─────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 查询构建区域                                                 │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 模式切换：[图形化查询] [SQL编辑器]                      │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ 图形化查询模式：                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 拖拽画布区域（保持现有功能）                            │ │
│ │ 表选择器、JOIN配置器、条件构建器                         │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ SQL编辑器模式：                                             │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ SQL代码编辑区域（新增功能）                             │ │
│ │ 语法高亮、代码提示、执行计划分析                        │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 结果展示区域                                                 │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 优化的表格展示（已实现的StableTable组件）               │ │
│ │ 分页控制、导出功能、统计信息                             │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 组件设计

#### 1. 查询模式切换组件
```javascript
const QueryModeSwitcher = ({ mode, onModeChange }) => {
  return (
    <div className="query-mode-switcher">
      <button 
        className={mode === 'visual' ? 'active' : ''}
        onClick={() => onModeChange('visual')}
      >
        图形化查询
      </button>
      <button 
        className={mode === 'sql' ? 'active' : ''}
        onClick={() => onModeChange('sql')}
      >
        SQL编辑器
      </button>
    </div>
  );
};
```

#### 2. SQL编辑器组件
```javascript
const SqlEditor = ({ value, onChange, onExecute }) => {
  return (
    <div className="sql-editor-container">
      <CodeMirror
        value={value}
        onChange={onChange}
        options={{
          mode: 'text/x-sql',
          theme: 'material',
          lineNumbers: true,
          autoCloseBrackets: true,
          matchBrackets: true,
          highlightSelectionMatches: { showToken: /\w/ }
        }}
      />
      <div className="editor-toolbar">
        <Button onClick={onExecute}>执行查询</Button>
        <Button onClick={formatSql}>格式化</Button>
        <Button onClick={showExecutionPlan}>执行计划</Button>
      </div>
    </div>
  );
};
```

#### 3. 统一结果处理器
```javascript
const processQueryResults = (rawData) => {
  // 处理来自不同来源的数据格式
  if (rawData._proxy_processed) {
    // 来自查询代理的结果（已优化）
    return {
      data: rawData.data,
      columns: rawData.columns,
      metadata: {
        rowCount: rawData.data?.length || 0,
        executionTime: rawData._proxy_timestamp
      }
    };
  } else {
    // 来自直接SQL执行的结果
    return {
      data: rawData.data || [],
      columns: rawData.columns || [],
      metadata: {
        rowCount: rawData.row_count || 0,
        executionTime: new Date().toISOString()
      }
    };
  }
};
```

### API接口规划

```
整合后的API结构：
/api/query_proxy          # 统一查询接口（保持兼容）
/api/file_upload          # 文件上传（保持现有）
/api/duckdb_tables        # DuckDB表管理（保持现有）
/api/database_connections # 数据库连接（保持现有）
/api/query_builder        # 新增：查询构建辅助接口
```

## 功能实现细节

### 1. 模式切换实现
```javascript
const UnifiedQueryInterface = () => {
  const [mode, setMode] = useState('visual'); // 'visual' | 'sql'
  const [visualQuery, setVisualQuery] = useState(null);
  const [sqlQuery, setSqlQuery] = useState('');
  
  const handleExecute = () => {
    if (mode === 'visual') {
      // 使用现有图形化查询逻辑
      executeVisualQuery(visualQuery);
    } else {
      // 使用新的SQL执行逻辑
      executeSqlQuery(sqlQuery);
    }
  };
};
```

### 2. 数据源管理整合
```javascript
const DataSourceManager = () => {
  return (
    <div className="data-source-manager">
      <FileUploader />
      <DuckDBTableManager />
      <DatabaseConnectionManager />
    </div>
  );
};
```

### 3. 查询执行统一
```javascript
const executeQuery = async (queryConfig, mode) => {
  try {
    let response;
    
    if (mode === 'visual') {
      // 图形化查询使用现有代理接口
      response = await fetch('/api/query_proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(queryConfig)
      });
    } else {
      // SQL查询使用新的执行接口
      response = await fetch('/api/execute_sql', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          sql: queryConfig.sql,
          datasource: queryConfig.datasource
        })
      });
    }
    
    const rawData = await response.json();
    return processQueryResults(rawData);
  } catch (error) {
    throw new Error(`查询执行失败: ${error.message}`);
  }
};
```

## 现有功能保留策略

### 1. DuckDB表管理功能
- ✅ 表创建（从文件）
- ✅ 表查询（SELECT *）
- ✅ 表删除（含源文件清理）
- ✅ 表信息查看（结构、统计）

### 2. 文件上传功能
- ✅ CSV文件上传和解析
- ✅ Excel文件上传和解析
- ✅ 文件预览（前N行）
- ✅ 文件元信息显示

### 3. 数据库连接功能
- ✅ 连接配置和测试
- ✅ 连接状态管理
- ✅ 多种数据库支持

## 增强功能

### 1. SQL编辑器增强
- 语法高亮显示
- 代码自动补全
- 执行计划分析
- 格式化工具

### 2. 查询历史管理
```javascript
const QueryHistoryManager = () => {
  const [history, setHistory] = useState([]);
  
  const saveQuery = (query, mode, timestamp) => {
    const historyItem = {
      id: generateId(),
      query: query,
      mode: mode,
      timestamp: timestamp,
      name: `查询_${timestamp.toLocaleString()}`
    };
    setHistory([...history, historyItem]);
  };
  
  return (
    <div className="query-history">
      <h3>查询历史</h3>
      {history.map(item => (
        <div key={item.id} className="history-item">
          <span>{item.name}</span>
          <button onClick={() => loadQuery(item)}>加载</button>
        </div>
      ))}
    </div>
  );
};
```

### 3. 性能监控
```javascript
const PerformanceMonitor = ({ query, executionTime }) => {
  return (
    <div className="performance-monitor">
      <div className="metrics">
        <span>执行时间: {executionTime}ms</span>
        <span>返回行数: {query.rowCount}</span>
        <span>数据源: {query.sources.length}个</span>
      </div>
      {executionTime > 5000 && (
        <div className="performance-warning">
          ⚠️ 查询执行时间较长，建议优化查询条件或使用分页
        </div>
      )}
    </div>
  );
};
```

## 实施步骤

### 第一阶段：架构设计与准备（1-2天）
1. 设计统一界面布局
2. 分析组件依赖关系
3. 规划API接口

### 第二阶段：核心功能整合（3-5天）
1. 实现查询模式切换
2. 集成SQL编辑器
3. 统一结果处理流程

### 第三阶段：功能增强与优化（2-3天）
1. 添加查询历史管理
2. 实现性能监控
3. 优化用户体验

### 第四阶段：测试与部署（1-2天）
1. 功能完整性测试
2. 兼容性测试
3. 性能基准测试

## 预期成果

### 功能完整性
- ✅ 保留所有现有DuckDB功能
- ✅ 增强查询构建能力
- ✅ 统一用户界面体验

### 用户体验提升
- ✅ 更直观的操作界面
- ✅ 更强大的查询能力
- ✅ 更好的性能表现

### 技术优势
- ✅ 代码复用度高，维护成本低
- ✅ 架构清晰，扩展性强
- ✅ 安全性保障完善

## 风险控制

### 功能回滚预案
```javascript
// 功能开关配置
const FEATURE_FLAGS = {
  unifiedQueryInterface: true,
  sqlEditorEnhancement: true,
  visualQueryBuilder: true
};

// 条件渲染新版界面
{FEATURE_FLAGS.unifiedQueryInterface ? (
  <UnifiedQueryInterface />
) : (
  <LegacyQueryInterface />
)}
```

### 数据安全保护
```python
# SQL注入防护增强
def sanitize_sql_query(query: str) -> str:
    """ 增强SQL查询安全检查 """
    # 禁止危险关键字
    dangerous_keywords = ['DROP', 'DELETE', 'UPDATE', 'INSERT', 'TRUNCATE']
    query_upper = query.upper()
    
    for keyword in dangerous_keywords:
        if keyword in query_upper and not query_upper.strip().startswith(keyword):
            raise ValueError(f"查询包含禁止的操作: {keyword}")
    
    # 使用参数化查询预防注入
    return query
```

### 性能监控告警
```javascript
// 前端性能监控
class PerformanceMonitor {
  static measureExecution(name, fn) {
    const start = performance.now();
    const result = fn();
    const end = performance.now();
    const duration = end - start;
    
    // 记录性能指标
    console.log(`${name} 执行耗时: ${duration.toFixed(2)}ms`);
    
    // 性能警告
    if (duration > 5000) {
      console.warn(`性能警告: ${name} 执行时间过长 (${duration.toFixed(2)}ms)`);
    }
    return result;
  }
}
```

## 测试计划

### 功能测试清单
```
测试项目清单：
□ 文件上传功能完整（CSV、Excel、JSON）
□ DuckDB表创建、查询、删除功能
□ 数据库连接配置和测试
□ 图形化查询构建器（拖拽、JOIN、条件）
□ SQL编辑器（语法高亮、代码提示）
□ 查询执行（图形化模式、SQL模式）
□ 结果展示（表格优化、分页、导出）
□ 查询历史和模板管理
□ 性能监控和警告
```

### 兼容性测试
- 浏览器兼容性测试（Chrome、Firefox、Safari）
- 移动端适配测试
- 不同分辨率下的布局测试

### 性能基准测试
```
性能测试指标：
- 页面加载时间 < 2秒
- 查询执行响应时间 < 10秒（大数据集除外）
- 文件上传处理时间 < 30秒（100MB以内）
- 表格渲染时间 < 1秒（1000行以内）
```

这个整合方案能够在保留所有现有功能的前提下，实现查询界面的现代化改造，提供更好的用户体验和更强大的功能。