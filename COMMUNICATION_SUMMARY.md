# DuckQuery 项目沟通总结

## 沟通时间
2024年12月 - 关于DuckDB性能优化和内存管理

## 主要讨论内容

### 1. 项目架构分析
- **文件上传机制**：分析了当前项目的文件上传和导入DuckDB表的实现逻辑
- **DuckDB官方方法**：研究了DuckDB读取Excel、CSV、JSON、Parquet的官方方式
- **设计问题探讨**：讨论了是否可以直接使用DuckDB的`SELECT FROM 文件路径`方式，避免文件上传

### 2. 多表关联查询
- **跨格式关联**：确认了Excel + CSV + Parquet多格式文件的关联查询可行性
- **实现方式**：分析了项目多表关联的实现机制，确认完全基于DuckDB
- **架构确认**：验证了"数据湖 + 统一查询引擎"的架构设计

### 3. 性能优化方案
- **直接文件访问**：探讨了用户拖拽文件获取本地地址，DuckDB直接读取的设计方案
- **Docker卷挂载**：设计了Docker volume mounts配置以支持直接文件访问
- **性能对比**：比较了直接文件读取、持久化表、视图三种方式的性能差异

### 4. 大规模性能测试
- **测试数据生成**：创建了大规模测试数据（A表500万行20列，B表1000万行30列，C表700万行10列）
- **FULL OUTER JOIN测试**：进行了完整的FULL OUTER JOIN性能测试
- **性能排名修正**：发现持久化表在大数据量下性能反而最差，修正了性能排名

### 5. 内存管理问题
- **502错误分析**：分析了Docker环境下的502 Bad Gateway错误
- **内存爆炸问题**：诊断了2.5GB CSV文件导致8GB+内存占用的问题
- **异步查询优化**：优化了异步查询的内存使用，使用DuckDB的COPY命令替代fetchdf()

## 关键技术发现

### 性能测试结果
1. **直接文件访问**：在大数据量下表现最佳，内存压力小
2. **视图**：性能中等，适合实时数据查询
3. **持久化表**：在小数据量下最优，但大数据量下因内存压力导致性能下降

### 内存使用分析
- **COPY命令**：虽然是流式写入，但DuckDB内部仍会缓存数据，导致2-3倍内存放大
- **fetchdf()方法**：会将整个查询结果加载到Python内存，是内存爆炸的主要原因
- **重复数据处理**：create_table_from_dataframe会重新加载已写入的文件，造成内存浪费

### 优化建议
1. **使用DuckDB原生COPY命令**：避免Python内存加载
2. **避免重复数据加载**：直接基于已存在的DuckDB表导出
3. **合理设置内存限制**：使用PRAGMA memory_limit控制DuckDB内存使用
4. **Docker资源限制**：合理配置Docker内存限制，避免OOM

## 代码修改记录

### 主要修改文件
1. **api/routers/async_tasks.py**：
   - 使用COPY命令替代fetchdf()
   - 添加内存清理机制
   - 优化元数据获取方式

2. **docker-compose.yml**：
   - 调整Docker内存限制（8GB -> 16GB -> 8GB）
   - 配置DuckDB内存限制环境变量

3. **.dockerignore**：
   - 新增文件，排除大目录以优化Docker构建

4. **api/Dockerfile**：
   - 优化构建过程，只复制必要文件

### 测试文件
- **test/generate_test_data.py**：生成大规模测试数据的脚本
- **test/performance_benchmark.py**：性能基准测试
- **test/diagnose_performance.py**：性能诊断工具
- **test/full_join_test.py**：完整JOIN测试
- **test/full_join_comparison.py**：JOIN方式对比测试
- **test/verify_data_relationships.py**：数据关系验证

## 最终结论

### 性能排名（大数据量场景）
1. **直接文件访问** > **视图** > **持久化表**

### 内存优化策略
1. **避免fetchdf()**：使用DuckDB原生COPY命令
2. **减少重复加载**：直接基于已存在表导出
3. **合理内存限制**：设置PRAGMA memory_limit
4. **Docker资源管理**：合理配置容器资源限制

### 架构建议
1. **混合策略**：根据数据量大小选择不同策略
2. **直接文件访问**：适合大文件和临时查询
3. **持久化表**：适合小文件和频繁查询
4. **视图**：适合实时数据查询

## 后续优化方向
1. 实现智能策略选择（根据文件大小自动选择处理方式）
2. 优化Docker配置和资源管理
3. 实现更精细的内存监控和清理机制
4. 考虑实现流式处理以进一步减少内存使用

---
*总结时间：2024年12月*
*项目：DuckQuery - DuckDB查询平台*
