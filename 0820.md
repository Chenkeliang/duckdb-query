# 数据源管理功能改造技术方案

## 1. 需求背景

当前系统在上传文件时存在以下问题：
1. 上传时自定义表别名未正确应用
2. 删除已上传文件后仍在列表中显示
3. 分块上传功能未完整集成

## 2. 技术目标

1. 修复文件上传时表别名未应用的问题
2. 修复删除文件后列表未更新的问题
3. 完善分块上传功能集成
4. 保持现有功能完整性

## 3. 改造范围

### 3.1 后端改造

#### 3.1.1 `/api/upload` 接口增强
文件：`api/routers/data_sources.py`

修改点：
1. 添加 `table_alias` 表单参数支持
2. 优化表名生成逻辑，优先使用用户提供的表别名
3. 保持向后兼容性

```python
@router.post("/api/upload", tags=["Data Sources"])
async def upload_file(
    background_tasks: BackgroundTasks, 
    file: UploadFile = File(...), 
    table_alias: str = Form(None)  # 新增参数
) -> FileUploadResponse:
    # ...
    # 表名生成逻辑修改
    if table_alias:
        # 使用用户提供的表别名
        source_id = table_alias
    else:
        # 使用文件名作为默认表名
        source_id = file.filename.split(".")[0]
    # ...
```

#### 3.1.2 `/api/duckdb/tables/{table_name}` 删除接口增强
文件：`api/routers/duckdb_query.py`

修改点：
1. 删除表的同时删除对应的文件数据源记录
2. 添加错误处理和日志记录

```python
@router.delete("/api/duckdb/tables/{table_name}", tags=["DuckDB Query"])
async def delete_duckdb_table(table_name: str):
    # ...
    # 删除表
    drop_sql = f'DROP TABLE IF EXISTS "{table_name}"'
    con.execute(drop_sql)
    
    # 同时尝试删除文件数据源记录
    try:
        file_datasource_manager.delete_file_datasource(table_name)
        logger.info(f"已删除文件数据源记录: {table_name}")
    except Exception as e:
        logger.warning(f"删除文件数据源记录失败: {str(e)}")
    # ...
```

### 3.2 前端改造

#### 3.2.1 API客户端修改
文件：`frontend/src/services/apiClient.js`

修改点：
1. 修改 `uploadFile` 函数支持 `tableAlias` 参数
2. 确保参数正确传递到后端

```javascript
export const uploadFile = async (file, tableAlias = null) => {
  const formData = new FormData();
  formData.append('file', file);
  if (tableAlias) {
    formData.append('table_alias', tableAlias);
  }
  // ...
};
```

#### 3.2.2 数据上传组件修改
文件：`frontend/src/components/DataSourceManagement/DataUploadSection.jsx`

修改点：
1. 在调用 `uploadFile` 时传递 `tableAlias` 参数
2. 保持UI交互一致性

```javascript
const handleStandardUpload = async () => {
  // ...
  const response = await uploadFile(selectedFile, tableAlias);
  // ...
};
```

## 4. 注意事项

### 4.1 导入路径问题
1. Docker容器中工作目录为 `/app`
2. 所有相对导入需改为绝对导入
3. 验证所有导入语句正确性

### 4.2 函数可用性验证
1. 修改前需确认目标函数在目标模块中存在
2. 参考原代码中的导入方式
3. 必要时查阅模块源码确认函数签名

### 4.3 向后兼容性
1. 添加的参数需设默认值
2. 保持原有调用方式不受影响
3. 避免破坏现有功能

### 4.4 错误处理
1. 添加适当的异常捕获
2. 提供有意义的错误信息
3. 记录必要日志便于调试

### 4.5 测试验证
1. 文件上传功能测试（含表别名）
2. 文件删除功能测试
3. 分块上传功能测试
4. 边界条件测试（大文件、特殊字符等）

## 5. 部署验证

1. 构建Docker镜像
2. 启动容器服务
3. 验证各功能点
4. 检查日志无错误信息

## 6. 回滚预案

如遇严重问题：
1. 回退到修改前分支状态
2. 重新评估修改方案
3. 分步骤渐进式修改
4. 每步修改后验证功能