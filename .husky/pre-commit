#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# DuckQuery Git Pre-commit Hook
# åœ¨æäº¤å‰è‡ªåŠ¨æ£€æŸ¥ä»£ç è§„èŒƒ

echo "ğŸ” è¿è¡Œä»£ç è§„èŒƒæ£€æŸ¥..."

# è·å–æš‚å­˜çš„æ–‡ä»¶
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# æ£€æŸ¥å‰ç«¯æ–‡ä»¶
FRONTEND_FILES=$(echo "$STAGED_FILES" | grep "^frontend/src/" || true)
if [ -n "$FRONTEND_FILES" ]; then
    echo "ğŸ“¦ æ£€æŸ¥å‰ç«¯æ–‡ä»¶..."
    cd frontend
    npm run lint -- --quiet
    FRONTEND_EXIT=$?
    cd ..
    
    if [ $FRONTEND_EXIT -ne 0 ]; then
        echo "âŒ å‰ç«¯ä»£ç æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åå†æäº¤"
        exit 1
    fi
fi

# æ£€æŸ¥åç«¯æ–‡ä»¶
BACKEND_FILES=$(echo "$STAGED_FILES" | grep "^api/" | grep "\.py$" || true)
if [ -n "$BACKEND_FILES" ]; then
    echo "ğŸ æ£€æŸ¥åç«¯æ–‡ä»¶..."
    cd api
    echo "$BACKEND_FILES" | xargs pylint --rcfile=../.pylintrc
    BACKEND_EXIT=$?
    cd ..
    
    if [ $BACKEND_EXIT -ne 0 ]; then
        echo "âŒ åç«¯ä»£ç æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åå†æäº¤"
        exit 1
    fi
fi

echo "âœ… ä»£ç æ£€æŸ¥é€šè¿‡"
exit 0
