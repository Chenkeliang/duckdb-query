#!/bin/sh

# . "$(dirname "$0")/_/husky.sh" # Removed dependency


# DuckQuery Git Pre-commit Hook
# åœ¨æäº¤å‰è‡ªåŠ¨æ£€æŸ¥ä»£ç è§„èŒƒ

echo "ğŸ” è¿è¡Œä»£ç è§„èŒƒæ£€æŸ¥..."

# è·å–æš‚å­˜çš„æ–‡ä»¶
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# æ£€æŸ¥å‰ç«¯æ–‡ä»¶
FRONTEND_FILES=$(echo "$STAGED_FILES" | grep "^frontend/src/" || true)
if [ -n "$FRONTEND_FILES" ]; then
    echo "ğŸ“¦ æ£€æŸ¥å‰ç«¯æ–‡ä»¶..."
    cd frontend
    npm run lint -- --quiet
    FRONTEND_EXIT=$?
    cd ..
    
    if [ $FRONTEND_EXIT -ne 0 ]; then
        echo "âŒ å‰ç«¯ä»£ç æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åå†æäº¤"
        exit 1
    fi
fi

# æ£€æŸ¥åç«¯æ–‡ä»¶ï¼ˆæ’é™¤ scripts ç›®å½•ï¼Œå› ä¸ºæ˜¯ä¸€æ¬¡æ€§è„šæœ¬ï¼‰
BACKEND_FILES=$(echo "$STAGED_FILES" | grep "^api/" | grep "\.py$" | grep -v "^api/scripts/" || true)
if [ -n "$BACKEND_FILES" ]; then
    echo "ğŸ æ£€æŸ¥åç«¯æ–‡ä»¶..."
    
    # å°è¯•æ£€æµ‹ Python ç¯å¢ƒ
    if [ -f ".venv/bin/python" ]; then
        PYTHON_CMD=".venv/bin/python"
    elif [ -f "api/.venv/bin/python" ]; then
        PYTHON_CMD="api/.venv/bin/python"
    else
        PYTHON_CMD="python"
    fi
    
    # è®¾ç½® PYTHONPATH ä»¥ç¡®ä¿èƒ½å¤Ÿè§£æ core ç­‰æ¨¡å—
    export PYTHONPATH=$PYTHONPATH:$(pwd)/api
    
    # è¿è¡Œ Pylint
    # æ³¨æ„ï¼šåœ¨æ ¹ç›®å½•è¿è¡Œï¼Œfiles è·¯å¾„åŸæœ¬å°±æ˜¯ relative to root (api/...)
    echo "$BACKEND_FILES" | xargs $PYTHON_CMD -m pylint --rcfile=api/.pylintrc
    BACKEND_EXIT=$?
    
    if [ $BACKEND_EXIT -ne 0 ]; then
        echo "âŒ åç«¯ä»£ç æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åå†æäº¤"
        exit 1
    fi
fi

echo "âœ… ä»£ç æ£€æŸ¥é€šè¿‡"
exit 0
