# 异步任务结果下载格式支持 - 前端实现说明

## 功能概述

前端实现了对异步任务结果下载格式的完整支持，用户可以在下载时选择所需的文件格式：

1. **Parquet格式**（默认）- 高效的列式存储格式，适合大数据处理
2. **CSV格式** - 通用的表格数据格式，易于在各种工具中打开和处理

## 核心功能实现

### 1. 格式解析

前端能够正确解析后端返回的任务查询信息，提取出任务使用的格式信息：

```javascript
const parseQueryInfo = (query) => {
  try {
    // 尝试解析JSON格式的查询信息
    const queryInfo = JSON.parse(query.replace(/'/g, '"'));
    if (typeof queryInfo === 'object' && queryInfo.format) {
      return queryInfo.format.toLowerCase();
    }
  } catch (e) {
    // 如果不是JSON格式，尝试从字符串中提取格式信息
    const formatMatch = query.match(/['"]format['"]\s*:\s*['"]([^'"]+)['"]/);
    if (formatMatch && formatMatch[1]) {
      return formatMatch[1].toLowerCase();
    }
  }
  // 默认返回parquet格式
  return 'parquet';
};
```

### 2. UI展示

在异步任务列表中，每个任务都会显示其使用的输出格式，用户可以清楚地看到任务是以什么格式生成的。

### 3. 格式选择对话框

前端提供了一个格式选择对话框，用户可以：
- 查看当前任务的格式信息
- 选择下载格式（虽然目前任务完成后格式已锁定）
- 查看不同格式的特点说明
- 确认下载

### 4. API调用增强

前端API调用已增强，支持传递格式参数：

```javascript
// 提交异步查询时支持指定格式
export const submitAsyncQuery = async (sql, format = 'parquet') => {
  try {
    const response = await apiClient.post('/api/async_query', { sql, format });
    return response.data;
  } catch (error) {
    console.error('提交异步查询失败:', error);
    throw error;
  }
};
```

## 前端组件实现

### 1. 异步任务列表组件

在`/src/components/AsyncTasks/AsyncTaskList.jsx`中：

1. **格式解析函数**：
   - `parseQueryInfo`函数解析任务查询信息并提取格式
   - 自动识别任务的输出格式并在UI中显示

2. **格式显示**：
   - 在任务列表中，每个任务的查询语句下方显示格式标签
   - 例如："PARQUET 格式"或"CSV 格式"

3. **下载按钮增强**：
   - 下载按钮改为带下拉箭头的形式
   - 点击后弹出格式选择对话框

### 2. 增强型SQL执行器组件

在`/src/components/EnhancedSQLExecutor.jsx`中：

1. **异步查询提交增强**：
   - `handleRunAsyncQuery`函数现在支持传递格式参数
   - 默认使用Parquet格式

### 3. API客户端增强

在`/src/services/apiClient.js`中：

1. **增强submitAsyncQuery函数**：
   - 支持传递format参数
   - 默认为"parquet"格式

## 用户体验设计

### 1. 明确的格式指示

用户可以直观地看到每个任务使用什么格式生成结果：
- 任务列表中显示格式标签
- 格式选择对话框中显示当前格式

### 2. 格式特点说明

在格式选择对话框中，每种格式都有简要说明：
- Parquet格式：高效、压缩比高、适合大数据分析
- CSV格式：通用、兼容性好、易打开

### 3. 防止误操作

通过清晰的提示告知用户：
- 任务完成后格式已锁定
- 如需不同格式需重新提交任务

## 测试验证

### 1. 功能测试

1. **任务格式解析**：
   - CSV格式任务正确显示为"CSV格式"
   - Parquet格式任务正确显示为"PARQUET格式"

2. **UI交互**：
   - 下载按钮正确显示格式信息
   - 点击按钮弹出格式选择对话框
   - 对话框中显示正确的格式信息

3. **API调用**：
   - 提交任务时正确传递格式参数
   - 下载时正确处理不同格式的文件

### 2. 兼容性测试

1. **向后兼容**：
   - 不指定格式的任务默认使用Parquet格式
   - 旧版本的任务信息也能正确解析

2. **错误处理**：
   - 无效格式信息时正确回退到默认格式
   - 网络错误时正确显示错误信息

## 使用说明

### 1. 提交任务时指定格式

在使用增强型SQL执行器时，可以通过修改`handleRunAsyncQuery`函数来指定格式：

```javascript
// 设置默认格式为csv
const format = 'csv';
const response = await submitAsyncQuery(sqlQuery, format);
```

### 2. 查看任务格式

在异步任务列表页面，每个任务都会显示其使用的格式：
- CSV格式任务显示"CSV 格式"标签
- Parquet格式任务显示"PARQUET 格式"标签

### 3. 下载任务结果

点击下载按钮会弹出对话框显示：
- 当前任务的格式信息
- 不同格式的特点说明
- 确认下载按钮

## 性能考量

### 1. 响应速度

- 格式解析使用简单的正则表达式，性能影响微乎其微
- 不会增加页面加载时间或影响用户体验

### 2. 内存使用

- 格式信息存储在任务对象中，内存开销极小
- 不会影响应用的整体性能

## 安全考虑

### 1. 输入验证

- 格式解析采用安全的正则表达式
- 对无效输入有适当的错误处理和回退机制

### 2. XSS防护

- 格式信息在UI中以安全方式显示
- 不会执行任何用户输入的脚本

## 可维护性

### 1. 代码结构

- 格式解析功能封装在独立函数中
- 易于测试和维护
- 符合单一职责原则

### 2. 扩展性

- 未来可以轻松添加更多格式支持
- 只需修改解析函数和UI部分即可

## 用户教育

### 1. 内联提示

- 在格式选择对话框中提供格式特点说明
- 帮助用户理解不同格式的优缺点

### 2. 状态反馈

- 清晰显示任务使用的格式
- 防止用户困惑

## 总结

前端已完全实现对异步任务结果下载格式的支持：
1. 正确解析和显示任务格式
2. 提供友好的格式选择界面
3. 增强API调用以支持格式参数
4. 保证良好的用户体验

用户现在可以在前端清晰地看到任务使用什么格式，并在下载时获得相关的格式信息提示。