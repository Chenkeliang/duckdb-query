# useDuckQuery æ¸…ç†ä¸çŠ¶æ€ç®¡ç†é‡æ„ - éœ€æ±‚æ–‡æ¡£

> **ç‰ˆæœ¬**: 1.0  
> **åˆ›å»ºæ—¶é—´**: 2024-12-24  
> **çŠ¶æ€**: ğŸ“‹ å¾…è¯„å®¡

---

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

æ¸…ç† `frontend/src/hooks/useDuckQuery.js` ä¸­çš„æ—§ UI æ®‹ç•™ä»£ç ï¼Œå°†ä»éœ€ä¿ç•™çš„åŠŸèƒ½æ‹†åˆ†ä¸ºç‹¬ç«‹çš„ Hooksï¼Œå¹¶è®©ä¸»åº”ç”¨ `DuckQueryApp.jsx` å®Œå…¨ä¾èµ– TanStack Query ä½“ç³»è¿›è¡Œæ•°æ®ç®¡ç†å’Œç¼“å­˜å¤±æ•ˆã€‚

**æ ¸å¿ƒç›®æ ‡**ï¼š
1. ç§»é™¤ä¸å†ä½¿ç”¨çš„æ—§ç­›é€‰ã€æ•°æ®è½¬æ¢é€»è¾‘ï¼ˆçº¦ 550 è¡Œï¼‰
2. å°†ä»éœ€ä¿ç•™çš„çŠ¶æ€ç®¡ç†ï¼ˆä¸»é¢˜ã€æ¬¢è¿é¡µã€å…¨å±€åˆ·æ–°ï¼‰æ‹†åˆ†ä¸ºç‹¬ç«‹ Hooks
3. ç»Ÿä¸€ä½¿ç”¨ TanStack Query çš„ç¼“å­˜å¤±æ•ˆå·¥å…·æ›¿ä»£ `requestManager`
4. ç¡®ä¿é‡æ„è¿‡ç¨‹ä¸­ä¸å½±å“ç°æœ‰åŠŸèƒ½

---

## ğŸ¯ ç”¨æˆ·æ•…äº‹

### æ•…äº‹ 1: ä¸»é¢˜åˆ‡æ¢
> ä½œä¸ºç”¨æˆ·ï¼Œæˆ‘å¸Œæœ›åœ¨æ·±è‰²/æµ…è‰²ä¸»é¢˜ä¹‹é—´åˆ‡æ¢ï¼Œå¹¶ä¸”åˆ·æ–°é¡µé¢åä¿æŒæˆ‘çš„é€‰æ‹©ã€‚

**éªŒæ”¶æ ‡å‡†**:
- [ ] ç‚¹å‡»ä¸»é¢˜åˆ‡æ¢æŒ‰é’®ï¼Œé¡µé¢ä¸»é¢˜ç«‹å³åˆ‡æ¢
- [ ] åˆ·æ–°æµè§ˆå™¨åï¼Œä¸»é¢˜ä¿æŒä¸Šæ¬¡é€‰æ‹©
- [ ] ç³»ç»Ÿåå¥½è®¾ç½®å˜åŒ–æ—¶ï¼ˆå¦‚æœç”¨æˆ·æœªæ‰‹åŠ¨è®¾ç½®ï¼‰ï¼Œä¸»é¢˜è·Ÿéšç³»ç»Ÿ

### æ•…äº‹ 2: æ¬¢è¿é¡µæ˜¾ç¤º
> ä½œä¸ºæ–°ç”¨æˆ·ï¼Œæˆ‘å¸Œæœ›é¦–æ¬¡è®¿é—®æ—¶çœ‹åˆ°æ¬¢è¿é¡µï¼Œä½†ä¹‹åä¸å†æ˜¾ç¤ºï¼ˆ7å¤©å†…ï¼‰ã€‚

**éªŒæ”¶æ ‡å‡†**:
- [ ] é¦–æ¬¡è®¿é—®æ˜¾ç¤ºæ¬¢è¿é¡µ
- [ ] ç‚¹å‡»"å¼€å§‹ä½¿ç”¨"åä¸å†æ˜¾ç¤º
- [ ] è¶…è¿‡ 7 å¤©åå†æ¬¡æ˜¾ç¤ºæ¬¢è¿é¡µ
- [ ] æ¬¢è¿é¡µå…³é—­çŠ¶æ€æŒä¹…åŒ–åˆ° localStorage

### æ•…äº‹ 3: æ•°æ®æºåˆ·æ–°
> ä½œä¸ºç”¨æˆ·ï¼Œæ‰§è¡Œæ•°æ®å˜æ›´æ“ä½œï¼ˆä¸Šä¼ æ–‡ä»¶ã€ä¿å­˜è¿æ¥ï¼‰åï¼Œæ•°æ®æºåˆ—è¡¨è‡ªåŠ¨æ›´æ–°ã€‚

**éªŒæ”¶æ ‡å‡†**:
- [ ] ä¸Šä¼ æ–‡ä»¶æˆåŠŸåï¼Œæ•°æ®æºåˆ—è¡¨è‡ªåŠ¨åˆ·æ–°
- [ ] ä¿å­˜æ•°æ®åº“è¿æ¥åï¼Œè¿æ¥åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°
- [ ] åˆ é™¤è¡¨åï¼Œè¡¨åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°
- [ ] å…¨å±€åˆ·æ–°å¿«æ·é”®å¯ç”¨

### æ•…äº‹ 4: æ•°æ®åº“è¿æ¥æ“ä½œ
> ä½œä¸ºç”¨æˆ·ï¼Œæˆ‘å¸Œæœ›æµ‹è¯•ã€ä¿å­˜æ•°æ®åº“è¿æ¥åè·å¾—æ˜ç¡®åé¦ˆã€‚

**éªŒæ”¶æ ‡å‡†**:
- [ ] æµ‹è¯•è¿æ¥æˆåŠŸ/å¤±è´¥æœ‰ Toast æç¤º
- [ ] ä¿å­˜è¿æ¥æˆåŠŸåï¼Œåˆ—è¡¨è‡ªåŠ¨æ›´æ–°
- [ ] è¿æ¥æ“ä½œæœŸé—´æ˜¾ç¤ºåŠ è½½çŠ¶æ€

### æ•…äº‹ 5: å¼‚æ­¥ä»»åŠ¡é¢„è§ˆ
> ä½œä¸ºç”¨æˆ·ï¼Œæˆ‘å¸Œæœ›åœ¨å¼‚æ­¥ä»»åŠ¡é¢æ¿ç‚¹å‡»é¢„è§ˆæ—¶ï¼Œèƒ½åœ¨ SQL ç¼–è¾‘å™¨çœ‹åˆ°ç»“æœã€‚

**éªŒæ”¶æ ‡å‡†**:
- [ ] ç‚¹å‡»å¼‚æ­¥ä»»åŠ¡çš„é¢„è§ˆæŒ‰é’®
- [ ] è‡ªåŠ¨åˆ‡æ¢åˆ°æŸ¥è¯¢å·¥ä½œå°
- [ ] SQL ç¼–è¾‘å™¨æ˜¾ç¤ºé¢„è§ˆ SQL

---

## ğŸ”’ è¾¹ç•Œæ¡ä»¶ä¸çº¦æŸ

### åŠŸèƒ½è¾¹ç•Œ

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|----------|
| localStorage ä¸å¯ç”¨ | ä½¿ç”¨é»˜è®¤å€¼ï¼Œä¸æŠ¥é”™ |
| ä¸»é¢˜å€¼æŸå | å›é€€åˆ°ç³»ç»Ÿåå¥½æˆ– light |
| æ¬¢è¿é¡µæ—¥æœŸè§£æå¤±è´¥ | æ˜¾ç¤ºæ¬¢è¿é¡µ |
| API åˆ·æ–°å¤±è´¥ | Toast æç¤ºé”™è¯¯ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½ |
| å¹¶å‘åˆ·æ–°è¯·æ±‚ | ç”± TanStack Query è‡ªåŠ¨å»é‡ |

### æŠ€æœ¯çº¦æŸ

| çº¦æŸé¡¹ | è¦æ±‚ |
|--------|------|
| æŠ€æœ¯æ ˆ | React, TypeScript, TanStack Query |
| çŠ¶æ€å­˜å‚¨ | localStorageï¼ˆä¸»é¢˜ã€æ¬¢è¿é¡µï¼‰ |
| ç¼“å­˜å¤±æ•ˆ | å¿…é¡»ä½¿ç”¨ `cacheInvalidation.ts` å·¥å…· |
| API è°ƒç”¨ | å¿…é¡»ä½¿ç”¨ `@/services/apiClient` |
| ç¦æ­¢äº‹é¡¹ | âŒ ç›´æ¥è°ƒç”¨ `requestManager`ï¼ˆæ–°ä»£ç ï¼‰ |

### å…¼å®¹æ€§çº¦æŸ

| çº¦æŸé¡¹ | è¦æ±‚ |
|--------|------|
| æ—§å…¥å£å…¼å®¹ | ä¸ä¿®æ”¹æ—§å…¥å£ `ShadcnApp.jsx`ï¼ˆå¦‚å­˜åœ¨ï¼‰ |
| API å…¼å®¹ | ä¸ä¿®æ”¹åç«¯ API |
| ç»„ä»¶æ¥å£ | å°½é‡ä¿æŒç°æœ‰ props æ¥å£ä¸å˜ |
| æ¸è¿›å¼è¿ç§» | æ”¯æŒè¿‡æ¸¡æœŸæ–°æ—§ä»£ç å…±å­˜ |

---

## ğŸ“Š å½“å‰çŠ¶æ€åˆ†æ

### useDuckQuery.js åŠŸèƒ½æ¸…å•

| åŠŸèƒ½ | è¡Œæ•° | çŠ¶æ€ | å¤„ç†æ–¹å¼ |
|------|------|------|----------|
| `getInitialTheme()` | 18-36 | âœ… ä½¿ç”¨ä¸­ | â†’ `useThemePreference` |
| `shouldShowWelcome()` | 38-55 | âœ… ä½¿ç”¨ä¸­ | â†’ `useWelcomeState` |
| `isDarkMode` çŠ¶æ€ | 521,550-593 | âœ… ä½¿ç”¨ä¸­ | â†’ `useThemePreference` |
| `showWelcome` çŠ¶æ€ | 520 | âœ… ä½¿ç”¨ä¸­ | â†’ `useWelcomeState` |
| `previewQuery` çŠ¶æ€ | 540 | âœ… ä½¿ç”¨ä¸­ | â†’ `usePreviewState` |
| `handleCloseWelcome()` | 967-973 | âœ… ä½¿ç”¨ä¸­ | â†’ `useWelcomeState` |
| `triggerRefresh()` | 748-752 | âœ… ä½¿ç”¨ä¸­ | â†’ TanStack Query `invalidateAllDataCaches` |
| `handleDatabaseConnect()` | 884-965 | âœ… ä½¿ç”¨ä¸­ | â†’ `useAppActions` |
| `handleDatabaseSaveConfig()` | 975-1000 | âœ… ä½¿ç”¨ä¸­ | â†’ `useAppActions` |
| `executeLoadInitialData()` | 595-704 | âš ï¸ éƒ¨åˆ†ä½¿ç”¨ | ç§»é™¤ï¼Œæ”¹ç”¨ `useDuckDBTables` / `useDatabaseConnections` |
| `normalizeColumnType()` | 72-124 | âŒ æœªä½¿ç”¨ | åˆ é™¤ |
| `transformMetadataColumns()` | 126-152 | âŒ æœªä½¿ç”¨ | åˆ é™¤ |
| `buildColumnTypeMap()` | 154-236 | âŒ æœªä½¿ç”¨ | åˆ é™¤ |
| `quoteIdentifier()` | 238-249 | âŒ æœªä½¿ç”¨ | åˆ é™¤ï¼ˆæ–° UI ç”¨ `sqlUtils.ts`ï¼‰|
| `escapeLikeValue()` | 251-255 | âŒ æœªä½¿ç”¨ | åˆ é™¤ |
| `escapeLiteralValue()` | 257-261 | âŒ æœªä½¿ç”¨ | åˆ é™¤ |
| `buildFilterConditions()` | 272-486 | âŒ æœªä½¿ç”¨ | åˆ é™¤ |
| `buildFilteredSql()` | 488-498 | âŒ æœªä½¿ç”¨ | åˆ é™¤ |
| `handleApplyResultFilters()` | 792-860 | âŒ æœªä½¿ç”¨ | åˆ é™¤ |
| `queryResults` çŠ¶æ€ | 527 | âŒ æœªä½¿ç”¨ | åˆ é™¤ |
| `activeFilters` çŠ¶æ€ | 528 | âŒ æœªä½¿ç”¨ | åˆ é™¤ |
| `queryContext` çŠ¶æ€ | 530-536 | âŒ æœªä½¿ç”¨ | åˆ é™¤ |
| `dataSources` çŠ¶æ€ | 524 | âŒ æœªä½¿ç”¨ | åˆ é™¤ï¼ˆæ”¹ç”¨ `useDuckDBTables`ï¼‰ |
| `databaseConnections` çŠ¶æ€ | 525 | âŒ æœªä½¿ç”¨ | åˆ é™¤ï¼ˆæ”¹ç”¨ `useDatabaseConnections`ï¼‰ |

### å¤–éƒ¨ä¾èµ–åˆ†æ

| ä¾èµ–é¡¹ | å½“å‰ä½¿ç”¨ä½ç½® | ç›®æ ‡çŠ¶æ€ |
|--------|-------------|----------|
| `requestManager.clearAllCache()` | `useDuckQuery.js:749` | æ›¿æ¢ä¸º `invalidateAllDataCaches()` |
| `requestManager.clearCache('/api/datasources')` | `apiClient.js` å¤šå¤„ | ä¿ç•™ï¼ˆæ—§ API å±‚ï¼‰æˆ–æ›¿æ¢ |
| `requestManager.getDatabaseConnections()` | `apiClient.js:442` | ä¿ç•™ï¼ˆæ—§ API å±‚ï¼‰ |

---

## âœ… éªŒæ”¶æ£€æŸ¥æ¸…å•

### åŠŸèƒ½éªŒæ”¶
- [ ] ä¸»é¢˜åˆ‡æ¢æ­£å¸¸å·¥ä½œï¼Œåˆ·æ–°åä¿æŒ
- [ ] æ¬¢è¿é¡µé¦–æ¬¡æ˜¾ç¤ºï¼Œ7å¤©åå†æ¬¡æ˜¾ç¤º
- [ ] ä¸Šä¼ æ–‡ä»¶åæ•°æ®æºåˆ—è¡¨è‡ªåŠ¨æ›´æ–°
- [ ] ä¿å­˜æ•°æ®åº“è¿æ¥ååˆ—è¡¨è‡ªåŠ¨æ›´æ–°
- [ ] åˆ é™¤è¡¨ååˆ—è¡¨è‡ªåŠ¨æ›´æ–°
- [ ] å…¨å±€åˆ·æ–°å¿«æ·é”®å¯ç”¨ï¼ˆCtrl+R / Cmd+Rï¼‰
- [ ] å¼‚æ­¥ä»»åŠ¡é¢„è§ˆ SQL ä¼ é€’æ­£å¸¸
- [ ] æ•°æ®åº“è¿æ¥æµ‹è¯•/ä¿å­˜æ“ä½œæ­£å¸¸

### å…¼å®¹æ€§éªŒæ”¶
- [ ] `DuckQueryApp.jsx` æ­£å¸¸è¿è¡Œ
- [ ] æ‰€æœ‰å­ç»„ä»¶ï¼ˆUploadPanel, DatabaseForm ç­‰ï¼‰æ­£å¸¸å·¥ä½œ
- [ ] å‘½ä»¤é¢æ¿æ­£å¸¸å·¥ä½œ
- [ ] é”®ç›˜å¿«æ·é”®æ­£å¸¸å·¥ä½œ
- [ ] æš—è‰²/äº®è‰²æ¨¡å¼æ­£å¸¸åˆ‡æ¢

### ä»£ç è´¨é‡éªŒæ”¶
- [ ] æ–° Hooks ä½¿ç”¨ TypeScript
- [ ] æ—  ESLint é”™è¯¯
- [ ] æ—  TypeScript ç±»å‹é”™è¯¯
- [ ] æ„å»ºæˆåŠŸï¼ˆ`npm run build`ï¼‰
- [ ] æ— ç¡¬ç¼–ç å€¼ï¼ˆé¢œè‰²ã€LIMIT ç­‰ï¼‰
- [ ] æ— æœªä½¿ç”¨çš„å¯¼å…¥

### æ¸…ç†éªŒæ”¶
- [ ] `useDuckQuery.js` å·²åˆ é™¤æˆ–ä»…ä¿ç•™å£³å­
- [ ] `requestManager` åœ¨æ–°ä»£ç ä¸­æ— è°ƒç”¨
- [ ] æ—§ç­›é€‰é€»è¾‘å®Œå…¨ç§»é™¤
- [ ] æ—§æ•°æ®è½¬æ¢é€»è¾‘å®Œå…¨ç§»é™¤

---

## ğŸš¨ é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| æ–°æ—§ Hook çŠ¶æ€ä¸åŒæ­¥ | æ•°æ®ä¸ä¸€è‡´ | åˆ›å»º `useDuckQueryShell` è¿‡æ¸¡å£³ |
| ç¼“å­˜å¤±æ•ˆé—æ¼ | æ•°æ®ä¸æ›´æ–° | å•å…ƒæµ‹è¯•è¦†ç›–æ‰€æœ‰åˆ·æ–°åœºæ™¯ |
| å¤–éƒ¨æ¨¡å—å¼•ç”¨ `triggerRefresh` | è¿è¡Œæ—¶é”™è¯¯ | å…¨å±€æœç´¢æ›¿æ¢ |
| localStorage æ ¼å¼å˜åŒ– | ç”¨æˆ·è®¾ç½®ä¸¢å¤± | ä¿æŒé”®åä¸å˜ |
| `apiClient.js` ä¸­çš„ `requestManager` | æ—§ä»£ç ä¾èµ– | åˆ†é˜¶æ®µæ¸…ç†ï¼Œå…ˆæ–°åæ—§ |

---

## ğŸŒ å›½é™…åŒ– Key åˆ—è¡¨

æ— æ–°å¢ i18n Keyï¼ˆå¤ç”¨ç°æœ‰ Keyï¼‰ã€‚
