# 数据源元数据迁移到 DuckDB - 需求文档

## 概述

将数据库连接配置和文件数据源元数据从 JSON 文件迁移到 DuckDB 元数据表中，实现统一的元数据管理。

## 术语表

- **数据源 (DataSource)**: 系统中可查询的数据来源，包括数据库连接和文件
- **元数据 (Metadata)**: 描述数据源的配置信息和统计信息
- **DuckDB**: 系统使用的嵌入式分析数据库
- **迁移 (Migration)**: 将数据从一种存储方式转换到另一种存储方式的过程

## 需求

### 需求 1: 数据库连接元数据迁移

**用户故事**: 作为系统管理员，我希望数据库连接配置存储在 DuckDB 中，以便统一管理所有元数据。

#### 验收标准

1. WHEN 系统启动时 THEN 系统应创建 `system_database_connections` 元数据表（如果不存在）
2. WHEN 添加新的数据库连接时 THEN 系统应将连接信息存储到 DuckDB 元数据表中
3. WHEN 查询数据库连接列表时 THEN 系统应从 DuckDB 元数据表中读取
4. WHEN 更新数据库连接时 THEN 系统应更新 DuckDB 元数据表中的记录
5. WHEN 删除数据库连接时 THEN 系统应从 DuckDB 元数据表中删除记录

### 需求 2: 文件数据源元数据迁移

**用户故事**: 作为系统管理员，我希望文件数据源元数据存储在 DuckDB 中，以便与实际数据存储在同一位置。

#### 验收标准

1. WHEN 系统启动时 THEN 系统应创建 `system_file_datasources` 元数据表（如果不存在）
2. WHEN 上传文件时 THEN 系统应将文件元数据存储到 DuckDB 元数据表中
3. WHEN 查询文件数据源列表时 THEN 系统应从 DuckDB 元数据表中读取
4. WHEN 删除文件数据源时 THEN 系统应从 DuckDB 元数据表中删除记录
5. WHEN 文件数据源统计信息更新时 THEN 系统应更新 DuckDB 元数据表中的记录

### 需求 3: 数据迁移

**用户故事**: 作为系统管理员，我希望现有的 JSON 文件数据能够自动迁移到 DuckDB，以便无缝升级。

#### 验收标准

1. WHEN 系统首次启动新版本时 THEN 系统应检测到 JSON 文件的存在
2. WHEN 检测到 JSON 文件时 THEN 系统应自动将数据迁移到 DuckDB 元数据表
3. WHEN 迁移成功后 THEN 系统应删除原 JSON 文件
4. WHEN 迁移失败时 THEN 系统应抛出错误并停止启动
5. WHEN 迁移完成后 THEN 系统应验证迁移数据的完整性

### 需求 4: 向后兼容

**用户故事**: 作为开发者，我希望迁移过程不影响现有 API 接口，以便前端无需修改。

#### 验收标准

1. WHEN 前端调用数据源 API 时 THEN 系统应返回与之前相同的数据格式
2. WHEN 系统从 DuckDB 读取元数据时 THEN 系统应转换为与 JSON 文件相同的数据结构
3. WHEN API 接口调用时 THEN 系统应透明地使用 DuckDB 存储而非 JSON 文件
4. WHEN 迁移完成后 THEN 所有现有功能应正常工作

### 需求 5: 数据安全

**用户故事**: 作为系统管理员，我希望敏感信息（如数据库密码）在 DuckDB 中也能得到保护。

#### 验收标准

1. WHEN 存储数据库密码时 THEN 系统应使用加密存储
2. WHEN 读取数据库密码时 THEN 系统应解密后返回
3. WHEN 备份 DuckDB 文件时 THEN 敏感信息应保持加密状态
4. WHEN 迁移数据时 THEN 系统应保持原有的加密方式

### 需求 6: 性能优化

**用户故事**: 作为用户，我希望元数据查询速度快，以便快速加载数据源列表。

#### 验收标准

1. WHEN 查询数据源列表时 THEN 响应时间应小于 100ms
2. WHEN 频繁查询元数据时 THEN 系统应使用内存缓存
3. WHEN 元数据更新时 THEN 系统应自动刷新缓存
4. WHEN 系统启动时 THEN 元数据表应创建必要的索引

### 需求 7: 错误处理

**用户故事**: 作为系统管理员，我希望迁移过程中的错误能够被妥善处理，以便系统稳定运行。

#### 验收标准

1. WHEN 迁移过程中发生错误时 THEN 系统应回滚到迁移前状态
2. WHEN 迁移失败时 THEN 系统应停止启动并显示错误信息
3. WHEN 元数据读取失败时 THEN 系统应返回友好的错误信息
4. WHEN 发生错误时 THEN 系统应记录详细的错误日志
5. WHEN DuckDB 文件损坏时 THEN 系统应提示用户从备份恢复

## 非功能需求

### 性能要求
- 元数据查询响应时间 < 100ms
- 迁移过程应在 5 秒内完成（对于 < 1000 条记录）
- 支持至少 10000 个数据源的元数据存储

### 可靠性要求
- 迁移成功率 > 99.9%
- 数据完整性验证通过率 100%
- 支持迁移失败后的自动回滚

### 可维护性要求
- 元数据表结构应易于扩展
- 迁移代码应有完整的单元测试
- 提供元数据表的备份和恢复工具

## 约束条件

1. 必须保持与现有 API 接口的兼容性
2. 必须支持从 JSON 文件到 DuckDB 的平滑迁移
3. 必须保持敏感信息的加密存储
4. 迁移过程不应影响系统的正常运行
5. 必须提供迁移失败的回滚机制

## 依赖关系

- DuckDB 数据库已正确配置
- 加密/解密工具已实现
- 现有的数据源管理 API 已实现
- 文件上传和管理功能已实现

## 验收测试

### 测试场景 1: 全新安装
1. 在没有 JSON 文件的环境中启动系统
2. 验证元数据表自动创建
3. 添加数据库连接和文件数据源
4. 验证数据正确存储在 DuckDB 中

### 测试场景 2: 从 JSON 迁移
1. 准备包含数据的 JSON 文件
2. 启动新版本系统
3. 验证自动迁移执行
4. 验证数据完整性
5. 验证 JSON 文件已备份

### 测试场景 3: 迁移失败回滚
1. 模拟迁移过程中的错误
2. 验证系统回滚到迁移前状态
3. 验证 JSON 文件未被修改
4. 验证错误日志已记录

### 测试场景 4: API 兼容性
1. 使用现有前端代码调用 API
2. 验证返回数据格式正确
3. 验证所有功能正常工作
4. 验证性能未降低

## 风险评估

### 高风险
- **数据丢失**: 迁移过程中可能导致数据丢失
  - 缓解措施: 迁移前自动备份，支持回滚
  
- **密码泄露**: 迁移过程中敏感信息可能暴露
  - 缓解措施: 保持加密存储，使用安全的迁移流程

### 中风险
- **性能下降**: DuckDB 查询可能比 JSON 文件慢
  - 缓解措施: 使用索引和缓存优化性能
  
- **兼容性问题**: 可能影响现有功能
  - 缓解措施: 充分测试，保持 API 兼容性

### 低风险
- **迁移时间过长**: 大量数据迁移可能耗时
  - 缓解措施: 批量处理，显示进度

## 成功标准

1. ✅ 所有验收标准通过
2. ✅ 迁移成功率 > 99.9%
3. ✅ 性能测试通过（查询 < 100ms）
4. ✅ 所有单元测试和集成测试通过
5. ✅ 代码审查通过
6. ✅ 文档更新完成
