# 数据源元数据迁移到 DuckDB - 任务列表

## 1. 创建元数据管理基础设施

- [ ] 1.1 创建元数据管理器模块
  - 创建 `api/core/metadata_manager.py`
  - 实现 `MetadataManager` 类
  - 实现元数据表初始化方法
  - _需求: 1.1, 2.1_

- [ ] 1.2 定义元数据表结构
  - 创建 `system_database_connections` 表的 SQL
  - 创建 `system_file_datasources` 表的 SQL
  - 创建 `system_migration_status` 表的 SQL
  - 添加必要的索引
  - _需求: 1.1, 2.1_

- [ ] 1.3 实现加密工具
  - 创建 `api/utils/encryption_utils.py`
  - 实现密码加密/解密方法
  - 实现 JSON 数据加密/解密方法
  - 确保与现有加密方式兼容
  - _需求: 5.1, 5.2, 5.3_

## 2. 实现数据库连接元数据管理

- [ ] 2.1 实现数据库连接 CRUD 操作
  - 实现 `save_database_connection()` 方法
  - 实现 `get_database_connection()` 方法
  - 实现 `list_database_connections()` 方法
  - 实现 `update_database_connection()` 方法
  - 实现 `delete_database_connection()` 方法
  - _需求: 1.2, 1.3, 1.4, 1.5_

- [ ] 2.2 实现数据库连接缓存
  - 添加内存缓存机制
  - 实现缓存失效策略
  - 实现缓存刷新方法
  - _需求: 6.2, 6.3_

- [ ] 2.3 适配现有数据库管理器
  - 修改 `api/core/database_manager.py`
  - 将 JSON 文件读取改为 DuckDB 读取
  - 将 JSON 文件写入改为 DuckDB 写入
  - 保持 API 接口不变
  - _需求: 4.1, 4.2, 4.3_

## 3. 实现文件数据源元数据管理

- [ ] 3.1 实现文件数据源 CRUD 操作
  - 实现 `save_file_datasource()` 方法
  - 实现 `get_file_datasource()` 方法
  - 实现 `list_file_datasources()` 方法
  - 实现 `update_file_datasource()` 方法
  - 实现 `delete_file_datasource()` 方法
  - _需求: 2.2, 2.3, 2.4, 2.5_

- [ ] 3.2 适配现有文件数据源管理器
  - 修改 `api/core/file_datasource_manager.py`
  - 将 JSON 文件读取改为 DuckDB 读取
  - 将 JSON 文件写入改为 DuckDB 写入
  - 保持 API 接口不变
  - _需求: 4.1, 4.2, 4.3_

- [ ] 3.3 实现批量操作优化
  - 实现批量保存文件数据源方法
  - 实现批量更新方法
  - 优化大量数据的插入性能
  - _需求: 6.1_

## 4. 实现数据迁移功能

- [ ] 4.1 创建迁移管理器
  - 创建 `api/core/migration_manager.py`
  - 实现 `MigrationManager` 类
  - 实现迁移状态检查方法
  - _需求: 3.1_

- [ ] 4.2 实现数据库连接迁移
  - 实现从 `config/datasources.json` 读取数据
  - 实现数据格式转换
  - 实现批量插入到 DuckDB
  - 实现迁移验证
  - _需求: 3.2, 3.5_

- [ ] 4.3 实现文件数据源迁移
  - 实现从 `api/data/file_datasources.json` 读取数据
  - 实现数据格式转换
  - 实现批量插入到 DuckDB
  - 实现迁移验证
  - _需求: 3.2, 3.5_

- [ ] 4.4 实现迁移事务和回滚
  - 使用事务包装迁移过程
  - 实现迁移失败回滚机制
  - 实现错误日志记录
  - _需求: 3.4, 7.1_

- [ ] 4.5 实现 JSON 文件清理
  - 实现迁移成功后删除 JSON 文件
  - 删除 `config/datasources.json`
  - 删除 `api/data/file_datasources.json`
  - 记录清理日志
  - _需求: 3.3_

## 5. 集成到应用启动流程

- [ ] 5.1 添加启动时迁移检查
  - 修改 `api/main.py` 的 startup 事件
  - 检测 JSON 文件是否存在
  - 检查迁移状态表
  - _需求: 3.1_

- [ ] 5.2 实现自动迁移流程
  - 在启动时自动执行迁移
  - 显示迁移进度日志
  - 处理迁移错误
  - _需求: 3.2, 3.4_



## 6. 更新 API 路由

- [ ] 6.1 更新数据源 API
  - 修改 `api/routers/datasources.py`
  - 确保所有端点使用 MetadataManager
  - 保持响应格式不变
  - _需求: 4.1, 4.3_

- [ ] 6.2 更新数据库连接 API
  - 修改 `api/routers/data_sources.py`
  - 确保所有端点使用 MetadataManager
  - 保持响应格式不变
  - _需求: 4.1, 4.3_

- [ ] 6.3 更新文件上传 API
  - 修改文件上传相关路由
  - 确保元数据保存到 DuckDB
  - 保持响应格式不变
  - _需求: 4.1, 4.3_

## 7. 性能优化

- [ ] 7.1 实现查询优化
  - 添加常用查询的索引
  - 优化 SQL 查询语句
  - 测试查询性能
  - _需求: 6.1, 6.4_

- [ ] 7.2 实现缓存机制
  - 添加内存缓存
  - 实现缓存失效策略
  - 测试缓存命中率
  - _需求: 6.2, 6.3_

- [ ] 7.3 实现批量操作
  - 优化批量插入
  - 优化批量更新
  - 测试批量操作性能
  - _需求: 6.1_

## 8. 错误处理和日志

- [ ] 8.1 实现错误处理
  - 添加详细的错误日志
  - 实现友好的错误消息
  - 实现错误恢复机制
  - _需求: 7.1, 7.2, 7.3, 7.4_

- [ ] 8.2 实现监控指标
  - 记录迁移成功率
  - 记录查询响应时间
  - 记录缓存命中率
  - _需求: 6.1_

- [ ] 8.3 实现日志记录
  - 记录所有元数据操作
  - 记录迁移过程
  - 记录性能指标
  - _需求: 7.4_

## 9. 测试

- [ ] 9.1 编写单元测试
  - 测试 MetadataManager 所有方法
  - 测试 MigrationManager 所有方法
  - 测试加密/解密工具
  - 测试覆盖率 > 80%
  - _需求: 所有_

- [ ] 9.2 编写集成测试
  - 测试完整迁移流程
  - 测试 API 兼容性
  - 测试错误处理
  - 测试回滚机制
  - _需求: 所有_

- [ ] 9.3 编写性能测试
  - 测试查询响应时间
  - 测试批量操作性能
  - 测试缓存性能
  - 测试大数据量场景
  - _需求: 6.1_

- [ ] 9.4 编写端到端测试
  - 测试全新安装场景
  - 测试从 JSON 迁移场景
  - 测试迁移失败回滚场景
  - 测试 API 兼容性场景
  - _需求: 所有_

## 10. 文档更新

- [ ] 10.1 更新 README
  - 更新数据存储说明
  - 添加迁移说明
  - 更新架构图
  - _需求: 所有_

- [ ] 10.2 更新 API 文档
  - 更新数据源管理 API 文档
  - 添加元数据管理说明
  - 更新示例代码
  - _需求: 4.1_

- [ ] 10.3 创建迁移指南
  - 编写迁移步骤文档
  - 编写回滚步骤文档
  - 编写故障排查文档
  - _需求: 3.1, 3.2, 3.3, 3.4_

- [ ] 10.4 更新开发文档
  - 更新元数据管理说明
  - 更新数据模型文档
  - 更新最佳实践
  - _需求: 所有_

## 11. 部署准备

- [ ] 11.1 准备部署脚本
  - 创建 DuckDB 备份脚本
  - 创建迁移验证脚本
  - 创建回滚脚本
  - _需求: 3.3, 3.4_

- [ ] 11.2 准备监控告警
  - 配置迁移成功率监控
  - 配置性能指标监控
  - 配置错误告警
  - _需求: 6.1_

- [ ] 11.3 准备发布说明
  - 编写版本更新说明
  - 编写迁移注意事项
  - 编写已知问题列表
  - _需求: 所有_

## 12. 验收测试

- [ ] 12.1 执行验收测试
  - 在测试环境执行完整迁移
  - 验证所有功能正常
  - 验证性能指标达标
  - 验证文档完整
  - _需求: 所有_

- [ ] 12.2 用户验收测试
  - 邀请用户测试
  - 收集用户反馈
  - 修复发现的问题
  - _需求: 所有_

## 13. 清理工作

- [ ] 13.1 清理临时代码
  - 删除调试代码
  - 删除临时文件
  - 清理注释
  - _需求: 所有_

- [ ] 13.2 代码审查
  - 提交代码审查
  - 修复审查意见
  - 确保代码质量
  - _需求: 所有_

- [ ] 13.3 最终验证
  - 运行所有测试
  - 验证文档完整
  - 验证部署脚本
  - _需求: 所有_

## 检查点

- [ ] Checkpoint 1: 基础设施完成
  - 任务 1.1 - 1.3 完成
  - 元数据表创建成功
  - 加密工具测试通过

- [ ] Checkpoint 2: 元数据管理完成
  - 任务 2.1 - 3.3 完成
  - 所有 CRUD 操作测试通过
  - API 适配完成

- [ ] Checkpoint 3: 迁移功能完成
  - 任务 4.1 - 4.5 完成
  - 迁移测试通过
  - 回滚测试通过

- [ ] Checkpoint 4: 集成完成
  - 任务 5.1 - 6.3 完成
  - 启动流程测试通过
  - API 兼容性测试通过

- [ ] Checkpoint 5: 优化和测试完成
  - 任务 7.1 - 9.4 完成
  - 性能测试通过
  - 所有测试通过

- [ ] Checkpoint 6: 文档和部署准备完成
  - 任务 10.1 - 11.3 完成
  - 文档审查通过
  - 部署脚本测试通过

- [ ] Final Checkpoint: 验收完成
  - 任务 12.1 - 13.3 完成
  - 用户验收通过
  - 准备发布
