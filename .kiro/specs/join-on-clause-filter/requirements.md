# JOIN ON å­å¥ç­›é€‰å™¨å¢å¼ºéœ€æ±‚æ–‡æ¡£

> **ç‰ˆæœ¬**: 1.1  
> **åˆ›å»ºæ—¶é—´**: 2024-12-25  
> **æ›´æ–°æ—¶é—´**: 2024-12-25  
> **çŠ¶æ€**: ğŸŸ¢ éœ€æ±‚ç¡®è®¤  
> **å…³è”åŠŸèƒ½**: dual-mode-filter

---

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

å¢å¼º JOIN Query Panel çš„ç­›é€‰å™¨åŠŸèƒ½ï¼Œæ”¯æŒå°†ç­›é€‰æ¡ä»¶åº”ç”¨åˆ° **ON å­å¥** è€Œä¸æ˜¯ **WHERE å­å¥**ã€‚

### èƒŒæ™¯é—®é¢˜

å½“å‰ JOIN æŸ¥è¯¢çš„ç­›é€‰å™¨å®ç°å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **å…¨è¡¨æ‰«æé—®é¢˜**ï¼šå¤–éƒ¨æ•°æ®åº“ï¼ˆMySQL/PostgreSQLï¼‰çš„ç­›é€‰æ¡ä»¶æ”¾åœ¨ WHERE å­å¥ä¸­ï¼ŒDuckDB éœ€è¦å…ˆæ‹‰å–å…¨è¡¨æ•°æ®å†è¿‡æ»¤
2. **LEFT JOIN è¯­ä¹‰é—®é¢˜**ï¼šWHERE æ¡ä»¶ä¼šè¿‡æ»¤æ‰å³è¡¨ä¸º NULL çš„è¡Œï¼Œç ´å LEFT JOIN çš„è¯­ä¹‰

**é—®é¢˜ç¤ºä¾‹**ï¼š
```sql
-- å½“å‰ç”Ÿæˆçš„ SQLï¼ˆæœ‰é—®é¢˜ï¼‰
SELECT * FROM å·¦è¡¨
LEFT JOIN å³è¡¨ ON å·¦è¡¨.id = å³è¡¨.id
WHERE å³è¡¨.create_time >= '2025-01-01'  -- è¿™ä¼šè¿‡æ»¤æ‰å³è¡¨æ— åŒ¹é…çš„è¡Œï¼

-- æœŸæœ›çš„ SQLï¼ˆæ­£ç¡®ï¼‰
SELECT * FROM å·¦è¡¨
LEFT JOIN å³è¡¨ ON å·¦è¡¨.id = å³è¡¨.id 
                AND å³è¡¨.create_time >= '2025-01-01'  -- æ¡ä»¶åœ¨ ON å­å¥ä¸­
```

---

## ğŸ¯ ç”¨æˆ·æ•…äº‹

### æ•…äº‹ 1: è”é‚¦æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–
> ä½œä¸ºæ•°æ®åˆ†æå¸ˆï¼Œæˆ‘åœ¨è¿›è¡Œè·¨åº“ JOIN æŸ¥è¯¢æ—¶ï¼Œéœ€è¦å¯¹å¤–éƒ¨è¡¨æ·»åŠ è¿‡æ»¤æ¡ä»¶ä»¥å‡å°‘æ•°æ®ä¼ è¾“é‡ã€‚

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ·»åŠ ç­›é€‰æ¡ä»¶æ—¶ï¼Œå¯ä»¥é€‰æ‹©"åº”ç”¨ä½ç½®"ï¼ˆON å­å¥ / WHERE å­å¥ï¼‰
- [ ] é»˜è®¤æ ¹æ®è¡¨çš„ä½ç½®æ™ºèƒ½é€‰æ‹©ï¼ˆå³è¡¨é»˜è®¤ ONï¼Œå·¦è¡¨é»˜è®¤ WHEREï¼‰
- [ ] ç”Ÿæˆçš„ SQL æ­£ç¡®å°†æ¡ä»¶æ”¾ç½®åœ¨å¯¹åº”ä½ç½®

### æ•…äº‹ 2: ä¿æŒ LEFT JOIN è¯­ä¹‰
> ä½œä¸ºç”¨æˆ·ï¼Œæˆ‘ä½¿ç”¨ LEFT JOIN æ—¶ï¼Œå¸Œæœ›å³è¡¨çš„ç­›é€‰æ¡ä»¶ä¸ä¼šè¿‡æ»¤æ‰å·¦è¡¨çš„è¡Œã€‚

**éªŒæ”¶æ ‡å‡†**:
- [ ] LEFT JOIN çš„å³è¡¨ç­›é€‰æ¡ä»¶é»˜è®¤æ”¾åœ¨ ON å­å¥
- [ ] ç”¨æˆ·å¯ä»¥æ‰‹åŠ¨åˆ‡æ¢åˆ° WHERE å­å¥ï¼ˆå¦‚æœç¡®å®éœ€è¦è¿‡æ»¤ï¼‰
- [ ] UI æä¾›æ¸…æ™°çš„æç¤ºè¯´æ˜ä¸¤ç§ä½ç½®çš„åŒºåˆ«

### æ•…äº‹ 3: å¯è§†åŒ–åŒºåˆ†
> ä½œä¸ºç”¨æˆ·ï¼Œæˆ‘éœ€è¦ç›´è§‚åœ°çœ‹åˆ°å“ªäº›æ¡ä»¶åœ¨ ON å­å¥ï¼Œå“ªäº›åœ¨ WHERE å­å¥ã€‚

**éªŒæ”¶æ ‡å‡†**:
- [ ] FilterBar åŒºåˆ†æ˜¾ç¤º ON æ¡ä»¶å’Œ WHERE æ¡ä»¶
- [ ] ä½¿ç”¨ä¸åŒçš„é¢œè‰²æˆ–å›¾æ ‡æ ‡è¯†
- [ ] SQL é¢„è§ˆä¸­é«˜äº®æ˜¾ç¤ºæ¡ä»¶ä½ç½®

---

## ğŸ”’ æŠ€æœ¯çº¦æŸ

### JOIN ç±»å‹ä¸æ¡ä»¶ä½ç½®çš„å…³ç³»

| JOIN ç±»å‹ | å·¦è¡¨æ¡ä»¶ | å³è¡¨æ¡ä»¶ | è¯´æ˜ |
|-----------|----------|----------|------|
| INNER JOIN | WHERE æˆ– ON | WHERE æˆ– ON | è¯­ä¹‰ç›¸åŒ |
| LEFT JOIN | WHERE | ON (æ¨è) | å³è¡¨æ¡ä»¶åœ¨ ON æ‰ä¸ä¼šè¿‡æ»¤å·¦è¡¨ |
| RIGHT JOIN | ON (æ¨è) | WHERE | å·¦è¡¨æ¡ä»¶åœ¨ ON æ‰ä¸ä¼šè¿‡æ»¤å³è¡¨ |
| FULL JOIN | ON (æ¨è) | ON (æ¨è) | ä¸¤è¾¹éƒ½å»ºè®®åœ¨ ON |
| CROSS JOIN | WHERE | WHERE | å®é™…ä¸Šç­‰åŒäº INNER JOIN |

### å¤šè¡¨ JOIN çš„æ¡ä»¶å½’å±

å¯¹äº A JOIN B JOIN C çš„åœºæ™¯ï¼š
- A è¡¨æ¡ä»¶ â†’ æ”¾åœ¨ç¬¬ä¸€ä¸ª ON æˆ– WHERE
- B è¡¨æ¡ä»¶ â†’ æ”¾åœ¨ A-B çš„ ON å­å¥
- C è¡¨æ¡ä»¶ â†’ æ”¾åœ¨ B-C çš„ ON å­å¥

### æ€§èƒ½è€ƒé‡

| åœºæ™¯ | ON å­å¥ | WHERE å­å¥ |
|------|---------|------------|
| æœ¬åœ° DuckDB è¡¨ | æ— å·®å¼‚ | æ— å·®å¼‚ |
| å¤–éƒ¨ MySQL/PG è¡¨ | âœ… æ¡ä»¶å¯ä¸‹æ¨ | âŒ éœ€è¦å…¨è¡¨æ‹‰å– |
| å¤§è¡¨ JOIN | âœ… å‡å°‘æ•°æ®ä¼ è¾“ | âŒ ä¼ è¾“å…¨é‡æ•°æ® |

---

## ğŸ¨ UI/UX è§„èŒƒ

### æ–¹æ¡ˆ A: FilterBar åŒºåŸŸåˆ†ç¦»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”— ON æ¡ä»¶                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚ â”‚ å³è¡¨.create_time â”‚  â”‚ å³è¡¨.status = 1  â”‚  + æ·»åŠ  ON æ¡ä»¶   â”‚
â”‚ â”‚ >= '2025-01-01' â”‚  â”‚                  â”‚                    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš¡ WHERE æ¡ä»¶                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚ â”‚ å·¦è¡¨.åºåˆ—å· = '2' â”‚  + æ·»åŠ  WHERE æ¡ä»¶                       â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ–¹æ¡ˆ B: æ¡ä»¶ç±»å‹æ ‡è®°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WHERE æ¡ä»¶                                    â˜° å¯è§†åŒ– | SQL â”‚
â”‚                                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚ â”‚ğŸ”— å³è¡¨.create_time     â”‚  â”‚âš¡ å·¦è¡¨.åºåˆ—å· = '2'    â”‚        â”‚
â”‚ â”‚   >= '2025-01-01'     â”‚  â”‚                       â”‚        â”‚
â”‚ â”‚   [ON å­å¥] â–¼         â”‚  â”‚   [WHERE å­å¥] â–¼      â”‚        â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                              â”‚
â”‚ + æ·»åŠ æ¡ä»¶                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨èæ–¹æ¡ˆ: B (æ¡ä»¶ç±»å‹æ ‡è®°)

**ç†ç”±**:
1. æ›´ç®€æ´ï¼Œä¸éœ€è¦ä¸¤ä¸ªåŒºåŸŸ
2. æ¯ä¸ªæ¡ä»¶å¯ä»¥ç‹¬ç«‹åˆ‡æ¢ç±»å‹
3. ä¸ç°æœ‰ UI æ”¹åŠ¨æœ€å°

### æ¡ä»¶ç±»å‹é€‰æ‹©å™¨

åœ¨ FilterPopover ä¸­æ·»åŠ "åº”ç”¨ä½ç½®"é€‰é¡¹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ·»åŠ ç­›é€‰æ¡ä»¶                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ è¡¨        â”‚ åˆ—                          â”‚
â”‚ [sv_cdkey â–¼] [create_time (datetime) â–¼] â”‚
â”‚                                         â”‚
â”‚ æ“ä½œç¬¦                                   â”‚
â”‚ [â‰¥ >=                            â–¼]     â”‚
â”‚                                         â”‚
â”‚ å€¼                                       â”‚
â”‚ [2025-12-20 09:30:30              ]     â”‚
â”‚                                         â”‚
â”‚ åº”ç”¨ä½ç½®                          â“˜     â”‚
â”‚ â—‹ ON å­å¥ (JOIN æ¡ä»¶)                   â”‚
â”‚ â— WHERE å­å¥ (è¿‡æ»¤æ¡ä»¶)                 â”‚
â”‚                                         â”‚
â”‚          [å–æ¶ˆ]  [ç¡®å®š]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ™ºèƒ½é»˜è®¤é€‰æ‹©

| æ¡ä»¶æ‰€å±è¡¨ | JOIN ç±»å‹ | é»˜è®¤ä½ç½® |
|-----------|-----------|----------|
| å·¦è¡¨ | ä»»æ„ | WHERE |
| å³è¡¨ | INNER | WHERE |
| å³è¡¨ | LEFT | **ON** |
| å³è¡¨ | RIGHT | WHERE |
| å³è¡¨ | FULL | **ON** |

---

## ğŸ“Š æ•°æ®æ¨¡å‹å˜æ›´

### FilterCondition æ‰©å±•

```typescript
interface FilterCondition {
  id: string;
  type: 'condition';
  table: string;
  column: string;
  operator: FilterOperator;
  value: FilterValue;
  value2?: FilterValue;
  
  // æ–°å¢å­—æ®µï¼ˆå¯é€‰ï¼Œå…¼å®¹æ—§æ•°æ®ï¼‰
  placement?: 'on' | 'where';  // æ¡ä»¶åº”ç”¨ä½ç½®ï¼Œé»˜è®¤ 'where'
}
```

> [!NOTE]
> **å‘åå…¼å®¹**: æ—§æ•°æ®æ—  `placement` å­—æ®µæ—¶ï¼Œé»˜è®¤è§†ä¸º `'where'`ï¼Œä¸ä¹‹å‰è¡Œä¸ºä¸€è‡´ã€‚

### FilterBar Props æ‰©å±•

```typescript
interface FilterBarProps {
  filterTree: FilterGroup;
  onFilterChange: (tree: FilterGroup) => void;
  availableColumns: ColumnInfo[];
  disabled?: boolean;
  enableDragDrop?: boolean;
  
  // æ–°å¢ Props
  joinConfigs?: JoinConfig[];  // JOIN é…ç½®ï¼Œç”¨äºæ™ºèƒ½é»˜è®¤
  activeTables?: SelectedTable[];  // æ´»åŠ¨è¡¨ï¼Œç”¨äºåˆ¤æ–­å·¦å³è¡¨
}
```

---

## ğŸ”„ SQL ç”Ÿæˆé€»è¾‘å˜æ›´

### å½“å‰å®ç°

```typescript
// generateSQL å‡½æ•°ä¸­
const whereClause = generateFilterSQL(filterTree);
if (whereClause && whereClause.trim()) {
  parts.push(`WHERE ${whereClause}`);
}
```

### æ–°å®ç°

```typescript
// åˆ†ç¦» ON æ¡ä»¶å’Œ WHERE æ¡ä»¶
const { onConditions } = separateConditionsByPlacement(filterTree);

// ç”Ÿæˆ JOIN å­å¥æ—¶ï¼Œå°†å¯¹åº”è¡¨çš„ ON æ¡ä»¶é™„åŠ åˆ° ON å­å¥
for (let i = 1; i < activeTables.length; i++) {
  const rightTableName = getTableName(activeTables[i]);
  const tableOnConditions = getConditionsForTable(onConditions, rightTableName);
  
  let onClause = `${leftRef} ${operator} ${rightRef}`;
  if (tableOnConditions.length > 0) {
    onClause += ` AND ${generateConditionsSQL(tableOnConditions)}`;
  }
  
  parts.push(`${joinType} ${rightTableRef} ON ${onClause}`);
}

// âœ… WHERE æ¡ä»¶ï¼šä½¿ç”¨é€’å½’å…‹éš†ç§»é™¤æ‰€æœ‰ placement='on' çš„æ¡ä»¶
const whereOnlyTree = cloneTreeWithoutOnConditions(filterTree);
const whereClause = generateFilterSQL(whereOnlyTree);
if (whereClause && whereClause.trim()) {
  parts.push(`WHERE ${whereClause}`);
}
```

> [!IMPORTANT]
> `cloneTreeWithoutOnConditions` é€’å½’å…‹éš† filterTreeï¼Œé€å±‚åˆ é™¤ `placement='on'` çš„æ¡ä»¶ï¼Œç¡®ä¿åµŒå¥— group å†…çš„ ON æ¡ä»¶ä¹Ÿè¢«ç§»é™¤ã€‚
```

---

## âœ… éªŒæ”¶æ£€æŸ¥æ¸…å•

### åŠŸèƒ½éªŒæ”¶
- [ ] FilterPopover æ˜¾ç¤º"åº”ç”¨ä½ç½®"é€‰é¡¹
- [ ] æ ¹æ®è¡¨ä½ç½®å’Œ JOIN ç±»å‹æ™ºèƒ½é€‰æ‹©é»˜è®¤å€¼
- [ ] FilterChip æ˜¾ç¤ºæ¡ä»¶ç±»å‹æ ‡è®°ï¼ˆON/WHEREï¼‰
- [ ] SQL ç”Ÿæˆæ­£ç¡®å°†æ¡ä»¶æ”¾ç½®åœ¨å¯¹åº”ä½ç½®
- [ ] å¤–éƒ¨è¡¨ç­›é€‰æ¡ä»¶åœ¨ ON å­å¥æ—¶ï¼Œæ•°æ®æ­£ç¡®è¿‡æ»¤ä¸”ä¿æŒ JOIN è¯­ä¹‰

### å…¼å®¹æ€§éªŒæ”¶
- [ ] ç°æœ‰ filterTree æ•°æ®å‘åå…¼å®¹ï¼ˆæ—  placement å­—æ®µé»˜è®¤ä¸º 'where'ï¼‰
- [ ] ä¸ç°æœ‰ FilterBar ç»„ä»¶å…¼å®¹
- [ ] ä¸ SQL æ¨¡å¼åŒå‘åŒæ­¥

### ç”¨æˆ·ä½“éªŒéªŒæ”¶
- [ ] æç¤ºä¿¡æ¯æ¸…æ™°è¯´æ˜ ON å’Œ WHERE çš„åŒºåˆ«
- [ ] é»˜è®¤é€‰æ‹©ç¬¦åˆå¤§å¤šæ•°ä½¿ç”¨åœºæ™¯
- [ ] å¯ä»¥æ–¹ä¾¿åœ°åˆ‡æ¢æ¡ä»¶ç±»å‹

---

## ğŸŒ å›½é™…åŒ– Key åˆ—è¡¨

```typescript
// æ–°å¢ i18n keys
{
  "filter.placement.label": "åº”ç”¨ä½ç½® / Condition Placement",
  "filter.placement.on": "ON å­å¥ (JOIN æ¡ä»¶) / ON Clause (Join Condition)",
  "filter.placement.where": "WHERE å­å¥ (è¿‡æ»¤æ¡ä»¶) / WHERE Clause (Filter Condition)",
  "filter.placement.onHint": "æ¡ä»¶åœ¨ JOIN æ—¶ç”Ÿæ•ˆï¼Œä¸å½±å“å·¦è¡¨è¡Œæ•° / Applied during JOIN, doesn't affect left table row count",
  "filter.placement.whereHint": "æ¡ä»¶åœ¨ JOIN åç”Ÿæ•ˆï¼Œä¼šè¿‡æ»¤ç»“æœè¡Œ / Applied after JOIN, filters result rows",
  "filter.chip.onBadge": "ON",
  "filter.chip.whereBadge": "WHERE"
}
```

---

## ğŸ“‹ å®ç°ä¼˜å…ˆçº§

### P0 - æ ¸å¿ƒåŠŸèƒ½
1. æ‰©å±• FilterCondition æ•°æ®æ¨¡å‹
2. FilterPopover æ·»åŠ "åº”ç”¨ä½ç½®"é€‰é¡¹
3. SQL ç”Ÿæˆé€»è¾‘æ”¯æŒ ON æ¡ä»¶

### P1 - ç”¨æˆ·ä½“éªŒ
4. FilterChip æ˜¾ç¤ºæ¡ä»¶ç±»å‹æ ‡è®°
5. æ™ºèƒ½é»˜è®¤é€‰æ‹©é€»è¾‘

### P2 - å¢å¼ºåŠŸèƒ½
6. SQL æ¨¡å¼è§£ææ”¯æŒ ON æ¡ä»¶
7. æ‰¹é‡åˆ‡æ¢æ¡ä»¶ç±»å‹
