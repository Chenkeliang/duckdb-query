# 后端数据源管理接口统一化 - 需求文档

## 简介

本文档定义了 DuckQuery 后端数据源管理接口的统一化需求。当前系统存在接口重复、管理分散、功能不完善等问题，需要通过统一化改造提升代码质量、降低维护成本、改善用户体验。

## 术语表

- **DataSource（数据源）**: 系统中所有可查询的数据来源，包括数据库连接、文件、URL 等
- **DatabaseConfig（数据库配置）**: 数据库连接的配置信息，包括主机、端口、凭证等
- **ConnectionPool（连接池）**: 管理数据库连接的池化机制
- **BatchOperation（批量操作）**: 对多个资源同时执行的操作
- **ConfigTemplate（配置模板）**: 预定义的配置模板，支持变量替换

## 需求

### 需求 1：统一数据库配置接口

**用户故事**: 作为后端开发者，我希望使用统一的接口管理所有类型的数据库配置，这样可以减少代码重复并简化维护工作。

#### 验收标准

1. WHEN 系统需要获取数据库配置列表 THEN 系统应提供统一的 `/api/database-configs` 端点支持所有数据库类型
2. WHEN 系统需要按类型过滤配置 THEN 系统应支持通过查询参数 `type` 过滤特定数据库类型
3. WHEN 系统创建新的数据库配置 THEN 系统应通过统一的请求模型接收配置信息并根据 `type` 字段路由到对应处理器
4. WHEN 系统更新或删除配置 THEN 系统应使用统一的端点 `/api/database-configs/{config_id}` 处理所有数据库类型
5. WHEN 系统需要支持新的数据库类型 THEN 系统应只需扩展配置处理器而无需添加新的路由端点

### 需求 2：统一数据源管理视图

**用户故事**: 作为前端开发者，我希望通过统一的接口获取所有类型的数据源，这样可以在 UI 中提供一致的数据源管理体验。

#### 验收标准

1. WHEN 前端请求数据源列表 THEN 系统应返回包含所有类型数据源的统一格式响应
2. WHEN 系统返回数据源信息 THEN 响应应包含 `id`、`name`、`type`、`subtype`、`status`、`metadata` 等标准字段
3. WHEN 前端需要按类型查看数据源 THEN 系统应支持 `/api/datasources/databases`、`/api/datasources/files` 等分类端点
4. WHEN 数据源状态发生变化 THEN 系统应在响应中反映最新的连接状态和元数据
5. WHEN 前端删除数据源 THEN 系统应通过统一的 `/api/datasources/{id}` 端点处理所有类型的删除操作

### 需求 3：改进连接测试机制

**用户故事**: 作为用户，我希望在保存配置前能够测试连接，并获得详细的连接信息和诊断结果。

#### 验收标准

1. WHEN 用户测试未保存的配置 THEN 系统应提供 `/api/database-configs/actions/test` 端点接收临时配置并返回测试结果
2. WHEN 用户测试已保存的配置 THEN 系统应提供 `/api/database-configs/{config_id}/actions/test` 端点
3. WHEN 连接测试成功 THEN 系统应返回连接时间、数据库版本、表数量等详细信息
4. WHEN 连接测试失败 THEN 系统应返回清晰的错误信息和可能的解决建议
5. WHEN 连接存在潜在问题 THEN 系统应在响应中包含警告信息（如未启用 SSL）

### 需求 4：批量操作支持

**用户故事**: 作为用户，我希望能够批量管理多个数据库配置，这样可以提高操作效率。

#### 验收标准

1. WHEN 用户需要删除多个配置 THEN 系统应提供 `/api/database-configs/batch` 端点接收配置 ID 列表并执行批量删除
2. WHEN 用户需要测试多个连接 THEN 系统应提供 `/api/database-configs/batch/test` 端点并返回每个配置的测试结果
3. WHEN 批量操作部分失败 THEN 系统应返回详细的成功和失败列表
4. WHEN 用户导出配置 THEN 系统应支持通过 `/api/database-configs/export` 端点导出指定配置为 JSON 格式
5. WHEN 用户导入配置 THEN 系统应支持通过 `/api/database-configs/import` 端点批量导入配置

### 需求 5：配置模板系统

**用户故事**: 作为用户，我希望使用预定义的配置模板快速创建常用的数据库连接，这样可以减少重复输入。

#### 验收标准

1. WHEN 用户请求配置模板列表 THEN 系统应返回所有可用的预定义模板
2. WHEN 用户查看模板详情 THEN 系统应返回模板的配置结构和需要填写的变量列表
3. WHEN 用户从模板创建配置 THEN 系统应接收变量值并生成完整的配置
4. WHEN 用户复制现有配置 THEN 系统应提供 `/api/database-configs/{config_id}/clone` 端点创建配置副本
5. WHEN 模板包含必填变量 THEN 系统应验证所有必填变量已提供值

### 需求 6：向后兼容性

**用户故事**: 作为系统维护者，我希望在引入新接口的同时保持旧接口可用，这样可以平滑过渡而不影响现有功能。

#### 验收标准

1. WHEN 旧接口被调用 THEN 系统应继续正常响应并在响应头中添加 `X-Deprecated: true` 标记
2. WHEN 旧接口被调用 THEN 系统应在日志中记录废弃警告信息
3. WHEN 旧接口内部实现 THEN 系统应将请求重定向到新的统一接口处理
4. WHEN 系统文档更新 THEN 文档应明确标注旧接口的废弃状态和迁移指南
5. WHEN 前端完成迁移 THEN 系统应提供配置选项禁用旧接口

### 需求 7：错误处理和验证

**用户故事**: 作为用户，我希望在配置错误时获得清晰的错误提示，这样可以快速定位和解决问题。

#### 验收标准

1. WHEN 用户提交无效的配置 THEN 系统应返回 400 状态码和详细的验证错误信息
2. WHEN 配置中缺少必填字段 THEN 系统应明确指出缺失的字段名称
3. WHEN 配置格式不正确 THEN 系统应提供格式示例和修正建议
4. WHEN 数据库连接失败 THEN 系统应区分网络错误、认证错误、权限错误等不同类型
5. WHEN 系统内部错误 THEN 系统应返回 500 状态码并记录详细的错误堆栈用于调试

### 需求 8：性能和安全

**用户故事**: 作为系统管理员，我希望数据源管理接口具有良好的性能和安全性，这样可以保护敏感信息并提供流畅的用户体验。

#### 验收标准

1. WHEN 系统返回配置信息 THEN 系统应自动过滤敏感字段（如密码）
2. WHEN 用户请求包含密码的配置 THEN 系统应仅在明确请求时返回加密或脱敏的密码
3. WHEN 系统测试连接 THEN 测试操作应设置合理的超时时间避免长时间阻塞
4. WHEN 系统执行批量操作 THEN 操作应使用异步处理避免阻塞主线程
5. WHEN 系统缓存配置信息 THEN 缓存应在配置更新或删除时自动失效
